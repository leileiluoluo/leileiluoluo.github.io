<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>Spring Data Neo4j 指定 spring.data.neo4j.database 时报错该如何解决？ - 磊磊落落</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=keywords content="Spring Boot,Spring Data,Neo4j"><meta name=description content="本人在对 Spring Data Neo4j 的实际使用中，发现一个问题，即：配置自定义 TransactionManager 后，指定 spring.data.neo4j.database 会报错。本文特对该问题进行记录、分析和解决，以给面临相同问题的朋友作参考。"><meta name=author content="磊磊落落"><meta name=generator content="Hugo 0.123.7"><link rel=stylesheet href=https://leileiluoluo.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://leileiluoluo.github.io/css/themify-icons.css><link rel=stylesheet href=https://leileiluoluo.github.io/css/larry-custom-v1.6.css><link rel=stylesheet href=https://leileiluoluo.github.io/scss/style.min.css media=screen><link rel="shortcut icon" href=https://leileiluoluo.github.io/images/favicon.png type=image/x-icon><link rel=icon href=https://leileiluoluo.github.io/images/favicon.png type=image/x-icon><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?526723b767317055572c85bdb445353c",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://leileiluoluo.github.io/>磊磊落落</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/></a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/>计算机</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E9%9A%8F%E7%AC%94/>随笔</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%AF%BB%E4%B9%A6/>读书</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%A7%82%E5%BD%B1/>观影</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E7%BB%83%E5%AD%97/>练字</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/about>关于</a></li></ul><div class=search><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=https://leileiluoluo.github.io//search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder=键入关键字后回车...></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h1>Spring Data Neo4j 指定 spring.data.neo4j.database 时报错该如何解决？</h1><div class="mb-3 post-meta">2025年05月05日
<a href=/categories/%e8%ae%a1%e7%ae%97%e6%9c%ba>计算机</a></div><div class="content mb-5"><p>本人在对 Spring Data Neo4j 的实际使用中，发现一个问题，即：配置自定义 <code>TransactionManager</code> 后，指定 <code>spring.data.neo4j.database</code> 会报错。本文特对该问题进行记录、分析和解决，以给面临相同问题的朋友作参考。</p><p>描述问题前，列出本文使用的 Java、Spring Data Neo4j 及其它依赖的版本：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Java: Liberica JDK 17.0.7
</span></span><span style=display:flex><span>Spring Boot: 3.4.5
</span></span><span style=display:flex><span>Spring Data Neo4j: 7.4.5
</span></span><span style=display:flex><span>Maven: 3.9.2
</span></span></code></pre></div><h2 id=1-问题描述>1 问题描述</h2><p>为了描述该问题，本人特搭建一个简单的 Maven 工程，其目录结构如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>spring-data-neo4j-database-config-demo
</span></span><span style=display:flex><span>├─ src
</span></span><span style=display:flex><span>│  ├─ main
</span></span><span style=display:flex><span>│  │  ├─ java
</span></span><span style=display:flex><span>│  │  │  └─ com.example.demo
</span></span><span style=display:flex><span>│  │  │     ├─ config
</span></span><span style=display:flex><span>│  │  │     │  └─ Neo4jConfig.java
</span></span><span style=display:flex><span>│  │  │     ├─ repository
</span></span><span style=display:flex><span>│  │  │     │  └─ ActorRepository.java
</span></span><span style=display:flex><span>│  │  │     ├─ model
</span></span><span style=display:flex><span>│  │  │     │  └─ Actor.java
</span></span><span style=display:flex><span>│  │  │     └─ DemoApplication.java
</span></span><span style=display:flex><span>│  │  └─ resources
</span></span><span style=display:flex><span>│  │     └─ application.yaml
</span></span><span style=display:flex><span>│  └─ test
</span></span><span style=display:flex><span>│     └─ java
</span></span><span style=display:flex><span>│        └─ com.example.demo
</span></span><span style=display:flex><span>│           └─ repository
</span></span><span style=display:flex><span>│              └─ ActorRepositoryTest.java
</span></span><span style=display:flex><span>└─ pom.xml
</span></span></code></pre></div><p>可以看到，<code>DemoApplication.java</code> 为启动类；<code>Actor.java</code> 为 Model 类，对应 Neo4j 中的 Actor Node；<code>ActorRepository.java</code> 扩展了 <code>Neo4jRepository</code> 接口，默认拥有针对 Actor 的增删改查功能；<code>Neo4jConfig.java</code> 为自定义 Neo4j 配置类。此外，<code>ActorRepositoryTest.java</code> 为针对 <code>ActorRepository.java</code> 的单元测试类。</p><p>介绍完工程目录结构，下面看一下 <code>application.yaml</code> 的配置：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:navy>spring</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>neo4j</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>database</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>neo4j</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>uri</span>:<span style=color:#bbb> </span>bolt://localhost:7687<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>authentication</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>username</span>:<span style=color:#bbb> </span>neo4j<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>password</span>:<span style=color:#bbb> </span>neo4j<span style=color:#bbb>
</span></span></span></code></pre></div><p>可以看到，该配置除了指定了 Neo4j 的连接信息，还使用 <code>spring.data.neo4j.database</code> 指定了要连接的 Neo4j 数据库名。</p><p>介绍完配置文件，下面看一下 <code>Neo4jConfig.java</code> 的代码：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000;font-weight:700>package</span><span style=color:#bbb> </span><span style=color:#555>com.example.demo.config</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.neo4j.driver.Driver</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.context.annotation.Bean</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.context.annotation.Configuration</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.data.neo4j.core.transaction.Neo4jTransactionManager</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.data.neo4j.repository.config.EnableNeo4jRepositories</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.transaction.PlatformTransactionManager</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.transaction.annotation.EnableTransactionManagement</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#3c5d5d;font-weight:700>@Configuration</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#3c5d5d;font-weight:700>@EnableTransactionManagement</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#3c5d5d;font-weight:700>@EnableNeo4jRepositories</span>(basePackages<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#d14>&#34;com.example.demo.repository&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Neo4jConfig</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#3c5d5d;font-weight:700>@Bean</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span>PlatformTransactionManager<span style=color:#bbb> </span><span style=color:#900;font-weight:700>transactionManager</span>(Driver<span style=color:#bbb> </span>driver)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>return</span><span style=color:#bbb> </span>Neo4jTransactionManager.<span style=color:teal>with</span>(driver)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:teal>build</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>可以看到，我们在该类配置了 Neo4j 的 <code>TransactionManager</code> Bean。</p><p>一切准备好后，使用 <code>ActorRepositoryTest.java</code> 单元测试类测试 <code>ActorRepository</code> 的增删改查方法时会报如下错误：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[ERROR] com.example.demo.repository.ActorRepositoryTest.testSave -- Time elapsed: 1.526 s &lt;&lt;&lt; ERROR!
</span></span><span style=display:flex><span>java.lang.IllegalStateException: There is already an ongoing Spring transaction for the default user of the default database, but you requested the default user of &#39;test&#39;
</span></span><span style=display:flex><span>	at org.springframework.data.neo4j.core.transaction.Neo4jTransactionManager.retrieveTransaction(Neo4jTransactionManager.java:244)
</span></span><span style=display:flex><span>	at org.springframework.data.neo4j.core.DefaultNeo4jClient.getQueryRunner(DefaultNeo4jClient.java:89)
</span></span><span style=display:flex><span>	at org.springframework.data.neo4j.core.DefaultNeo4jClient$DefaultRecordFetchSpec.one(DefaultNeo4jClient.java:442)
</span></span><span style=display:flex><span>	at org.springframework.data.neo4j.core.Neo4jTemplate.saveImpl(Neo4jTemplate.java:456)
</span></span><span style=display:flex><span>	at org.springframework.data.neo4j.core.Neo4jTemplate.lambda$save$14(Neo4jTemplate.java:382)
</span></span><span style=display:flex><span>	at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:140)
</span></span><span style=display:flex><span>	at org.springframework.data.neo4j.core.Neo4jTemplate.save(Neo4jTemplate.java:382)
</span></span><span style=display:flex><span>	at org.springframework.data.neo4j.repository.support.SimpleNeo4jRepository.save(SimpleNeo4jRepository.java:120)
</span></span><span style=display:flex><span>	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
</span></span><span style=display:flex><span>	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
</span></span><span style=display:flex><span>	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
</span></span><span style=display:flex><span>	at java.base/java.lang.reflect.Method.invoke(Method.java:568)
</span></span><span style=display:flex><span>	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:359)
</span></span><span style=display:flex><span>	at org.springframework.data.repository.core.support.RepositoryMethodInvoker$RepositoryFragmentMethodInvoker.lambda$new$0(RepositoryMethodInvoker.java:277)
</span></span><span style=display:flex><span>	at org.springframework.data.repository.core.support.RepositoryMethodInvoker.doInvoke(RepositoryMethodInvoker.java:170)
</span></span><span style=display:flex><span>	at org.springframework.data.repository.core.support.RepositoryMethodInvoker.invoke(RepositoryMethodInvoker.java:158)
</span></span><span style=display:flex><span>	at org.springframework.data.repository.core.support.RepositoryComposition$RepositoryFragments.invoke(RepositoryComposition.java:515)
</span></span><span style=display:flex><span>	at org.springframework.data.repository.core.support.RepositoryComposition.invoke(RepositoryComposition.java:284)
</span></span><span style=display:flex><span>	at org.springframework.data.repository.core.support.RepositoryFactorySupport$ImplementationMethodExecutionInterceptor.invoke(RepositoryFactorySupport.java:731)
</span></span><span style=display:flex><span>	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
</span></span><span style=display:flex><span>	at org.springframework.data.repository.core.support.QueryExecutorMethodInterceptor.doInvoke(QueryExecutorMethodInterceptor.java:174)
</span></span><span style=display:flex><span>	at org.springframework.data.repository.core.support.QueryExecutorMethodInterceptor.invoke(QueryExecutorMethodInterceptor.java:149)
</span></span><span style=display:flex><span>	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
</span></span><span style=display:flex><span>	at org.springframework.data.projection.DefaultMethodInvokingMethodInterceptor.invoke(DefaultMethodInvokingMethodInterceptor.java:69)
</span></span><span style=display:flex><span>	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
</span></span><span style=display:flex><span>	at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:380)
</span></span><span style=display:flex><span>	at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)
</span></span><span style=display:flex><span>	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
</span></span><span style=display:flex><span>	at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:138)
</span></span><span style=display:flex><span>	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
</span></span><span style=display:flex><span>	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)
</span></span><span style=display:flex><span>	at jdk.proxy2/jdk.proxy2.$Proxy71.save(Unknown Source)
</span></span><span style=display:flex><span>	at com.example.demo.repository.ActorRepositoryTest.testSave(ActorRepositoryTest.java:21)
</span></span></code></pre></div><p>可以看到，抛错的位置在 Spring Data Neo4j <code>Neo4jTransactionManager.java</code> 类的 244 行，报错关键信息是「There is already an ongoing Spring transaction for the default user of the default database, but you requested the default user of &rsquo;test&rsquo;」。</p><h2 id=2-原因分析>2 原因分析</h2><p>翻看 Spring Data Neo4j <code>Neo4jTransactionManager.java</code> 类的源码并结合报错信息，得到的线索是「<code>getDatabaseSelection()</code> 的值与 <code>getUserSelection()</code> 的值不匹配」。</p><p><img loading=lazy src=https://leileiluoluo.github.io/static/images/uploads/2025/05/spring-data-neo4j-source-code.png alt="Neo4jTransactionManager 源码"></p><p>即虽然我们已在 <code>application.yaml</code> 配置文件指定了要连接的数据库，但 <code>TransactionManager</code> 获取到值却仍然是默认数据库。问题可能出在了自定义配置类 <code>Neo4jConfig.java</code> 上。</p><h2 id=3-解决办法>3 解决办法</h2><p>有了可能的原因，下面尝试查阅文档，在 <code>Neo4jConfig.java</code> 配置 <code>TransactionManager</code> 时同时指定要连接的数据库，这样问题可能就解决了。</p><p>修改后的 <code>Neo4jConfig.java</code> 代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000;font-weight:700>package</span><span style=color:#bbb> </span><span style=color:#555>com.example.demo.config</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.neo4j.driver.Driver</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.beans.factory.annotation.Value</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.context.annotation.Bean</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.context.annotation.Configuration</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.data.neo4j.core.DatabaseSelection</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.data.neo4j.core.DatabaseSelectionProvider</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.data.neo4j.core.Neo4jClient</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.data.neo4j.core.transaction.Neo4jTransactionManager</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.data.neo4j.repository.config.EnableNeo4jRepositories</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.transaction.PlatformTransactionManager</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>import</span><span style=color:#bbb> </span><span style=color:#555>org.springframework.transaction.annotation.EnableTransactionManagement</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#3c5d5d;font-weight:700>@Configuration</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#3c5d5d;font-weight:700>@EnableTransactionManagement</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#3c5d5d;font-weight:700>@EnableNeo4jRepositories</span>(basePackages<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#d14>&#34;com.example.demo.repository&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Neo4jConfig</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#3c5d5d;font-weight:700>@Value</span>(<span style=color:#d14>&#34;${spring.data.neo4j.database}&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>private</span><span style=color:#bbb> </span>String<span style=color:#bbb> </span>database;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#3c5d5d;font-weight:700>@Bean</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span>DatabaseSelectionProvider<span style=color:#bbb> </span><span style=color:#900;font-weight:700>databaseSelectionProvider</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>return</span><span style=color:#bbb> </span>()<span style=color:#bbb> </span><span style=color:#000;font-weight:700>-&gt;</span><span style=color:#bbb> </span>DatabaseSelection.<span style=color:teal>byName</span>(database);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#3c5d5d;font-weight:700>@Bean</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span>Neo4jClient<span style=color:#bbb> </span><span style=color:#900;font-weight:700>neo4jClient</span>(Driver<span style=color:#bbb> </span>driver,<span style=color:#bbb> </span>DatabaseSelectionProvider<span style=color:#bbb> </span>provider)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>return</span><span style=color:#bbb> </span>Neo4jClient.<span style=color:teal>with</span>(driver)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:teal>withDatabaseSelectionProvider</span>(provider)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:teal>build</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#3c5d5d;font-weight:700>@Bean</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span>PlatformTransactionManager<span style=color:#bbb> </span><span style=color:#900;font-weight:700>transactionManager</span>(Driver<span style=color:#bbb> </span>driver,<span style=color:#bbb> </span>DatabaseSelectionProvider<span style=color:#bbb> </span>provider)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>return</span><span style=color:#bbb> </span>Neo4jTransactionManager.<span style=color:teal>with</span>(driver)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:teal>withDatabaseSelectionProvider</span>(provider)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:teal>build</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>可以看到，我们在 <code>Neo4jConfig.java</code> 中读取了 <code>spring.data.neo4j.database</code> 的值，并基于此自定义了 <code>DatabaseSelectionProvider</code> Bean。然后在配置 <code>Neo4jClient</code> Bean 和 <code>TransactionManager</code> Bean 时使用了该自定义 Provider。</p><p>修改后，再次使用 <code>ActorRepositoryTest.java</code> 单元测试类测试 <code>ActorRepository</code> 的增删改查方法，发现不报错了。</p><h2 id=4-小结>4 小结</h2><p>本文针对 Spring Data Neo4j 配置自定义 <code>TransactionManager</code> 后，指定 <code>spring.data.neo4j.database</code> 会报错的问题进行了描述、分析和解决。</p><p>本文完整示例工程代码已提交至 <a href=https://github.com/leileiluoluo/java-exercises/tree/main/spring-data-neo4j-database-config-demo>GitHub</a>，欢迎关注或 Fork。</p><blockquote><p>参考资料</p><p>[1] Spring: Spring Data JPA FAQ - Configure the database name - <a href=https://docs.spring.io/spring-data/neo4j/reference/faq.html#faq.multidatabase.statically>https://docs.spring.io/spring-data/neo4j/reference/faq.html#faq.multidatabase.statically</a></p><p>[2] GitHub: Spring Data Neo4j - Neo4jTransactionManager.java - <a href=https://github.com/spring-projects/spring-data-neo4j/blob/7.4.x/src/main/java/org/springframework/data/neo4j/core/transaction/Neo4jTransactionManager.java>https://github.com/spring-projects/spring-data-neo4j/blob/7.4.x/src/main/java/org/springframework/data/neo4j/core/transaction/Neo4jTransactionManager.java</a></p></blockquote></div><div class=content-footer><div class=weixinhao><img src=/static/images/self/weixinhao-white.jpg></div><div class=post-tags><a href=/tags/spring/>#Spring</a>
<a href=/tags/java/>#Java</a>
<a href=/tags/neo4j/>#Neo4j</a></div><div class=license><i class=ti-info-alt></i><div class=info>版权声明：该博客文章由作者通过「<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>知识共享署名 4.0 许可证</a>」进行授权，转载须注明文章原始链接。</div></div></div></div><div class="col-lg-8 mx-auto block shadow"><h3>相关文章</h3><ul><li><a href=/posts/how-does-spring-data-operate-both-mysql-and-neo4j.html>如何使用 Spring Data 同时访问 MySQL 和 Neo4j 数据库？</a></li><li><a href=/posts/spring-data-neo4j.html>如何使用 Spring Data Neo4j 访问 Neo4j 数据库？</a></li><li><a href=/posts/how-to-use-p6spy-in-spring-boot.html>如何在 Spring Boot 中使用 P6Spy 拦截 SQL 语句？</a></li><li><a href=/posts/how-to-use-spring-event.html>如何使用 Spring Event 实现内部模块间的轻松解耦？</a></li><li><a href=/posts/how-to-capture-entity-operations-in-spring-data-jpa.html>使用 Spring Data JPA 时如何捕捉实体的增删改操作？</a></li></ul></div><div class="col-lg-8 mx-auto block shadow"><div><h3>评论</h3><div id=comment-loading style=text-align:center;font-size:14px><img style=width:52px src=/static/images/site/mona-loading-default.gif>
<span>正在加载评论......</span></div><script>function handleMessage(e){if(e.origin!=="https://giscus.app")return;if(typeof e.data!="object"||!e.data.giscus)return;const t=document.getElementById("comment-loading");t.style.display="none"}window.addEventListener("message",handleMessage)</script><script src=https://giscus.app/client.js data-repo=leileiluoluo/leileiluoluo.github.io data-repo-id=R_kgDOJkLT8w data-category=General data-category-id=DIC_kwDOJkLT884CdtEh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div></div></section><footer class="py-4 bg-lights border-top"><div class=container><div class="row justify-content-between text-center align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/sponsor>随喜打赏</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/about>关于本博</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/links>友情链接</a></li></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a title=文章归档 href=/archives/><i class=ti-archive></i></a></li><li class=list-inline-item><a title=文章标签 href=/tags/><i class=ti-tag></i></a></li><li class=list-inline-item><a title="我的 GitHub" href=https://github.com/leileiluoluo><i class=ti-github></i></a></li><li class=list-inline-item><a title="网站 RSS" href=/index.xml><i class=ti-rss></i></a></li></ul></div></div><div style=text-align:center;margin-bottom:22px><a href=https://www.boyouquan.com/planet-shuttle target=_blank><img width=90px height=28px src=https://boyouquan.com/assets/images/sites/logo/planet-shuttle.svg></a></div><div class="text-center mt-4"><span>Made with <a href=https://gohugo.io/>Hugo</a> | Theme by <a href=https://github.com/themefisher/northendlab-hugo>NorthendLab</a> | <a href=https://beian.miit.gov.cn>辽ICP备2022012085号-5</a> | Copyright © 2017-2026 | <a href=https://www.boyouquan.com/certificates/leileiluoluo.com title=正在博友圈履约中 target=_blank><img style=height:20px src="https://www.boyouquan.com/images/logo/performance.svg?domainName=leileiluoluo.com" alt=正在博友圈履约中></a></span></div></div></footer><script>var indexURL="https://leileiluoluo.github.io/index.json"</script><script src=https://leileiluoluo.github.io/js/jquery.min.js></script><script src=https://leileiluoluo.github.io/js/bootstrap.min.js></script><script src=https://leileiluoluo.github.io/js/fuse.min.js></script><script src=https://leileiluoluo.github.io/js/mark.js></script><script src=https://leileiluoluo.github.io/js/search.js></script><script src=https://leileiluoluo.github.io/js/script.min.js></script></body></html>