<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>PostgreSQL 外部数据包装器 postgres_fdw 使用详解 - 磊磊落落</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=keywords content="postgres_fdw,Foreign Data Wrappers"><meta name=description content="PostgreSQL Foreign Data Wrappers (PostgreSQL 外部数据包装器 postgres_fdw 使用详解)。"><meta name=author content="磊磊落落"><meta name=generator content="Hugo 0.123.7"><link rel=stylesheet href=https://leileiluoluo.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://leileiluoluo.github.io/css/themify-icons.css><link rel=stylesheet href=https://leileiluoluo.github.io/css/larry-custom-v1.6.css><link rel=stylesheet href=https://leileiluoluo.github.io/scss/style.min.css media=screen><link rel="shortcut icon" href=https://leileiluoluo.github.io/images/favicon.png type=image/x-icon><link rel=icon href=https://leileiluoluo.github.io/images/favicon.png type=image/x-icon><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?526723b767317055572c85bdb445353c",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://leileiluoluo.github.io/>磊磊落落</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/></a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/>计算机</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E9%9A%8F%E7%AC%94/>随笔</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%AF%BB%E4%B9%A6/>读书</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%A7%82%E5%BD%B1/>观影</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E7%BB%83%E5%AD%97/>练字</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/about>关于</a></li></ul><div class=search><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=https://leileiluoluo.github.io//search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder=键入关键字后回车...></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h1>PostgreSQL 外部数据包装器 postgres_fdw 使用详解</h1><div class="mb-3 post-meta">2022年03月12日
<a href=/categories/%e8%ae%a1%e7%ae%97%e6%9c%ba>计算机</a></div><div class="content mb-5"><p>PostgreSQL 外部数据包装器，即 PostgreSQL Foreign Data Wrappers（下面简称为 FDW），是现实数据库使用场景中一个非常实用的功能。PostgreSQL 的 FDW 类似于 Oracle 的 dblink，DB2 的 Federation，使用其可以将本地数据库与外部数据库建立连接，从而可以像操作本地数据一样来操作外部数据。</p><p><strong>FDW 有何用？</strong></p><ul><li><p>数据分片</p><p>使用 FDW 将数据分布式存储在多个数据库上从而实现数据分片（如 pg_shardman 插件，即是使用 postgres_fdw 和 pg_pathman 插件来实现数据分片的）。</p></li><li><p>数据同步</p><p>使用 FDW 建立本地数据库与外部数据库的连接，即可定时同步外部数据至本地。</p></li><li><p>数据迁移</p><p>使用 FDW 建立本地数据库与外部数据库的连接，即可进行数据迁移。</p></li><li><p>ETL（Extract-Transform-Load，抽取转换加载）</p><p>使用 FDW 将来自不同类型数据库的数据抽取到一个数据仓库中，便于统一化访问。</p></li></ul><p><strong>PostgreSQL FDW 发展概况</strong></p><p>2003 年，SQL/MED（SQL Management of External Data）被加入 SQL 标准，其为外部数据管理提供了规范。在 2011 年发行的 PostgreSQL 9.1 开始支持外部数据读，2013 发行的 PostgreSQL 9.3 开始支持外部数据写。</p><p>目前，PostgreSQL （本文写作时，使用的版本为 PostgreSQL 14）已提供多种扩展来支持对各种类型外部数据库或文件的操作（如 postgres_fdw 支持连接外部 PostgreSQL 数据库，oracle_fdw 支持连接外部 Oracle 数据库，mysql_fdw 支持连接外部 MySQL 数据库，jdbc_fdw 支持以 JDBC 协议连接外部常用关系型数据库，file_fdw 支持连接外部特定格式的文件等）。</p><p><img loading=lazy src=https://leileiluoluo.github.io/static/images/uploads/2022/03/fdw.png#center alt></p><div style=text-align:center>（图片引用自 <a href=https://carto.com/blog/postgres-fdw/>CART&rsquo;s Blog</a>）</div><p>本文仅关注 postgres_fdw，即 PostgreSQL 数据库如何与外部 PostgreSQL 数据库进行连接以及其如何对外部数据进行管理。</p><h3 id=1-使用-postgres_fdw>1 使用 postgres_fdw</h3><p>要想使用 postgres_fdw 对远程数据库进行访问，主要有如下几个步骤：</p><ul><li>安装 postgres_fdw 扩展</li><li>创建外部服务器</li><li>创建用户映射</li><li>创建外部表或导入外部模式</li></ul><p>本文使用本地 PostgreSQL 数据库模拟远程数据库和本地数据库，开始正式的步骤前，需要提前做一点准备工作。</p><ul><li><p>检查 PostgreSQL 版本</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ psql --version
</span></span><span style=display:flex><span>psql (PostgreSQL) 14.2
</span></span></code></pre></div></li><li><p>在远程 PostgreSQL 数据库创建用户</p><p>使用 superuser 在远程 PostgreSQL 数据库执行如下语句创建普通用户<code>fdw_user</code>，供后面本地数据库建立 FDW 连接时使用。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>USER</span><span style=color:#bbb> </span>fdw_user<span style=color:#bbb> </span><span style=color:#000;font-weight:700>WITH</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>ENCRYPTED</span><span style=color:#bbb> </span>PASSWORD<span style=color:#bbb> </span><span style=color:#d14>&#39;secret&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>在远程 PostgreSQL 数据库创建表</p><p>在远程数据库创建用于测试的天气表<code>weather</code>，插入测试数据，并为用户<code>fdw_user</code>授权针对该表的增删改查权限。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TABLE</span><span style=color:#bbb> </span>weather<span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>city<span style=color:#bbb>        </span><span style=color:#0086b3>varchar</span>(<span style=color:#099>80</span>),<span style=color:#bbb> </span><span style=color:#998;font-style:italic>-- city name (城市名)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>    </span>temp_low<span style=color:#bbb>    </span><span style=color:#0086b3>int</span>,<span style=color:#bbb>  </span><span style=color:#998;font-style:italic>-- low temperature (最低温度)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>    </span>temp_high<span style=color:#bbb>   </span><span style=color:#0086b3>int</span>,<span style=color:#bbb>  </span><span style=color:#998;font-style:italic>-- high temperature (最高温度)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>    </span>prcp<span style=color:#bbb>        </span><span style=color:#0086b3>real</span>,<span style=color:#bbb> </span><span style=color:#998;font-style:italic>-- precipitation (降水量)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#0086b3>date</span><span style=color:#bbb>        </span><span style=color:#0086b3>date</span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic>-- date (日期)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>INTO</span><span style=color:#bbb> </span>weather<span style=color:#bbb> </span>(city,<span style=color:#bbb> </span>temp_low,<span style=color:#bbb> </span>temp_high,<span style=color:#bbb> </span>prcp,<span style=color:#bbb> </span><span style=color:#0086b3>date</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>VALUES</span><span style=color:#bbb> </span>(<span style=color:#d14>&#39;Beijing&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>18</span>,<span style=color:#bbb> </span><span style=color:#099>32</span>,<span style=color:#bbb> </span><span style=color:#099>0</span>.<span style=color:#099>25</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2021-05-19&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>(<span style=color:#d14>&#39;Beijing&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>20</span>,<span style=color:#bbb> </span><span style=color:#099>30</span>,<span style=color:#bbb> </span><span style=color:#099>0</span>.<span style=color:#099>0</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2021-05-20&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>(<span style=color:#d14>&#39;Dalian&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>16</span>,<span style=color:#bbb> </span><span style=color:#099>24</span>,<span style=color:#bbb> </span><span style=color:#099>0</span>.<span style=color:#099>0</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2021-05-21&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>GRANT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>SELECT</span>,<span style=color:#000;font-weight:700>INSERT</span>,<span style=color:#000;font-weight:700>UPDATE</span>,<span style=color:#000;font-weight:700>DELETE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>ON</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TABLE</span><span style=color:#bbb> </span>weather<span style=color:#bbb> </span><span style=color:#000;font-weight:700>TO</span><span style=color:#bbb> </span>fdw_user;<span style=color:#bbb>
</span></span></span></code></pre></div><p>在本地使用用户<code>fdw_user</code>对远程数据库（本文特殊，使用本机数据库同时模拟本地与远程，所以远程 host 也是 localhost）进行连接，并校验所授权的权限。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ psql -h localhost -U fdw_user postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; SELECT * FROM weather;
</span></span><span style=display:flex><span>  city   | temp_low | temp_high | prcp |    date
</span></span><span style=display:flex><span>---------+----------+-----------+------+------------
</span></span><span style=display:flex><span>Beijing |       18 |        32 | 0.25 | 2021-05-19
</span></span><span style=display:flex><span>Beijing |       20 |        30 |    0 | 2021-05-20
</span></span><span style=display:flex><span>Dalian  |       16 |        24 |    0 | 2021-05-21
</span></span><span style=display:flex><span>(3 rows)
</span></span></code></pre></div><p><em>注意：若是真实的远程数据库，要想从本地建立连接，需要在远程数据库的 pg_hba.conf 配置文件增加记录以对访问 IP 开通防火墙。</em></p></li><li><p>在本地 PostgreSQL 数据库创建用户</p><p>使用 superuser 在本地 PostgreSQL 数据库执行如下语句创建普通用户<code>local_user</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>USER</span><span style=color:#bbb> </span>local_user<span style=color:#bbb> </span><span style=color:#000;font-weight:700>WITH</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>ENCRYPTED</span><span style=color:#bbb> </span>PASSWORD<span style=color:#bbb> </span><span style=color:#d14>&#39;secret&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></div></li></ul><p>所有准备工作都做好了，现在可以使用 superuser 在本地数据库开始正式的步骤了。</p><h4 id=安装-postgres_fdw-扩展>安装 postgres_fdw 扩展</h4><p>使用<code>CREATE EXTENSION</code>语句安装<code>postgres_fdw</code>扩展。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span>EXTENSION<span style=color:#bbb> </span>postgres_fdw;<span style=color:#bbb>
</span></span></span></code></pre></div><p>为用户<code>local_user</code>授权<code>postgres_fdw</code>的使用权限。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>GRANT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>USAGE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>ON</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>DATA</span><span style=color:#bbb> </span>WRAPPER<span style=color:#bbb> </span>postgres_fdw<span style=color:#bbb> </span><span style=color:#000;font-weight:700>TO</span><span style=color:#bbb> </span>local_user;<span style=color:#bbb>
</span></span></span></code></pre></div><h4 id=创建外部服务器>创建外部服务器</h4><p>使用<code>CREATE SERVER</code>语句创建外部服务器，需要指定远程数据库的主机、端口及数据库名。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>DATA</span><span style=color:#bbb> </span>WRAPPER<span style=color:#bbb> </span>postgres_fdw<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>OPTIONS</span><span style=color:#bbb> </span>(<span style=color:#000;font-weight:700>host</span><span style=color:#bbb> </span><span style=color:#d14>&#39;localhost&#39;</span>,<span style=color:#bbb> </span>port<span style=color:#bbb> </span><span style=color:#d14>&#39;5432&#39;</span>,<span style=color:#bbb> </span>dbname<span style=color:#bbb> </span><span style=color:#d14>&#39;postgres&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>为用户<code>local_user</code>授权外部服务器<code>foreign_server</code>的使用权限。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>GRANT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>USAGE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>ON</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb> </span><span style=color:#000;font-weight:700>TO</span><span style=color:#bbb> </span>local_user;<span style=color:#bbb>
</span></span></span></code></pre></div><h4 id=创建用户映射>创建用户映射</h4><p>使用<code>CREATE USER MAPPING</code>语句创建远程用户与本地用户的映射，需要提供远程用户的用户名及密码。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>USER</span><span style=color:#bbb> </span>MAPPING<span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOR</span><span style=color:#bbb> </span>local_user<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>OPTIONS</span><span style=color:#bbb> </span>(<span style=color:#000;font-weight:700>user</span><span style=color:#bbb> </span><span style=color:#d14>&#39;fdw_user&#39;</span>,<span style=color:#bbb> </span>password<span style=color:#bbb> </span><span style=color:#d14>&#39;secret&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><h4 id=创建外部表或导入外部模式>创建外部表或导入外部模式</h4><p>使用<code>CREATE FOREIGN TABLE</code>语句创建远程表。需要注意各列的类型需与实际的远程表相匹配，列名也最好保持一致，否则您需要使用<code>column_name</code>参数为每一列单独指定远程表中的列名。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TABLE</span><span style=color:#bbb> </span>foreign_weather<span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>city<span style=color:#bbb>        </span><span style=color:#0086b3>varchar</span>(<span style=color:#099>80</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>temp_low<span style=color:#bbb>    </span><span style=color:#0086b3>int</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>temp_high<span style=color:#bbb>   </span><span style=color:#0086b3>int</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>prcp<span style=color:#bbb>        </span><span style=color:#0086b3>real</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#0086b3>date</span><span style=color:#bbb>        </span><span style=color:#0086b3>date</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>OPTIONS</span><span style=color:#bbb> </span>(<span style=color:#000;font-weight:700>schema_name</span><span style=color:#bbb> </span><span style=color:#d14>&#39;public&#39;</span>,<span style=color:#bbb> </span><span style=color:#000;font-weight:700>table_name</span><span style=color:#bbb> </span><span style=color:#d14>&#39;weather&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>外部表多的话，这样一个一个新建会比较痛苦，多数情形下，您只要使用<code>IMPORT FOREIGN SCHEMA</code>语句直接将外部模式下的所有表导入本地指定的模式即可。</p><p><em>注意：因未给 super_user 指定用户映射，如下语句需要使用用户<code>local_user</code>执行，否则会报<code>ERROR: user mapping not found for "super_user"</code>错误。</em></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#998;font-style:italic>-- 导入外部模式下的所有表
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>IMPORT<span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>SCHEMA</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb> </span><span style=color:#000;font-weight:700>INTO</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>public</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- 导入外部模式下的指定表
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>IMPORT<span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>SCHEMA</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>LIMIT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TO</span><span style=color:#bbb> </span>(weather)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb> </span><span style=color:#000;font-weight:700>INTO</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>public</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>为<code>local_user</code>授权 public 模式下所有表（包括外部表）的增删改查权限。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>GRANT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>SELECT</span>,<span style=color:#000;font-weight:700>INSERT</span>,<span style=color:#000;font-weight:700>UPDATE</span>,<span style=color:#000;font-weight:700>DELETE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>ON</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>ALL</span><span style=color:#bbb> </span>TABLES<span style=color:#bbb> </span><span style=color:#000;font-weight:700>IN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>SCHEMA</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>public</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TO</span><span style=color:#bbb> </span>local_user;<span style=color:#bbb>
</span></span></span></code></pre></div><p>这样，使用用户<code>local_user</code>连接到本地数据库，即可以对外部表进行操作了。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ psql -U local_user postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; SELECT * FROM foreign_weather;
</span></span><span style=display:flex><span>  city   | temp_low | temp_high | prcp |    date
</span></span><span style=display:flex><span>---------+----------+-----------+------+------------
</span></span><span style=display:flex><span> Beijing |       18 |        32 | 0.25 | 2021-05-19
</span></span><span style=display:flex><span> Beijing |       20 |        30 |    0 | 2021-05-20
</span></span><span style=display:flex><span> Dalian  |       16 |        24 |    0 | 2021-05-21
</span></span><span style=display:flex><span>(3 rows)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; UPDATE foreign_weather SET prcp=0 WHERE city=&#39;Beijing&#39; AND date=&#39;2021-05-19&#39;;
</span></span><span style=display:flex><span>UPDATE 1
</span></span></code></pre></div><p>至此，我们已基本掌握了<code>postgres_fdw</code>的使用方式。本文接下来会看一下跟 FDW 相关的系统表及函数，最后看一下 FDW 的事务管理及性能优化，以便对 FDW 有一个更深入的了解。</p><h3 id=2-建立-postgres_fdw-时的几个重要参数>2 建立 postgres_fdw 时的几个重要参数</h3><ul><li><p>updatable</p><p>该选项用于设置外部表是否可被更新，即 postgres_fdw 是否允许使用<code>INSERT</code>、<code>UPDATE</code>和<code>DELETE</code>命令修改外部表，默认是<code>true</code>。其可以指定在外部表上，也可以指定在外部服务器上，指定在表上的会覆盖指定在服务器上的。</p><p>设置或更新该参数的具体语句如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#998;font-style:italic>-- 创建外部服务器时指定
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>DATA</span><span style=color:#bbb> </span>WRAPPER<span style=color:#bbb> </span>postgres_fdw<span style=color:#bbb> </span><span style=color:#000;font-weight:700>OPTIONS</span><span style=color:#bbb> </span>(...,<span style=color:#bbb> </span>updatable<span style=color:#bbb> </span><span style=color:#d14>&#39;false&#39;</span>,<span style=color:#bbb> </span>...);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- 创建外部表时指定
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TABLE</span><span style=color:#bbb> </span>foreign_weather<span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#000;font-weight:700>OPTIONS</span><span style=color:#bbb> </span>(<span style=color:#000;font-weight:700>schema_name</span><span style=color:#bbb> </span>...,<span style=color:#bbb> </span><span style=color:#000;font-weight:700>table_name</span><span style=color:#bbb> </span>...,<span style=color:#bbb> </span>updatable<span style=color:#bbb> </span><span style=color:#d14>&#39;false&#39;</span>,<span style=color:#bbb> </span>...);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- 更新外部服务器参数选项
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>ALTER</span><span style=color:#bbb> </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb> </span><span style=color:#000;font-weight:700>OPTIONS</span><span style=color:#bbb> </span>(updatable<span style=color:#bbb> </span><span style=color:#d14>&#39;false&#39;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- 更新外部表参数选项
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>ALTER</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TABLE</span><span style=color:#bbb> </span>foreign_weather<span style=color:#bbb> </span><span style=color:#000;font-weight:700>OPTIONS</span>(updatable<span style=color:#bbb> </span><span style=color:#d14>&#39;false&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>当然，如果远程表实际上不可更新，那么无论如何都会发生错误。使用此选项主要是允许在本地抛出错误，而无需查询远程服务器。</p></li><li><p>truncatable</p><p>该选项用于设置外部表是否可被截断，即 postgres_fdw 是否允许使用<code>TRUNCATE</code>命令截断外部表，默认是<code>true</code>。该参数同样可以指定在外部表上，也可以指定在外部服务器上，指定在表上的会覆盖指定在服务器上的。</p><p>设置或更新该参数的具体语句同上述<code>updatable</code>完全一样。</p><p>当然，如果远程表实际上不可被截断，那么无论如何都会发生错误。使用此选项同样主要是可以允许在本地抛出错误，而无需查询远程服务器。</p></li><li><p>keep_connections</p><p>该选项用于设置 postgres_fdw 是否将与远程服务器的连接保留在本地会话（local session），以方便重用，默认是<code>on</code>（若设置为<code>off</code>，则在每个事务结束时将放弃与外部服务器的所有连接）。其只可以指定在外部服务器上。设置或更新该参数的具体语句如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#998;font-style:italic>-- 创建外部服务器时指定
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb> </span><span style=color:#000;font-weight:700>FOREIGN</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>DATA</span><span style=color:#bbb> </span>WRAPPER<span style=color:#bbb> </span>postgres_fdw<span style=color:#bbb> </span><span style=color:#000;font-weight:700>OPTIONS</span><span style=color:#bbb> </span>(...,<span style=color:#bbb> </span>keep_connections<span style=color:#bbb> </span><span style=color:#d14>&#39;off&#39;</span>,<span style=color:#bbb> </span>...);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#998;font-style:italic>-- 更新外部服务器参数选项
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>ALTER</span><span style=color:#bbb> </span>SERVER<span style=color:#bbb> </span>foreign_server<span style=color:#bbb> </span><span style=color:#000;font-weight:700>OPTIONS</span><span style=color:#bbb> </span>(keep_connections<span style=color:#bbb> </span><span style=color:#d14>&#39;off&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div></li></ul><h3 id=3-fdw-相关的系统表及函数>3 FDW 相关的系统表及函数</h3><p><strong>系统表</strong></p><p>跟 FDW 相关的系统表如下（对于<code>_pg_*</code>表，super_user 才有权限访问）：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>information_schema._pg_foreign_data_wrappers
</span></span><span style=display:flex><span>information_schema._pg_foreign_servers
</span></span><span style=display:flex><span>information_schema._pg_foreign_tables
</span></span><span style=display:flex><span>information_schema._pg_foreign_table_columns
</span></span><span style=display:flex><span>information_schema._pg_user_mappings
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>information_schema.foreign_data_wrappers
</span></span><span style=display:flex><span>information_schema.foreign_data_wrapper_options
</span></span><span style=display:flex><span>information_schema.foreign_server_options
</span></span><span style=display:flex><span>information_schema.foreign_servers
</span></span><span style=display:flex><span>information_schema.foreign_tables
</span></span><span style=display:flex><span>information_schema.foreign_table_options
</span></span></code></pre></div><p><strong>函数</strong></p><ul><li><p>postgres_fdw_get_connections()</p><p>调用该函数会返回 postgres_fdw 从本地会话（local session）到外部服务器所建立的所有开放连接的外部服务器名及连接是否有效。</p><p><em>注意：该函数获取的是当前本地会话与外部服务器的连接状态，非本地数据库与外部服务器的连接状态。所以，另开一个 Shell Tab 进行的远程表查询不会被当前本地会话记录。</em></p><p>本文创建外部服务器时对<code>keep_connections</code>参数采用的是默认选项（<code>on</code>），所以会保留连接。</p><p>可以看到如下<code>psql</code>连接到本地数据库，进行外部表查询后，查询<code>postgres_fdw_get_connections()</code>函数会返回一行记录。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ psql -U local_user postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; SELECT * FROM foreign_weather;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; SELECT * FROM postgres_fdw_get_connections();
</span></span><span style=display:flex><span>  server_name   | valid
</span></span><span style=display:flex><span>----------------+-------
</span></span><span style=display:flex><span>foreign_server | t
</span></span><span style=display:flex><span>(1 row)
</span></span></code></pre></div></li><li><p>postgres_fdw_disconnect(server_name text)</p><p>根据传入的名称，断开 postgres_fdw 从本地会话（local session）到指定外部服务器的所有连接。</p><p>使用不同的用户映射可以有多个到给定服务器的连接（使用多个用户访问外部服务器时，配置了多个用户映射，postgres_fdw 会为每个用户映射建立一个连接）。若连接正在当前本地事务中使用，则不会断开，会输出警告消息。若至少断开一个连接，则返回 true，否则返回 false。若未找到具有给定名称的外部服务器，则会报错（<code>ERROR: server "..." does not exist</code>）。</p><p>接着刚刚的会话，执行<code>SELECT postgres_fdw_disconnect('foreign_server')</code>，返回<code>true</code>；再次查询<code>postgres_fdw_get_connections()</code>函数发现已没有连接。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>postgres=&gt; SELECT postgres_fdw_disconnect(&#39;foreign_server&#39;);
</span></span><span style=display:flex><span>  postgres_fdw_disconnect
</span></span><span style=display:flex><span>-------------------------
</span></span><span style=display:flex><span>t
</span></span><span style=display:flex><span>(1 row)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; SELECT * FROM postgres_fdw_get_connections();
</span></span><span style=display:flex><span>  server_name | valid
</span></span><span style=display:flex><span>-------------+-------
</span></span><span style=display:flex><span>(0 rows)
</span></span></code></pre></div></li><li><p>postgres_fdw_disconnect_all()</p><p>断开 postgres_fdw 从本地会话（local session）到外部服务器的所有连接。使用方式与<code>postgres_fdw_disconnect(server_name text)</code>类似，这里不再赘述。</p></li></ul><h3 id=4-fdw-事务管理及性能优化>4 FDW 事务管理及性能优化</h3><p><strong>事务管理</strong></p><p>当查询远程表时，若尚未打开与当前本地事务对应的事务，postgres_fdw 会在远程服务器上新开一个事务。当本地事务提交或中止时，远程事务也被提交或中止。保存点（Savepoints）同样通过创建相应的远程保存点来管理。</p><p>当本地事务具有可序列化（SERIALIZABLE）隔离级别时，远程事务也使用该隔离级别；否则，使用可重复读（REPEATABLE READ）隔离级别。</p><p>若一个查询在远程服务器上执行多个表扫描，此选项可确保其对所有扫描将得到快照一致性（snapshot-consistent）结果。结果是，即使其它活动在远程服务器上进行了并发更新，单个事务中的连续查询将看到来自远程服务器的相同数据。若本地事务使用可序列化（SERIALIZABLE）或可重复读（REPEATABLE READ）隔离级别，那么这种行为是可预期的，但对于读已提交（READ COMMITTED）隔离级别的本地事务来说，这可能会令人惊讶。未来的 PostgreSQL 版本可能会修改这些规则。</p><p><strong>性能优化</strong></p><p>postgres_fdw 会比较智能的判断一个查询语句（待检测的查询语句包括<code>SELECT</code>、<code>UPDATE</code>、<code>DELETE</code>语句，语句中涉及运算符、函数、连接、过滤条件及聚集函数等）是否应该下移到远程服务器执行。</p><p>最理想的情况是，所涉及的表都在远程服务器上，运算符、函数等都为内置类型，这样 postgres_fdw 将整个查询发送给远程服务器进行计算，然后取结果就好了。而多数情况是 postgres_fdw 需要将必要的数据取到本地来进行连接、过滤及聚集函数处理等操作。即 postgres_fdw 会优化发送到远程服务器的查询（优化 WHERE 子句，及不获取不需要的列）以减少来自远程服务器的数据传输。</p><p>下面我们看两个例子：</p><ul><li><p>纯远程表查询</p><p>原始查询语句：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>*</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>foreign_weather;<span style=color:#bbb>
</span></span></span></code></pre></div><p>使用<code>EXPLAIN VERBOSE</code>查看实际发送到远程服务器的查询（Remote SQL）为：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span>city,<span style=color:#bbb> </span>temp_low,<span style=color:#bbb> </span>temp_high,<span style=color:#bbb> </span>prcp,<span style=color:#bbb> </span><span style=color:#0086b3>date</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>public</span>.weather<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ psql -U local_user postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; EXPLAIN VERBOSE SELECT * FROM foreign_weather;
</span></span><span style=display:flex><span>                                    QUERY PLAN
</span></span><span style=display:flex><span>----------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Foreign Scan on public.foreign_weather  (cost=100.00..121.25 rows=375 width=194)
</span></span><span style=display:flex><span>  Output: city, temp_low, temp_high, prcp, date
</span></span><span style=display:flex><span>  Remote SQL: SELECT city, temp_low, temp_high, prcp, date FROM public.weather
</span></span><span style=display:flex><span>(3 rows)
</span></span></code></pre></div></li><li><p>远程表与本地表连接查询</p><p>新建本地表<code>cities</code>，并插入测试数据：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TABLE</span><span style=color:#bbb> </span>cities<span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>name<span style=color:#bbb>        </span><span style=color:#0086b3>varchar</span>(<span style=color:#099>80</span>),<span style=color:#bbb> </span><span style=color:#998;font-style:italic>-- city name (城市名)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>location</span><span style=color:#bbb>    </span>point<span style=color:#bbb> </span><span style=color:#998;font-style:italic>-- point为PostgreSQL特有类型，该字段表示地理坐标(经度, 纬度)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>INTO</span><span style=color:#bbb> </span>cities<span style=color:#bbb> </span>(name,<span style=color:#bbb> </span><span style=color:#000;font-weight:700>location</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>VALUES</span><span style=color:#bbb> </span>(<span style=color:#d14>&#39;Beijing&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;(116.3, 39.9)&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>         </span>(<span style=color:#d14>&#39;Shanghai&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;(121.3, 31.1)&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>对于查询：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>*</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>cities<span style=color:#bbb> </span><span style=color:#000;font-weight:700>c</span>,<span style=color:#bbb> </span>foreign_weather<span style=color:#bbb> </span>w<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>WHERE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>c</span>.name<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>w.city;<span style=color:#bbb>
</span></span></span></code></pre></div><p>postgres_fdw 发送给远程服务器的 SQL 为：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span>city,<span style=color:#bbb> </span>temp_low,<span style=color:#bbb> </span>temp_high,<span style=color:#bbb> </span>prcp,<span style=color:#bbb> </span><span style=color:#0086b3>date</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>public</span>.weather;<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ psql -U local_user postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; EXPLAIN VERBOSE SELECT * FROM cities c, foreign_weather w WHERE c.name = w.city;
</span></span><span style=display:flex><span>                                      QUERY PLAN
</span></span><span style=display:flex><span>------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Hash Join  (cost=118.10..163.91 rows=675 width=388)
</span></span><span style=display:flex><span>  Output: c.name, c.location, w.city, w.temp_low, w.temp_high, w.prcp, w.date
</span></span><span style=display:flex><span>  Hash Cond: ((w.city)::text = (c.name)::text)
</span></span><span style=display:flex><span>  -&gt;  Foreign Scan on public.foreign_weather w  (cost=100.00..121.25 rows=375 width=194)
</span></span><span style=display:flex><span>        Output: w.city, w.temp_low, w.temp_high, w.prcp, w.date
</span></span><span style=display:flex><span>        Remote SQL: SELECT city, temp_low, temp_high, prcp, date FROM public.weather
</span></span><span style=display:flex><span>  -&gt;  Hash  (cost=13.60..13.60 rows=360 width=194)
</span></span><span style=display:flex><span>        Output: c.name, c.location
</span></span><span style=display:flex><span>        -&gt;  Seq Scan on public.cities c  (cost=0.00..13.60 rows=360 width=194)
</span></span><span style=display:flex><span>              Output: c.name, c.location
</span></span><span style=display:flex><span>(10 rows)
</span></span></code></pre></div><p>即 postgres_fdw 会将<code>foreign_weather</code>的全部数据获取到本地后与表<code>cities</code>进行连接计算。</p><p>而对于查询：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>c</span>.name,<span style=color:#bbb> </span><span style=color:#000;font-weight:700>max</span>(w.temp_high)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>cities<span style=color:#bbb> </span><span style=color:#000;font-weight:700>c</span>,<span style=color:#bbb> </span>foreign_weather<span style=color:#bbb> </span>w<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>WHERE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>c</span>.name<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>w.city<span style=color:#bbb> </span><span style=color:#000;font-weight:700>AND</span><span style=color:#bbb> </span>w.temp_high<span style=color:#bbb> </span><span style=color:#000;font-weight:700>&lt;=</span><span style=color:#bbb> </span><span style=color:#099>30</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>GROUP</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>BY</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>c</span>.name;<span style=color:#bbb>
</span></span></span></code></pre></div><p>postgres_fdw 发送给远程服务器的 SQL 为：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span>city,<span style=color:#bbb> </span>temp_high<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>public</span>.weather<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>WHERE</span><span style=color:#bbb> </span>(temp_high<span style=color:#bbb> </span><span style=color:#000;font-weight:700>&lt;=</span><span style=color:#bbb> </span><span style=color:#099>30</span>)<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ psql -U local_user postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=&gt; EXPLAIN VERBOSE SELECT c.name, max(w.temp_high) FROM cities c, foreign_weather w WHERE c.name = w.city AND w.temp_high &lt;= 30 group by c.name;
</span></span><span style=display:flex><span>                                            QUERY PLAN
</span></span><span style=display:flex><span>------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>HashAggregate  (cost=143.17..145.17 rows=200 width=182)
</span></span><span style=display:flex><span>  Output: c.name, max(w.temp_high)
</span></span><span style=display:flex><span>  Group Key: c.name
</span></span><span style=display:flex><span>  -&gt;  Hash Join  (cost=119.25..141.98 rows=238 width=182)
</span></span><span style=display:flex><span>        Output: c.name, w.temp_high
</span></span><span style=display:flex><span>        Hash Cond: ((c.name)::text = (w.city)::text)
</span></span><span style=display:flex><span>        -&gt;  Seq Scan on public.cities c  (cost=0.00..13.60 rows=360 width=178)
</span></span><span style=display:flex><span>              Output: c.name, c.location
</span></span><span style=display:flex><span>        -&gt;  Hash  (cost=117.60..117.60 rows=132 width=182)
</span></span><span style=display:flex><span>              Output: w.temp_high, w.city
</span></span><span style=display:flex><span>              -&gt;  Foreign Scan on public.foreign_weather w  (cost=100.00..117.60 rows=132 width=182)
</span></span><span style=display:flex><span>                    Output: w.temp_high, w.city
</span></span><span style=display:flex><span>                    Remote SQL: SELECT city, temp_high FROM public.weather WHERE ((temp_high &lt;= 30))
</span></span><span style=display:flex><span>(13 rows)
</span></span></code></pre></div><p>即 postgres_fdw 会优化发给远程服务器的<code>WHERE</code>条件，仅从远程表<code>foreign_weather</code>获取所需要的数据，然后在本地与表<code>cities</code>进行连接、过滤及聚集函数处理等计算。</p></li></ul><p>综上，我们对 PostgreSQL 外部数据包装器的基础概念及 postgres_fdw 的使用方式有了一个比较详细的了解。</p><blockquote><p>参考资料</p><p>[1] <a href=https://www.postgresql.org/docs/14/postgres-fdw.html>PostgreSQL: Documentation: 14: F.35. postgres_fdw</a></p><p>[2] <a href=https://wiki.postgresql.org/wiki/Foreign_data_wrappers>Foreign data wrappers - PostgreSQL Wiki</a></p><p>[3] <a href=https://carto.com/blog/postgres-fdw/>CARTO&rsquo;s Use of Foreign Data Wrappers</a></p><p>[4] <a href=https://blog.csdn.net/weixin_39540651/article/details/105968786>PostgreSQL fdw 详解</a></p><p>[5] <a href=https://zhuanlan.zhihu.com/p/49981726>Postgresql fdw 原理及 postgres_fdw 使用</a></p><p>[6] <a href=https://blog.csdn.net/qq_31156277/article/details/90580804>PostgreSQL 中的 postgres_fdw 扩展</a></p><p>[7] <a href=https://mp.weixin.qq.com/s/7XjPa-ZeU8mNCvcIwOTHrA>PostgreSQL 14 中的 postgres_fdw 增强功能</a></p></blockquote></div><div class=content-footer><div class=weixinhao><img src=/static/images/self/weixinhao-white.jpg></div><div class=post-tags><a href=/tags/postgresql/>#PostgreSQL</a></div><div class=license><i class=ti-info-alt></i><div class=info>版权声明：该博客文章由作者通过「<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>知识共享署名 4.0 许可证</a>」进行授权，转载须注明文章原始链接。</div></div></div></div><div class="col-lg-8 mx-auto block shadow"><h3>相关文章</h3><ul><li><a href=/posts/postgres-tablespaces.html>PostgreSQL 表空间使用详解</a></li><li><a href=/posts/azure-postgres.html>Azure Database for PostgreSQL 学习总结</a></li><li><a href=/posts/how-to-migrate-data-from-mysql-to-postgres-with-datax.html>如何使用 Alibaba DataX 进行 MySQL 到 PostgreSQL 的数据迁移</a></li><li><a href=/posts/postgres-jdbc-driver-issue.html>PostgreSQL JDBC Driver 42.3.0 读取 BigDecimal 时发生抹 0 的 Bug</a></li><li><a href=/posts/postgres-ddl.html>PostgreSQL 数据定义相关知识总结</a></li></ul></div><div class="col-lg-8 mx-auto block shadow"><div><h3>评论</h3><div id=comment-loading style=text-align:center;font-size:14px><img style=width:52px src=/static/images/site/mona-loading-default.gif>
<span>正在加载评论......</span></div><script>function handleMessage(e){if(e.origin!=="https://giscus.app")return;if(typeof e.data!="object"||!e.data.giscus)return;const t=document.getElementById("comment-loading");t.style.display="none"}window.addEventListener("message",handleMessage)</script><script src=https://giscus.app/client.js data-repo=leileiluoluo/leileiluoluo.github.io data-repo-id=R_kgDOJkLT8w data-category=General data-category-id=DIC_kwDOJkLT884CdtEh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div></div></section><footer class="py-4 bg-lights border-top"><div class=container><div class="row justify-content-between text-center align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/sponsor>随喜打赏</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/about>关于本博</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/links>友情链接</a></li></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a title=文章归档 href=/archives/><i class=ti-archive></i></a></li><li class=list-inline-item><a title=文章标签 href=/tags/><i class=ti-tag></i></a></li><li class=list-inline-item><a title="我的 GitHub" href=https://github.com/leileiluoluo><i class=ti-github></i></a></li><li class=list-inline-item><a title="网站 RSS" href=/index.xml><i class=ti-rss></i></a></li></ul></div></div><div style=text-align:center;font-size:18px;margin-bottom:22px><a style="-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-image:linear-gradient(to right,#14100f,#d55b5b,#4d14e6)" href=https://www.boyouquan.com/planet-shuttle>「博友圈 · 星球穿梭」</a></div><div class="text-center mt-4"><span>Made with <a href=https://gohugo.io/>Hugo</a> | Theme by <a href=https://github.com/themefisher/northendlab-hugo>NorthendLab</a> | <a href=https://beian.miit.gov.cn>辽ICP备2022012085号-5</a> | Copyright © 2017-2025</span></div></div></footer><script>var indexURL="https://leileiluoluo.github.io/index.json"</script><script src=https://leileiluoluo.github.io/js/jquery.min.js></script><script src=https://leileiluoluo.github.io/js/bootstrap.min.js></script><script src=https://leileiluoluo.github.io/js/fuse.min.js></script><script src=https://leileiluoluo.github.io/js/mark.js></script><script src=https://leileiluoluo.github.io/js/search.js></script><script src=https://leileiluoluo.github.io/js/script.min.js></script></body></html>