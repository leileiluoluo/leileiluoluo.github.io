<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>Azure 流水线使用详解 - 磊磊落落</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=keywords content="Azure,流水线,Pipelines,DevOps"><meta name=description content="Azure 流水线使用详解"><meta name=author content="磊磊落落"><meta name=generator content="Hugo 0.81.0"><link rel=stylesheet href=https://olzhy.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://olzhy.github.io/css/themify-icons.css><link rel=stylesheet href=https://olzhy.github.io/css/larry-custom.css><link rel=stylesheet href=https://olzhy.github.io/scss/style.min.css media=screen><link rel="shortcut icon" href=https://olzhy.github.io/images/favicon.png type=image/x-icon><link rel=icon href=https://olzhy.github.io/images/favicon.png type=image/x-icon><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?526723b767317055572c85bdb445353c",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://olzhy.github.io/>磊磊落落</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://olzhy.github.io/></a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E9%9A%8F%E7%AC%94/>随笔</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%AF%BB%E4%B9%A6/>读书</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%A7%82%E5%BD%B1/>观影</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E7%BB%83%E5%AD%97/>练字</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/>计算机</a></li></ul><div class=search><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=https://olzhy.github.io//search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder=键入关键字后回车...></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h1>Azure 流水线使用详解</h1><div class="mb-3 post-meta">2022年04月12日
<a href=/categories/%e8%ae%a1%e7%ae%97%e6%9c%ba>计算机</a></div><div class="content mb-5"><p>Azure 流水线（Azure Pipelines）是 Azure DevOps 的一部分。Azure 流水线结合了持续集成（CI）和持续交付（CD）来构建和测试代码，并可将其发布到任何目标环境。Azure 流水线有经典（可视化）和 YAML 两种配置使用方式。作为开发，本文仅关注 YAML 这种配置方式。</p><p><strong>Azure 流水线支持的场景或环境</strong></p><ul><li><p>支持的版本控制系统</p><p>为应用配置 CI/CD 前，须将源码提交到一个版本控制系统上。Azure DevOps 支持 GitHub、 Azure Repos 和 Bitbucket 等版本控制平台。</p></li><li><p>支持的开发语言或应用</p><p>Azure 流水线支持在 Linux、macOS 及 Windows 三种代理节点上构建、测试及部署绝大多数语言（诸如：Python、Java、JavaScript、PHP、Ruby、C#、C++ 和 Go 等）开发的应用。</p><p>Azure 流水线提供一组现成的 Task（任务）来构建或测试这些常用语言编写的应用。此外，还支持在流水线直接运行命令行、PowerShell 或 Shell 脚本。</p></li><li><p>支持的目标部署环境</p><p>Azure 流水线支持绝大多数的目标部署环境，包括：虚拟机环境、容器环境、On-Premise 环境、和云平台环境。也可以借助 Azure 流水线将一个移动 App 发布到应用商店。</p></li><li><p>支持的测试方式</p><p>Azure 流水线支持部署在云上或 On-Premise 环境上应用的自动化测试。支持用户选择自己喜欢的测试技术和测试框架，且提供丰富的测试报告。</p></li><li><p>支持的包格式及仓库</p><p>Azure 流水线支持市面上常用的打包工具（如 NuGet、npm 及 Maven 等），且支持将构建好的包发布到 Azure 流水线内置的包管理仓库或其它外部包管理仓库（如 Nexus、Artifactory 等）。</p></li></ul><p><strong>Azure 流水线的编写方式</strong></p><p>须在工程根目录新建<code>azure-pipelines.yml</code> YAML 文件来定义 Azure 流水线。</p><p>Azure 流水线定义文件与项目代码同属一个仓库，一同进行版本控制，并遵循相同的分支策略（如 <code>feature-xxx => develop => master</code> 分支策略）。通过检查 PR（拉取请求，Pull Request）来验证更改。</p><p>所以，使用 Azure 流水线的基本步骤为：</p><ul><li>为 Git 代码仓库配置 Azure 流水线；</li><li>在工程根目录新建<code>azure-pipelines.yml</code>文件定义流水线步骤（编译、打包、发布及部署等）；</li><li>当更新了代码并提交 PR 到指定的分支时，会自动触发 PR 阶段对应流水线中定义的步骤，完成后，检查运行结果；然后，决定是否合并 PR 到指定的分支，从而决定是否触发该分支对应的流水线步骤。</li></ul><p><img loading=lazy src=https://olzhy.github.io/static/images/uploads/2022/04/azure-pipelines-image-yaml.png#center alt width=80%></p><p>下面就一步一步探索下 Azure 流水线的具体使用方法。</p><h2 id=1-开始使用-azure-流水线>1 开始使用 Azure 流水线</h2><h3 id=11-注册-azure-流水线>1.1 注册 Azure 流水线</h3><p>打开<a href=https://azure.microsoft.com/en-us/services/devops/pipelines/>Azure 流水线介绍页</a>，然后点击<code>Start free</code>或<code>Start free with Github</code>，其会引导使用微软账号或 Github 账号来注册 Azure 流水线；完成后，需要创建一个 Azure DevOps 组织，创建好以后即可以用 URL 的方式进行访问了（如本文 Azure DevOps 组织地址为：https://dev.azure.com/olzhy）。组织建好后，其会引导创建一个项目，项目建好后，即可在其下看到有流水线。</p><p><img loading=lazy src=https://olzhy.github.io/static/images/uploads/2022/04/azure-pipelines-home.png#center alt width=80%></p><h3 id=12-创建第一条流水线>1.2 创建第一条流水线</h3><p>下面，使用一个 Java 编写的示例应用创建我们的第一条流水线。</p><ul><li><p>Fork 示例仓库</p><p>将如下仓库 Fork 到自己的 Github 账号</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>https://github.com/MicrosoftDocs/pipelines-java
</code></pre></div><p>我的 Github 地址为：<a href=https://github.com/olzhy>https://github.com/olzhy</a>；Fork 完成后的仓库地址为：<a href=https://github.com/olzhy/pipelines-java>https://github.com/olzhy/pipelines-java</a>。</p><p>该工程是一个普通的 Java 工程，仅有一个样例代码文件（<code>Demo.java</code>）和一个单元测试文件（<code>MyTest.java</code>）。</p><p>目录结构如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>pipelines-java
|--- pom.xml
|--- src
|    |--- main       # 代码目录
|    |    \--- com.microsoft.demo.Demo.java
|    \--- test/java  # 单元测试目录
|         \--- MyTest.java
\--- README.md
</code></pre></div></li><li><p>创建流水线</p><p>打开上一步创建好的项目（https://dev.azure.com/olzhy/test），点击 Pipelines 后新建一条流水线；选择从 Github 获取源码，选择推荐的 Maven 流水线模板，保存并运行。会发现，YAML 流水线文件<code>azure-pipelines.yml</code>已被自动创建并提交至仓库。</p><p><code>azure-pipelines.yml</code>文件的内容为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># Maven</span>
<span style=color:#75715e># Build your Java project and run tests with Apache Maven.</span>
<span style=color:#75715e># Add steps that analyze code, save build artifacts, deploy, and more:</span>
<span style=color:#75715e># https://docs.microsoft.com/azure/devops/pipelines/languages/java</span>
<span style=color:#f92672>trigger</span>:
  - <span style=color:#ae81ff>master</span>

<span style=color:#f92672>pool</span>:
  <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>ubuntu-latest</span>

<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>Maven@3</span>
    <span style=color:#f92672>inputs</span>:
      <span style=color:#f92672>mavenPomFile</span>: <span style=color:#e6db74>&#34;pom.xml&#34;</span>
      <span style=color:#f92672>mavenOptions</span>: <span style=color:#e6db74>&#34;-Xmx3072m&#34;</span>
      <span style=color:#f92672>javaHomeOption</span>: <span style=color:#e6db74>&#34;JDKVersion&#34;</span>
      <span style=color:#f92672>jdkVersionOption</span>: <span style=color:#e6db74>&#34;1.8&#34;</span>
      <span style=color:#f92672>jdkArchitectureOption</span>: <span style=color:#e6db74>&#34;x64&#34;</span>
      <span style=color:#f92672>publishJUnitResults</span>: <span style=color:#66d9ef>true</span>
      <span style=color:#f92672>testResultsFiles</span>: <span style=color:#e6db74>&#34;**/surefire-reports/TEST-*.xml&#34;</span>
      <span style=color:#f92672>goals</span>: <span style=color:#e6db74>&#34;package&#34;</span>
</code></pre></div><p>初步看，该流水线内容为使用<code>maven package</code>将代码打包并执行单元测试的一个过程。流水线的编写方式及这里配置参数的意思后面会详细分析。</p><p>流水线的运行结果如下图所示：</p><p><img loading=lazy src=https://olzhy.github.io/static/images/uploads/2022/04/azure-pipelines-result.png#center alt width=80%></p><p>可以看到，日志最后打印说将测试结果发布到了一个地址，打开后发现，单元测试结果被自动发布到了 Azure DevOps 的另一个服务模块 Test Plan 下。</p><p><img loading=lazy src=https://olzhy.github.io/static/images/uploads/2022/04/auzre-pipelines-junit-test-report.png#center alt width=80%></p></li><li><p>添加 Github 状态标识</p><p>将如下内容添加到工程根目录<code>README.md</code>文件最上面，并提交至仓库，即可在 Github 仓库上（<a href=https://github.com/olzhy/pipelines-java>https://github.com/olzhy/pipelines-java</a>）看到流水线状态了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown>[<span style=color:#f92672>![Build Status</span>](<span style=color:#a6e22e>https://dev.azure.com/olzhy/test/_apis/build/status/olzhy.pipelines-java?branchName=master</span>)](https://dev.azure.com/olzhy/test/_build/latest?definitionId=3<span style=color:#960050;background-color:#1e0010>&amp;</span>branchName=master)
</code></pre></div></li></ul><h3 id=13-自定义流水线内容>1.3 自定义流水线内容</h3><p>自定义流水线内容前，先分析一下当前<code>azure-pipelines.yml</code>的内容。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># Maven</span>
<span style=color:#75715e># Build your Java project and run tests with Apache Maven.</span>
<span style=color:#75715e># Add steps that analyze code, save build artifacts, deploy, and more:</span>
<span style=color:#75715e># https://docs.microsoft.com/azure/devops/pipelines/languages/java</span>
<span style=color:#f92672>trigger</span>:
  - <span style=color:#ae81ff>master</span>

<span style=color:#f92672>pool</span>:
  <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>ubuntu-latest</span>

<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>Maven@3</span>
    <span style=color:#f92672>inputs</span>:
      <span style=color:#f92672>mavenPomFile</span>: <span style=color:#e6db74>&#34;pom.xml&#34;</span>
      <span style=color:#f92672>mavenOptions</span>: <span style=color:#e6db74>&#34;-Xmx3072m&#34;</span>
      <span style=color:#f92672>javaHomeOption</span>: <span style=color:#e6db74>&#34;JDKVersion&#34;</span>
      <span style=color:#f92672>jdkVersionOption</span>: <span style=color:#e6db74>&#34;1.8&#34;</span>
      <span style=color:#f92672>jdkArchitectureOption</span>: <span style=color:#e6db74>&#34;x64&#34;</span>
      <span style=color:#f92672>publishJUnitResults</span>: <span style=color:#66d9ef>true</span>
      <span style=color:#f92672>testResultsFiles</span>: <span style=color:#e6db74>&#34;**/surefire-reports/TEST-*.xml&#34;</span>
      <span style=color:#f92672>goals</span>: <span style=color:#e6db74>&#34;package&#34;</span>
</code></pre></div><ul><li><code>trigger</code>部分说明：当 Git 仓库的<code>master</code>分支有新的提交时，该流水线即会被触发；</li><li><code>pool</code>部分说明：该流水线将会在一台 Linux 节点上运行，节点采用的镜像为<code>ubuntu-latest</code>；</li><li><code>steps</code>部分说明：该流水线只有一步，即运行 Maven 任务。</li></ul><p>初步了解了这些参数的意思后，就可以根据自己的需求对流水线做一些修改了。</p><p>如想更改构建平台，即可将<code>pool</code>下面的<code>vmImage</code>指定为<code>windows-latest</code>或<code>macos-latest</code>。</p><p>如想增加一步测试覆盖率报告，即可在<code>steps</code>下加一个任务<code>PublishCodeCoverageResults@1</code>：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>Maven@3</span>
    <span style=color:#ae81ff>...</span>
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>PublishCodeCoverageResults@1</span>
    <span style=color:#f92672>inputs</span>:
      <span style=color:#f92672>codeCoverageTool</span>: <span style=color:#e6db74>&#34;JaCoCo&#34;</span>
      <span style=color:#f92672>summaryFileLocation</span>: <span style=color:#e6db74>&#34;$(System.DefaultWorkingDirectory)/**/site/jacoco/jacoco.xml&#34;</span>
      <span style=color:#f92672>reportDirectory</span>: <span style=color:#e6db74>&#34;$(System.DefaultWorkingDirectory)/**/site/jacoco&#34;</span>
      <span style=color:#f92672>failIfCoverageEmpty</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>如想在多个平台并行运行作业，可将<code>pool</code>部分替换为如下配置：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>strategy</span>:
  <span style=color:#f92672>matrix</span>:
    <span style=color:#f92672>linux</span>:
      <span style=color:#f92672>imageName</span>: <span style=color:#e6db74>&#34;ubuntu-latest&#34;</span>
    <span style=color:#f92672>mac</span>:
      <span style=color:#f92672>imageName</span>: <span style=color:#e6db74>&#34;macOS-latest&#34;</span>
    <span style=color:#f92672>windows</span>:
      <span style=color:#f92672>imageName</span>: <span style=color:#e6db74>&#34;windows-latest&#34;</span>
  <span style=color:#f92672>maxParallel</span>: <span style=color:#ae81ff>3</span>

<span style=color:#f92672>pool</span>:
  <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>$(imageName)</span>
</code></pre></div><p>如想更改触发分支，可更改<code>trigger</code>部分。如下示例说明仅<code>master</code>分支或<code>releases/*</code>分支有提交时才会触发构建。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>trigger</span>:
  - <span style=color:#ae81ff>master</span>
  - <span style=color:#ae81ff>releases/*</span>
</code></pre></div><p>将<code>trigger</code>替换为<code>pr</code>后，说明针对列出的分支有新的 PR 时即会触发构建。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>pr</span>:
  - <span style=color:#ae81ff>master</span>
  - <span style=color:#ae81ff>releases/*</span>
</code></pre></div><p>如想设置流水线启停策略或更改流水线文件（<code>azure-pipelines.yml</code>）路径，需要到流水线详情页上去改，这些关于流水线设置类的功能未在 YAML 文件中管理。</p><p><img loading=lazy src=https://olzhy.github.io/static/images/uploads/2022/04/azure-pipeline-settings.png#center alt width=80%></p><p>此外，还可以为流水线添加错误处理器。</p><p>如下示例流水线有两个<code>Job</code>，第一个<code>Job</code>模拟普通流水线工作。若其发生错误，会触发第二个<code>Job</code>，该<code>Job</code>会直接使用命令的方式调用工作项的 REST API 在项目中创建一个 Bug。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># When manually running the pipeline, you can select whether it</span>
<span style=color:#75715e># succeeds or fails.</span>
<span style=color:#f92672>parameters</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>succeed</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>Succeed or fail</span>
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>boolean</span>
    <span style=color:#f92672>default</span>: <span style=color:#66d9ef>false</span>

<span style=color:#f92672>trigger</span>:
  - <span style=color:#ae81ff>master</span>

<span style=color:#f92672>pool</span>:
  <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>ubuntu-latest</span>

<span style=color:#f92672>jobs</span>:
  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>Work</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo Hello, world!</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Run a one-line script&#34;</span>

      <span style=color:#75715e># This malformed command causes the job to fail</span>
      <span style=color:#75715e># Only run this command if the succeed variable is set to false</span>
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>git clone malformed input</span>
        <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>eq(${{ parameters.succeed }}, false)</span>

  <span style=color:#75715e># This job creates a work item, and only runs if the previous job failed</span>
  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>ErrorHandler</span>
    <span style=color:#f92672>dependsOn</span>: <span style=color:#ae81ff>Work</span>
    <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>failed()</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>bash</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>          az boards work-item create \
</span><span style=color:#e6db74>            --title &#34;Build $(build.buildNumber) failed&#34; \
</span><span style=color:#e6db74>            --type bug \
</span><span style=color:#e6db74>            --org $(System.TeamFoundationCollectionUri) \
</span><span style=color:#e6db74>            --project $(System.TeamProject)</span>          
        <span style=color:#f92672>env</span>:
          <span style=color:#f92672>AZURE_DEVOPS_EXT_PAT</span>: <span style=color:#ae81ff>$(System.AccessToken)</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Create work item on failure&#34;</span>
</code></pre></div><p>本节，我们对 Azure 流水线的使用有了一个最基本的了解，下面详细看一下 Azure 流水线的组成部分及基础概念。</p><h2 id=2-azure-流水线基础概念>2 Azure 流水线基础概念</h2><p>一条 Azure 流水线由多个 Stage 组成，一个 Stage 由多个 Job 组成，一个 Job（运行在 Agent 上） 由多个 Step 组成，Step 可以是 Script 或 Task。</p><p><img loading=lazy src=https://olzhy.github.io/static/images/uploads/2022/04/azure-pipelines-key-concepts-overview.svg#center alt width=80%></p><p>下面看一下 Azure 流水线常用到的几个术语：</p><ul><li><p>Pipeline（流水线）</p><p>Pipeline 定义了应用的整个持续集成与部署流程，其由多个 Stage 组成。可将 Pipeline 认为成是一个定义如何执行构建、测试、部署等步骤的工作流。</p></li><li><p>Stage（阶段）</p><p>Stage 是流水线中的逻辑边界，可使用其将关注的部分进行分离（如分成构建，QA，部署等）。一个 Stage 由一个或多个 Job 组成。一个流水线中的多个 Stage 默认按顺序执行。我们可以指定 Stage 运行的条件。</p></li><li><p>Job（作业）</p><p>Job 表示一组 Step 执行的边界，其需要在 Agent 上运行，一个 Job 的所有 Step 均在同一个 Agent 上运行。一个 Stage 包含一个或多个 Job。</p></li><li><p>Step（步骤）</p><p>Step 是一条流水线最小的构建块，每一个 Step 可以是 Script，也可以是 Task。</p></li><li><p>Task（任务）</p><p>Task 是一条流水线中定义自动化的一个构建块。</p></li><li><p>Script（脚本）</p><p>Script 是流水线中使用命令行、PowerShell 或 Bash 来运行的代码。</p></li><li><p>Agent（代理）</p><p>Agent 为运行 Job 的基础环境。</p></li><li><p>Approvals（审批）</p><p>Approvals 为构建或部署前的一组校验，如用于控制发布到生产环境的手动审批校验。</p></li><li><p>Artifact（制品）</p><p>Artifact 为构建产生的一组包或文件，其用于后续的部署 Task。</p></li><li><p>Deployment（部署）</p><p>Deployment 为流水线中的部署 Job，即部署到一个目标环境的一组步骤。</p></li><li><p>Deployment group（部署组）</p><p>Deployment group 为一组安装代理的目标部署机器。</p></li><li><p>Environment（环境）</p><p>Environment 为托管应用的一组资源（如请求域名，虚拟机，容器等）。一条流水线可能在构建和测试完成后将应用部署到多个环境。</p></li><li><p>Run（运行）</p><p>Run 代表流水线的一次执行。其会收集与运行步骤相关的日志及测试结果。</p></li><li><p>Trigger（触发器）</p><p>Trigger 用来告诉流水线何时运行。Trigger 可以配置为由代码提交至仓库时、调度时间到来时或当另一个构建完成时。</p></li><li><p>Library（库）</p><p>库包括安全文件和变量组。安全文件是一种在多条流水线共享文件的方法。如在构建流水线将一个文件存储成 DevOps 级别，然后在部署流水线使用它。变量组是跨流水线传递值或密钥的方法。</p></li></ul><p>下面会详细看看如何使用这些基础功能。</p><h3 id=21-trigger>2.1 Trigger</h3><p>Trigger 即触发器，用于定义流水线的自动执行策略。有 CI/PR Trigger、定时 Trigger 和流水线完成 Trigger 三种类型。</p><ul><li><p>CI/PR Trigger</p><p>CI Trigger 或 PR Trigger 会因代码仓库的类型不同而有所差别。本文仅关注 Github 仓库的 Trigger 配置。</p><p>CI Trigger 用于指定当哪些分支或 Tag 有新的提交时触发流水线运行。</p><p>最简单的配置方式为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 仅`master`分支和`releases/*`分支有提交时触发构建</span>
<span style=color:#f92672>trigger</span>:
  - <span style=color:#ae81ff>master</span> <span style=color:#75715e># 指定分支名</span>
  - <span style=color:#ae81ff>releases/*</span> <span style=color:#75715e># 采用通配符</span>
</code></pre></div><p>稍微复杂点的配置方式为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 仅`master`分支和`releases/*`分支（`releases/old*`除外）有提交时触发构建</span>
<span style=color:#f92672>trigger</span>:
  <span style=color:#f92672>branches</span>:
    <span style=color:#f92672>include</span>:
      - <span style=color:#ae81ff>master</span>
      - <span style=color:#ae81ff>releases/*</span>
    <span style=color:#f92672>exclude</span>:
      - <span style=color:#ae81ff>releases/old*</span>
</code></pre></div><p>设置批量运行的配置方式：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 若团队成员提交频繁，可将流水线设置为 batch 运行，即待当前流水线运行完成后，再统一运行一次最新的提交</span>
<span style=color:#f92672>trigger</span>:
  <span style=color:#f92672>batch</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>branches</span>:
    <span style=color:#f92672>include</span>:
      - <span style=color:#ae81ff>master</span>
</code></pre></div><p>指定包含或排除的 Tag：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 若有`v2.*`的新 Tag（`v2.0`除外），即会触发构建</span>
<span style=color:#f92672>trigger</span>:
  <span style=color:#f92672>tags</span>:
    <span style=color:#f92672>include</span>:
      - <span style=color:#ae81ff>v2.*</span>
    <span style=color:#f92672>exclude</span>:
      - <span style=color:#ae81ff>v2.0</span>
</code></pre></div><p>PR Trigger 用于指定当哪些目标分支有新的 PR 时（或 PR 有更新时）触发流水线运行。</p><p>简单一点的配置如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 当如下分支有 PR 时会触发构建</span>
<span style=color:#f92672>pr</span>:
  - <span style=color:#ae81ff>master</span>
  - <span style=color:#ae81ff>develop</span>
  - <span style=color:#ae81ff>releases/*</span>
</code></pre></div><p>复杂一点的配置如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 当`master`分支与`releases/*`分支（`releases/old*`除外）有 PR 时会触发构建</span>
<span style=color:#f92672>pr</span>:
  <span style=color:#f92672>branches</span>:
    <span style=color:#f92672>include</span>:
      - <span style=color:#ae81ff>master</span>
      - <span style=color:#ae81ff>releases/*</span>
    <span style=color:#f92672>exclude</span>:
      - <span style=color:#ae81ff>releases/old*</span>
</code></pre></div></li><li><p>定时 Trigger</p><p>支持配置 Cron 表达式来定时触发流水线。Cron 表达式的时区采用 UTC 时间，若使用了模板，须将调度规则配置在主文件，不可配置在其它模板文件。</p><p>如下的例子定义了两个调度：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>schedules</span>:
  - <span style=color:#f92672>cron</span>: <span style=color:#e6db74>&#34;0 0 * * *&#34;</span> <span style=color:#75715e># 每天半夜构建，仅当自上次运行成功后有新的提交</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>Daily midnight build</span>
    <span style=color:#f92672>branches</span>:
      <span style=color:#f92672>include</span>:
        - <span style=color:#ae81ff>main</span>
        - <span style=color:#ae81ff>releases/*</span>
      <span style=color:#f92672>exclude</span>:
        - <span style=color:#ae81ff>releases/ancient/*</span>
  - <span style=color:#f92672>cron</span>: <span style=color:#e6db74>&#34;0 12 * * 0&#34;</span> <span style=color:#75715e># 每周日中午构建，不管自上次运行成功后有没有新的提交</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>Weekly Sunday build</span>
    <span style=color:#f92672>branches</span>:
      <span style=color:#f92672>include</span>:
        - <span style=color:#ae81ff>releases/*</span>
    <span style=color:#f92672>always</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>Cron 表达式的语法是业界通用的。</p><p>表达式字段意思如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>mm HH DD MM DW
\  \  \  \  \__ 一周中的哪一天，自周日（0）起
 \  \  \  \____ 月
  \  \  \______ 天
   \  \________ 时
    \__________ 分
</code></pre></div><p>复杂 Cron 示例（如下的几种写法等价）：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># 每周一、三、五18点触发
0 18 * * Mon,Wed,Fri
0 18 * * 1,3,5
0 18 * * 1-5/2
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># 每6小时触发一次
0 0,6,12,18 * * *
0 */6 * * *
0 0-18/6 * * *
</code></pre></div></li><li><p>流水线完成 Trigger</p><p>若想在一条流水线运行完成后触发另一条流水线。可以通过配置流水线资源实现。</p><p>下面示例了两条流水线，第一条流水线 security-lib-ci 运行完成时触发第二条流水线 app-ci：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 流水线 security-lib-ci</span>
<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>bash</span>: <span style=color:#ae81ff>echo &#34;The security-lib-ci pipeline runs first&#34;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 当指定分支的流水线 security-lib-ci 运行完成后会触发当前流水线 app-ci 运行</span>
<span style=color:#f92672>resources</span>:
  <span style=color:#f92672>pipelines</span>:
    - <span style=color:#f92672>pipeline</span>: <span style=color:#ae81ff>securitylib</span>
      <span style=color:#f92672>source</span>: <span style=color:#ae81ff>security-lib-ci</span> <span style=color:#75715e># 被当前流水线资源引用的流水线名</span>
      <span style=color:#f92672>project</span>: <span style=color:#ae81ff>FabrikamProject</span> <span style=color:#75715e># 仅当源流水线在别的项目时，需要指定项目名称</span>
      <span style=color:#f92672>trigger</span>: <span style=color:#75715e># 仅当源流水线的`releases/*`分支（`releases/old*`除外）完成运行时，触发当前流水线运行</span>
        <span style=color:#f92672>branches</span>:
          <span style=color:#f92672>include</span>:
            - <span style=color:#ae81ff>releases/*</span>
          <span style=color:#f92672>exclude</span>:
            - <span style=color:#ae81ff>releases/old*</span>

<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>bash</span>: <span style=color:#ae81ff>echo &#34;app-ci runs after security-lib-ci completes&#34;</span>
</code></pre></div><p>若想更加精确的指定源流水线的哪个阶段完成才触发当前流水线，可以参阅<a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/pipeline-triggers?view=azure-devops">文档</a>稍作配置即可实现。</p></li></ul><h3 id=22-task-及模板>2.2 Task 及模板</h3><p>Task 是定义管道中自动化的构建块。一个 Job 有一个或多个 Task，运行 Job 时，所有 Task 依次运行。Azure 流水线除了提供诸多内置的 Task 满足基本的构建与部署场景外，还支持创建自定义 Task。</p><ul><li><p>Task 版本</p><p>Task 是有版本号的，使用时需要指定主版本号。如您指定使用的 Task 的主版本为 1，那对应该主版本有新的次版本时（如 1.2），会自动使用最新的；但有另一个主版本 2 出现时，若非您显示指定，流水线使用的还是版本 1。</p><p>可在 Task 名后加@指定版本，示例如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>PublishTestResults@2</span>
</code></pre></div></li><li><p>Task 控制选项</p><p>Task 的控制选项可以用 Key/Value 的方式来指定。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>task</span>: <span style=color:#ae81ff>string</span> <span style=color:#75715e># 指定 Task 名和版本，如 VSBuild@1</span>
  <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>expression</span> <span style=color:#75715e># 运行条件，如设置为 succeededOrFailed()，表示不管前面步骤成功失败都运行这一步；设置为 failed()，表示只有前面步骤失败了才运行这一步；always() 表示无论如何要运行这一步</span>
  <span style=color:#f92672>continueOnError</span>: <span style=color:#ae81ff>boolean</span> <span style=color:#75715e># 若设置为 true，表示即使这一步失败了，后续步骤也应运行；默认为 false</span>
  <span style=color:#f92672>enabled</span>: <span style=color:#ae81ff>boolean</span> <span style=color:#75715e># 是否运行此步骤；默认为 true</span>
  <span style=color:#f92672>retryCountOnTaskFailure</span>: <span style=color:#ae81ff>number</span> <span style=color:#75715e># Task失败时，最大重试次数；默认值为 0</span>
  <span style=color:#f92672>timeoutInMinutes</span>: <span style=color:#ae81ff>number</span> <span style=color:#75715e># 最长等待时间</span>
  <span style=color:#f92672>target</span>: <span style=color:#ae81ff>string</span> <span style=color:#75715e># 主机或目标容器资源的名称</span>
</code></pre></div><p>Task 一般在 Agent 上运行，若指定<code>target</code>（可以是 host 或定义的容器资源），则会在指定的目标机器或容器上运行。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>resources</span>:
<span style=color:#f92672>containers</span>:
  - <span style=color:#f92672>container</span>: <span style=color:#ae81ff>pycontainer</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>python:3.8</span>

<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>SampleTask@1</span>
    <span style=color:#f92672>target</span>: <span style=color:#ae81ff>host</span>
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>AnotherTask@1</span>
    <span style=color:#f92672>target</span>: <span style=color:#ae81ff>pycontainer</span>
</code></pre></div></li><li><p>Task 环境变量</p><p>可以使用<code>env</code>属性来指定 Task 需要用到的环境变量。</p><p>如下示例分别使用 Scrpt 快捷语法和与其等价的 Task 语法来执行一条命令，命令中会用到环境变量<code>AZURE_DEVOPS_EXT_PAT</code>：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 使用 Script 快捷语法</span>
- <span style=color:#f92672>script</span>: <span style=color:#ae81ff>az pipelines variable-group list --output table</span>
  <span style=color:#f92672>env</span>:
    <span style=color:#f92672>AZURE_DEVOPS_EXT_PAT</span>: <span style=color:#ae81ff>$(System.AccessToken)</span>
  <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;List variable groups using the script step&#34;</span>

<span style=color:#75715e># 使用 Task 语法</span>
- <span style=color:#f92672>task</span>: <span style=color:#ae81ff>CmdLine@2</span>
  <span style=color:#f92672>inputs</span>:
    <span style=color:#f92672>script</span>: <span style=color:#ae81ff>az pipelines variable-group list --output table</span>
  <span style=color:#f92672>env</span>:
    <span style=color:#f92672>AZURE_DEVOPS_EXT_PAT</span>: <span style=color:#ae81ff>$(System.AccessToken)</span>
  <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;List variable groups using the command line task&#34;</span>
</code></pre></div></li></ul><p>模板可以用来定义可重用的逻辑，也可以用来控制流水线的安全性。</p><ul><li><p>模板作重用</p><p>可以将一些公共的 Job、Stage、Step 等抽取到模板，而在<code>azure-pipelines.yml</code>直接使用。</p><p>如下示例将 Job 抽取成模板，而在<code>azure-pipelines.yml</code>引用：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 文件：templates/npm-with-params.yml</span>
<span style=color:#f92672>parameters</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>name</span> <span style=color:#75715e># defaults for any parameters that aren&#39;t specified</span>
    <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#34;&#34;</span>
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>vmImage</span>
    <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#34;&#34;</span>

<span style=color:#f92672>jobs</span>:
  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>${{ parameters.name }}</span>
    <span style=color:#f92672>pool</span>:
      <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>${{ parameters.vmImage }}</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>npm install</span>
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>npm test</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 文件：azure-pipelines.yml</span>
<span style=color:#f92672>jobs</span>:
  - <span style=color:#f92672>template</span>: <span style=color:#ae81ff>templates/npm-with-params.yml</span> <span style=color:#75715e># Template reference</span>
    <span style=color:#f92672>parameters</span>:
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Linux</span>
      <span style=color:#f92672>vmImage</span>: <span style=color:#e6db74>&#34;ubuntu-latest&#34;</span>

  - <span style=color:#f92672>template</span>: <span style=color:#ae81ff>templates/npm-with-params.yml</span> <span style=color:#75715e># Template reference</span>
    <span style=color:#f92672>parameters</span>:
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>macOS</span>
      <span style=color:#f92672>vmImage</span>: <span style=color:#e6db74>&#34;macOS-latest&#34;</span>

  - <span style=color:#f92672>template</span>: <span style=color:#ae81ff>templates/npm-with-params.yml</span> <span style=color:#75715e># Template reference</span>
    <span style=color:#f92672>parameters</span>:
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Windows</span>
      <span style=color:#f92672>vmImage</span>: <span style=color:#e6db74>&#34;windows-latest&#34;</span>
</code></pre></div></li><li><p>模板作安全控制</p><p>为了提高安全性，可以强制流水线必须从特定的模板扩展。</p><p>如下示例会对非法的 Task 名作报错处理：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 文件：start.yml</span>
<span style=color:#f92672>parameters</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>buildSteps</span> <span style=color:#75715e># 参数名为 buildSteps</span>
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>stepList</span> <span style=color:#75715e># 数据类型为 StepList</span>
    <span style=color:#f92672>default</span>: [] <span style=color:#75715e># 默认值为空列表</span>
<span style=color:#f92672>stages</span>:
  - <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>secure_buildstage</span>
    <span style=color:#f92672>pool</span>:
      <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>windows-latest</span>
    <span style=color:#f92672>jobs</span>:
      - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>secure_buildjob</span>
        <span style=color:#f92672>steps</span>:
          - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo This happens before code</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Base: Pre-build&#34;</span>
          - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo Building</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Base: Build&#34;</span>

          - <span style=color:#ae81ff>${{ each step in parameters.buildSteps }}:</span>
              - <span style=color:#ae81ff>${{ each pair in step }}:</span>
                  <span style=color:#ae81ff>${{ if ne(pair.value, &#39;CmdLine@2&#39;) }}:</span>
                    <span style=color:#ae81ff>${{ pair.key }}: ${{ pair.value }}</span>
                  <span style=color:#ae81ff>${{ if eq(pair.value, &#39;CmdLine@2&#39;) }}:</span>
                    <span style=color:#75715e># 若使用 Task &#39;CmdLine@2&#39; 会抛错</span>
                    <span style=color:#f92672>&#34;${{ pair.value }}&#34;: </span><span style=color:#ae81ff>error</span>

          - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo This happens after code</span>
            <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Base: Signing&#34;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 文件：azure-pipelines.yml</span>
<span style=color:#f92672>trigger</span>:
  - <span style=color:#ae81ff>main</span>

<span style=color:#f92672>extends</span>:
  <span style=color:#f92672>template</span>: <span style=color:#ae81ff>start.yml</span>
  <span style=color:#f92672>parameters</span>:
    <span style=color:#f92672>buildSteps</span>:
      - <span style=color:#f92672>bash</span>: <span style=color:#ae81ff>echo Test</span> <span style=color:#75715e># 会被正常解析</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>succeed</span>
      - <span style=color:#f92672>bash</span>: <span style=color:#ae81ff>echo &#34;Test&#34;</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>succeed</span>
      <span style=color:#75715e># 这一步解析会报 YAML 语法错误 `Unexpected value &#39;CmdLine@2&#39;`</span>
      - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>CmdLine@2</span>
        <span style=color:#f92672>inputs</span>:
          <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo &#34;Script Test&#34;</span>
      <span style=color:#75715e># 这一步解析会报 YAML 语法错误 `Unexpected value &#39;CmdLine@2&#39;`</span>
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo &#34;Script Test&#34;</span>
</code></pre></div></li><li><p>模板抽到一个仓库</p><p>可以将模板文件抽取到一个仓库（类似 Jenkins 的<code>SharedLibrary</code>），供需要的工程使用。</p><p>如下示例<code>azure-pipelines.yml</code>引用另一个仓库的模板：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 仓库：Contoso/LinuxProduct</span>
<span style=color:#75715e># 文件：azure-pipelines.yml</span>
<span style=color:#f92672>resources</span>: <span style=color:#75715e># 配置模板所在的仓库信息</span>
  <span style=color:#f92672>repositories</span>:
    - <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>templates</span>
      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>github</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Contoso/BuildTemplates</span>
      <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>myServiceConnection</span> <span style=color:#75715e># 配置 Azure DevOps 服务连接信息</span>
      <span style=color:#f92672>ref</span>: <span style=color:#ae81ff>refs/tags/v1.0</span> <span style=color:#75715e># 配置引用的 Tag</span>

<span style=color:#f92672>jobs</span>:
  - <span style=color:#f92672>template</span>: <span style=color:#ae81ff>common.yml@templates</span> <span style=color:#75715e># 使用`文件@模板名`的方式引用模板</span>
</code></pre></div></li></ul><p>此外，关于模板参数类型，变量重用，模板表达式等更详细的配置，请参阅<a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops">文档</a>。</p><h3 id=23-job-及-stage>2.3 Job 及 Stage</h3><p>Job 是顺序运行的一系列步骤。</p><ul><li><p>Job 定义</p><p>如下是定义一个 Job 的完整语法：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>job</span>: <span style=color:#ae81ff>string </span> <span style=color:#75715e># Job名称 `[A-Za-z0-9_]`</span>
  <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>string </span> <span style=color:#75715e># UI 显示名称</span>
  <span style=color:#f92672>dependsOn</span>: <span style=color:#ae81ff>string | [ string ]</span>
  <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>string</span>
  <span style=color:#f92672>strategy</span>: <span style=color:#75715e># 注意：`parallel` 与 `matrix` 互斥，仅可指定一个</span>
    <span style=color:#f92672>parallel</span>: <span style=color:#75715e># 并行策略</span>
    <span style=color:#f92672>matrix</span>: <span style=color:#75715e># 矩阵策略</span>
    <span style=color:#f92672>maxParallel</span>: <span style=color:#ae81ff>number</span> <span style=color:#75715e># 仅针对 `matrix` 使用，最大并行数</span>
  <span style=color:#f92672>continueOnError</span>: <span style=color:#ae81ff>boolean </span> <span style=color:#75715e># 设置为 true，表示即使当前 Job 失败，也会继续运行后续 Job；默认为 false</span>
  <span style=color:#f92672>pool</span>: <span style=color:#ae81ff>pool</span> <span style=color:#75715e># Agent 池</span>
  <span style=color:#f92672>workspace</span>:
    <span style=color:#f92672>clean</span>: <span style=color:#ae81ff>outputs | resources | all</span> <span style=color:#75715e># Job 运行前是否清除工作空间</span>
  <span style=color:#f92672>container</span>: <span style=color:#ae81ff>containerReference</span> <span style=color:#75715e># 指定运行该 Job 的容器</span>
  <span style=color:#f92672>timeoutInMinutes</span>: <span style=color:#ae81ff>number</span> <span style=color:#75715e># 自动终止前的最长运行时间</span>
  <span style=color:#f92672>cancelTimeoutInMinutes</span>: <span style=color:#ae81ff>number</span> <span style=color:#75715e># 在终止任务之前，给“即使任务被取消，也要始终运行的Job”多少时间</span>
  <span style=color:#f92672>variables</span>: { <span style=color:#f92672>string</span>: <span style=color:#ae81ff>string } | [ variable | variableReference ]</span>
  <span style=color:#f92672>steps</span>: [ <span style=color:#ae81ff>script | bash | pwsh | powershell | checkout | task | templateReference ]</span>
  <span style=color:#f92672>services</span>: { <span style=color:#f92672>string</span>: <span style=color:#ae81ff>string | container }</span> <span style=color:#75715e># 作为服务容器运行的容器资源</span>
  <span style=color:#f92672>uses</span>: <span style=color:#75715e># 此作业所需的尚未引用的任何资源（仓库或池）</span>
    <span style=color:#f92672>repositories</span>: [ <span style=color:#ae81ff>string ]</span> <span style=color:#75715e># 引用 Azure Git 仓库</span>
    <span style=color:#f92672>pools</span>: [ <span style=color:#ae81ff>string ]</span> <span style=color:#75715e># 池名称，一般在使用矩阵策略时会用到</span>
</code></pre></div><p>若 Job 的主要工作是部署（非构建或测试），可以使用一个叫做 Deployment 的特殊 Job。</p><p>示例如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>deployment</span>: <span style=color:#ae81ff>string</span> <span style=color:#75715e># 取代 job，使用 deployment 关键字</span>
  <span style=color:#f92672>pool</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>string</span>
    <span style=color:#f92672>demands</span>: <span style=color:#ae81ff>string | [ string ]</span>
  <span style=color:#f92672>environment</span>: <span style=color:#ae81ff>string</span>
  <span style=color:#f92672>strategy</span>:
    <span style=color:#f92672>runOnce</span>:
      <span style=color:#f92672>deploy</span>:
        <span style=color:#f92672>steps</span>:
          - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo Hi!</span>
</code></pre></div></li><li><p>Job 的类型</p><p>Job 有几种类型，用于区分在哪里运行，分别为：Agent Job、Server Job 和 Container Job。</p><p>Agent Job 为最常见的 Job 类型，它们在 Agent 池中的 Agent 上运行。当使用 Microsoft 托管的 Agent 时，流水线中的每个 Job 都会获得一个新的 Agent。若使用自托管 Agent 的来满足特定 Job 的需求时，根据 Agent 的数目多少，Job 可能会使用到相同的 Agent。Job 默认为 Agent 类型。</p><p>Server Job 在服务器上运行，不需要 Agent 或任何目标机器。目前，仅少数 Task 支持在 Server Job 执行。不需要 Agent 的 Task 有：Azure 函数调用任务、REST API 调用任务、手动校验任务和查询工作项任务等。</p><p>如下示例指定一个 Server Job：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>jobs</span>:
  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>somejob</span>
    <span style=color:#f92672>pool</span>: <span style=color:#ae81ff>server</span>
</code></pre></div></li><li><p>Job 的依赖与条件</p><p>可以指定 Job 运行的依赖及条件。</p><p>示例如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># Job B 依赖 Job A，仅当 Job A 运行成功并且分支为 master 时才运行 Job B</span>
<span style=color:#f92672>jobs</span>:
  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>A</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo hello</span>

  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>B</span>
    <span style=color:#f92672>dependsOn</span>: <span style=color:#ae81ff>A</span>
    <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>and(succeeded(), eq(variables[&#39;build.sourceBranch&#39;], &#39;refs/heads/master&#39;))</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo this only runs for master</span>
</code></pre></div></li><li><p>Job 的工作空间</p><p>当运行 Agent Job 时，其会在 Agent 上创建一个工作区。工作区是一个文件夹，流水线在其中下载代码，运行步骤及输出结果。可以在流水线中引用工作区目录。</p><p>其中，<code>Build.SourcesDirectory</code>表示源码下载目录；<code>Build.ArtifactStagingDirectory</code>为下载制品的目录及生成制品在发布前的目录；<code>Build. BinariesDirectory</code>为输出文件的目录；<code>Common.TestResultsDirectory</code>为上传测试结果的目录。</p><p>前面已提到，工作区清理选项只对自托管 Agent 适用；对于 Microsoft 托管的 Agent，Job 每次运行使用的是一个新的 Agent。</p><p>工作区清理的配置如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 工作区清理选项，只对自托管 Agent 适用</span>
- <span style=color:#f92672>job</span>: <span style=color:#ae81ff>myJob</span>
  <span style=color:#f92672>workspace</span>:
    <span style=color:#f92672>clean</span>: <span style=color:#ae81ff>outputs | resources | all</span> <span style=color:#75715e># Job 运行前，需要清理的内容</span>
</code></pre></div></li><li><p>Job 中的制品下载</p><p>如下示例有<code>Build</code>与<code>Deploy</code>两个 Job，分别作制品上传与制品下载。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 将 Build 作业中构建的制品命名为 `WebSite` 并发布到工作区，然后在 Deploy 作业中下载它</span>
<span style=color:#f92672>jobs</span>:
  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>Build</span>
    <span style=color:#f92672>pool</span>:
      <span style=color:#f92672>vmImage</span>: <span style=color:#e6db74>&#34;ubuntu-latest&#34;</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>npm test</span>
      - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>PublishBuildArtifacts@1</span>
        <span style=color:#f92672>inputs</span>:
          <span style=color:#f92672>pathtoPublish</span>: <span style=color:#e6db74>&#34;$(System.DefaultWorkingDirectory)&#34;</span>
          <span style=color:#f92672>artifactName</span>: <span style=color:#ae81ff>WebSite</span>

  <span style=color:#75715e># 仅当 Build Job 构建成功，才会下载并部署制品</span>
  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>Deploy</span>
    <span style=color:#f92672>pool</span>:
      <span style=color:#f92672>vmImage</span>: <span style=color:#e6db74>&#34;ubuntu-latest&#34;</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>checkout</span>: <span style=color:#ae81ff>none</span> <span style=color:#75715e># 跳过默认检出仓库内容</span>
      - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>DownloadBuildArtifacts@0</span>
        <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Download Build Artifacts&#34;</span>
        <span style=color:#f92672>inputs</span>:
          <span style=color:#f92672>artifactName</span>: <span style=color:#ae81ff>WebSite</span>
          <span style=color:#f92672>downloadPath</span>: <span style=color:#ae81ff>$(System.DefaultWorkingDirectory)</span>

    <span style=color:#f92672>dependsOn</span>: <span style=color:#ae81ff>Build</span>
    <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>succeeded()</span>
</code></pre></div></li><li><p>使用容器 Job</p><p>默认情况下，Job 在安装了 Agent 的主机上运行。若想自己控制 Job 运行的环境，可以使用容器 Job。</p><p>下面看一个简单的示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># 从 Docker Hub 获取版本为 18.04 的 ubuntu 镜像，然后启动容器，完成后在其中使用 printenv 命令。</span>
<span style=color:#f92672>pool</span>:
<span style=color:#f92672>vmImage</span>: <span style=color:#e6db74>&#34;ubuntu-18.04&#34;</span>

<span style=color:#f92672>container</span>: <span style=color:#ae81ff>ubuntu:18.04</span>

<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>printenv</span>
</code></pre></div></li><li><p>使用 Stage</p><p>可以将流水线 Job 组织成 Stage。Stage 是流水线中的逻辑边界，如：构建、测试、部署到测试环境及部署到生产环境是现实运用中常见的 Stage。</p><p>指定一个 Stage 的完整语法如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>stages</span>:
  - <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>string </span> <span style=color:#75715e># Stage 名称，支持`[A-Za-z0-9_]`</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>string </span> <span style=color:#75715e># UI 展示名称</span>
    <span style=color:#f92672>dependsOn</span>: <span style=color:#ae81ff>string | [ string ]</span> <span style=color:#75715e># 指定依赖的 Stage</span>
    <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>string</span> <span style=color:#75715e># 指定依赖的 Stage 的条件，如 failed() 等</span>
    <span style=color:#f92672>pool</span>: <span style=color:#ae81ff>string | pool</span> <span style=color:#75715e># 若在 Stage 上指定了 pool，除非在 Job 中覆盖该选项，否则所有该 Stage 下的 Job 都会使用所指定的 pool</span>
    <span style=color:#f92672>variables</span>: { <span style=color:#f92672>string</span>: <span style=color:#ae81ff>string } | [ variable | variableReference ]</span>
    <span style=color:#f92672>jobs</span>: [ <span style=color:#ae81ff>job | templateReference]</span>
</code></pre></div></li><li><p>Deployment Job</p><p>建议将部署类的步骤放在一个称为 Deployment 的特殊 Job 中。使用 Deployment 的益处有：可以获得流水线的部署历史以及特定的资源和部署状态，以便进行审核；可以自定义部署策略，如应用的升级方式（目前支持<code>runOnce</code>、<code>rolling</code>和<code>canary</code>三种升级方式）。</p><p>此外，Deployment Job 还有些限制：不自动克隆代码仓库（若需检出代码，需要指定<code>checkout: self</code>，且 Deployment Job 仅支持一次检出）。</p><p>定义一个 Deployment Job 的完整语法如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>jobs:
  - deployment: string # 名称，支持`[A-Za-z0-9_]`
    displayName: string # UI 显示名称
    pool: # 对虚拟机资源是不需要的
      name: string # 池名称
      demands: string | [ string ]
    workspace:
      clean: outputs | resources | all # Job 运行前需要清理什么
    dependsOn: string
    condition: string
    continueOnError: boolean # 若为 true，表示即使该Job失败，也要运行其它的 Job；默认为 false
    container: containerReference # 运行该 Job 的容器
    services: { string: string | container } # 作为服务容器运行的容器资源
    timeoutInMinutes: nonEmptyString # 自动终止前的最长等待时间
    cancelTimeoutInMinutes: nonEmptyString # 在终止任务前，给“即使任务被取消，也要运行”的 Job 多长时间
    variables: # 变量
    environment: string # 目标环境名及记录部署历史的资源名（可选）； 格式为：&lt;environment-name&gt;.&lt;resource-name&gt;
    strategy:
      runOnce: # 部署策略，除了 runOnce 还支持 rolling 和 canary
        deploy:
          steps: [ script | bash | pwsh | powershell | checkout | task | templateReference ]
</code></pre></div><p>如下是一个使用 Deployment Job 将应用部署到 Kubernetes 的示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>jobs:
  - deployment: DeployWeb
    displayName: deploy Web App
    pool:
      vmImage: &#34;ubuntu-latest&#34;
    environment: &#34;smarthotel-dev.bookings&#34;
    strategy:
      runOnce:
        deploy:
          steps:
            # 无须显示传递连接信息
            - task: KubernetesManifest@0
              displayName: Deploy to Kubernetes cluster
              inputs:
                action: deploy
                namespace: $(k8sNamespace)
                manifests: |
                  $(System.ArtifactsDirectory)/manifests/*
                imagePullSecrets: |
                  $(imagePullSecret)
                containers: |
                  $(containerRegistry)/$(imageRepository):$(tag)
</code></pre></div></li><li><p>装饰器</p><p>使用装饰器可以为每个 Job 的开头和结尾自动注入额外的步骤。如：可以使用装饰器自动对整个团队流水线的构建输出作病毒扫描。</p><p>关于如何开发、安装及使用装饰器，请参阅<a href="https://docs.microsoft.com/en-us/azure/devops/extend/develop/add-pipeline-decorator?toc=%2Fazure%2Fdevops%2Fpipelines%2Ftoc.json&bc=%2Fazure%2Fdevops%2Fpipelines%2Fbreadcrumb%2Ftoc.json&view=azure-devops">文档</a>。</p></li></ul><h3 id=24-library变量与安全文件>2.4 Library、变量与安全文件</h3><ul><li><p>Library</p><p>Library 是 Azure DevOps 存放构建和发布资产的地方。可以使用安全模型配置哪些人可以创建或使用相应的资产。</p></li><li><p>变量</p><p>变量有预定义变量（如系统变量）、环境变量和用户自定义变量三种。</p><p>预定义变量也可用作环境变量使用，如预定义变量<code>Build.ArtifactStagingDirectory</code>的环境变量名为<code>BUILD_ARTIFACTSTAGINGDIRECTORY</code>。关于预定义变量有哪些，请参阅<a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops">文档</a>。</p><p>看一个用户自定义变量的例子：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>variables</span>:
  <span style=color:#f92672>VMS_USER</span>: <span style=color:#ae81ff>$(vmsUser)</span>
  <span style=color:#f92672>VMS_PASS</span>: <span style=color:#ae81ff>$(vmsAdminPass)</span>

<span style=color:#f92672>pool</span>:
  <span style=color:#f92672>vmImage</span>: <span style=color:#e6db74>&#34;ubuntu-latest&#34;</span>

<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>AzureFileCopy@4</span>
    <span style=color:#f92672>inputs</span>:
      <span style=color:#f92672>SourcePath</span>: <span style=color:#e6db74>&#34;my/path&#34;</span>
      <span style=color:#f92672>azureSubscription</span>: <span style=color:#e6db74>&#34;my-subscription&#34;</span>
      <span style=color:#f92672>Destination</span>: <span style=color:#e6db74>&#34;AzureVMs&#34;</span>
      <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;my-storage&#34;</span>
      <span style=color:#f92672>resourceGroup</span>: <span style=color:#e6db74>&#34;my-rg&#34;</span>
      <span style=color:#f92672>vmsAdminUserName</span>: <span style=color:#ae81ff>$(VMS_USER)</span>
      <span style=color:#f92672>vmsAdminPassword</span>: <span style=color:#ae81ff>$(VMS_PASS)</span>
</code></pre></div><p>其它复杂点的使用方式，请参阅<a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops">文档</a>。</p></li><li><p>使用变量组中的密钥</p><p>可以在变量组中创建密钥类和非密钥类的变量，然后在流水线中使用。</p><p>下面是一个使用参数和变量（包括自定义变量和系统变量）的示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>parameters</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Pool image&#34;</span>
    <span style=color:#f92672>default</span>: <span style=color:#ae81ff>ubuntu-latest</span>
    <span style=color:#f92672>values</span>:
      - <span style=color:#ae81ff>windows-latest</span>
      - <span style=color:#ae81ff>ubuntu-latest</span>
      - <span style=color:#ae81ff>macOS-latest</span>
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>Run Tests?</span>
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>boolean</span>
    <span style=color:#f92672>default</span>: <span style=color:#66d9ef>false</span>

<span style=color:#f92672>variables</span>:
  - <span style=color:#f92672>group</span>: <span style=color:#e6db74>&#34;Contoso Variable Group&#34;</span>
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>va</span>
    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>$[variables.a]</span>
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>vcontososecret</span>
    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>$[variables.contososecret]</span>

<span style=color:#f92672>trigger</span>:
  - <span style=color:#ae81ff>master</span>

<span style=color:#f92672>pool</span>:
  <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>ubuntu-latest</span>

<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>script</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>      echo &#34;Hello, world!&#34;
</span><span style=color:#e6db74>      echo &#34;Pool image: ${{ parameters.image }}&#34;
</span><span style=color:#e6db74>      echo &#34;Run tests? ${{ parameters.test }}&#34;</span>      
    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Show runtime parameter values&#34;</span>

  - <span style=color:#f92672>script</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>      echo &#34;a=$(va)&#34;
</span><span style=color:#e6db74>      echo &#34;b=$(vb)&#34;
</span><span style=color:#e6db74>      echo &#34;contososecret=$(vcontososecret)&#34;
</span><span style=color:#e6db74>      echo
</span><span style=color:#e6db74>      echo &#34;Count up to the value of the variable group&#39;s nonsecret variable *a*:&#34;
</span><span style=color:#e6db74>      for number in {1..$(va)}
</span><span style=color:#e6db74>        do
</span><span style=color:#e6db74>            echo &#34;$number&#34;
</span><span style=color:#e6db74>        done
</span><span style=color:#e6db74>      echo &#34;Count up to the value of the variable group&#39;s secret variable *contososecret*:&#34;
</span><span style=color:#e6db74>      for number in {1..$(vcontososecret)}
</span><span style=color:#e6db74>      do
</span><span style=color:#e6db74>          echo &#34;$number&#34;
</span><span style=color:#e6db74>      done</span>      
    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Test variable group variables (secret and nonsecret)&#34;</span>
    <span style=color:#f92672>env</span>:
      <span style=color:#f92672>SYSTEM_ACCESSTOKEN</span>: <span style=color:#ae81ff>$(System.AccessToken)</span>
</code></pre></div></li><li><p>设置变量</p><p>通常会有在一个 Stage（或 Job 与 Task）设置一个变量值，然后在后续的 Stage（或 Job 与 Task） 使用的场景。变量设置可通过<code>task.setvariable</code>实现。</p><p>下面看一下示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># Job A 设置变量 `myOutputVar=this is from job A`，然后在 Job B 打印
jobs:
- job: A
  steps:
  - bash: |
    echo &#34;##vso[task.setvariable variable=myOutputVar;isoutput=true]this is from job A&#34;
    name: passOutput
- job: B
  dependsOn: A
  variables:
    myVarFromJobA: $[ dependencies.A.outputs[&#39;passOutput.myOutputVar&#39;] ]
  steps:
  - bash: |
    echo $(myVarFromJobA)
</code></pre></div></li><li><p>运行时参数</p><p>使用运行时参数可以控制传入流水线的参数值。</p><p>如下示例将 Trigger 设置为 none，只允许用户手动触发流水线，触发时需要选择具体的参数：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>parameters</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>Pool Image</span>
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
    <span style=color:#f92672>default</span>: <span style=color:#ae81ff>ubuntu-latest</span> <span style=color:#75715e># 若用户未选择具体的参数，会使用该默认值</span>
    <span style=color:#f92672>values</span>:
      - <span style=color:#ae81ff>windows-latest</span>
      - <span style=color:#ae81ff>ubuntu-latest</span>
      - <span style=color:#ae81ff>macOS-latest</span>

<span style=color:#f92672>trigger</span>: <span style=color:#ae81ff>none</span>

<span style=color:#f92672>jobs</span>:
  - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>build</span>
    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>build</span>
    <span style=color:#f92672>pool</span>:
      <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>${{ parameters.image }}</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#f92672>script</span>: <span style=color:#ae81ff>echo building $(Build.BuildNumber) with ${{ parameters.image }}</span>
</code></pre></div><p><img loading=lazy src=https://olzhy.github.io/static/images/uploads/2022/04/azure-pipelines-runtime-param-ui.png#center alt width=80%></p></li><li><p>使用 Azure Key Vault 密钥</p><p>Azure Key Vault 提供 API Key、密钥和证书等敏感信息管理。</p><p>可以使用 Azure 命令（<code>az keyvault</code>）或直接在页面设置密钥信息。然后在流水线使用需要的密钥值。</p><p>示例如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>trigger</span>:
  - <span style=color:#ae81ff>main</span>

<span style=color:#f92672>pool</span>:
  <span style=color:#f92672>vmImage</span>: <span style=color:#ae81ff>ubuntu-latest</span>

<span style=color:#f92672>steps</span>:
  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>AzureKeyVault@2</span>
    <span style=color:#f92672>inputs</span>:
      <span style=color:#f92672>azureSubscription</span>: <span style=color:#e6db74>&#34;Your-Azure-Subscription&#34;</span>
      <span style=color:#f92672>KeyVaultName</span>: <span style=color:#e6db74>&#34;Your-Key-Vault-Name&#34;</span>
      <span style=color:#f92672>SecretsFilter</span>: <span style=color:#e6db74>&#34;*&#34;</span>
      <span style=color:#f92672>RunAsPreJob</span>: <span style=color:#66d9ef>false</span>

  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>CmdLine@2</span>
    <span style=color:#f92672>inputs</span>:
      <span style=color:#f92672>script</span>: <span style=color:#e6db74>&#34;echo $(Your-Secret-Name) &gt; secret.txt&#34;</span>

  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>CopyFiles@2</span>
    <span style=color:#f92672>inputs</span>:
      <span style=color:#f92672>Contents</span>: <span style=color:#ae81ff>secret.txt</span>
      <span style=color:#f92672>targetFolder</span>: <span style=color:#e6db74>&#34;$(Build.ArtifactStagingDirectory)&#34;</span>

  - <span style=color:#f92672>task</span>: <span style=color:#ae81ff>PublishBuildArtifacts@1</span>
    <span style=color:#f92672>inputs</span>:
      <span style=color:#f92672>PathtoPublish</span>: <span style=color:#e6db74>&#34;$(Build.ArtifactStagingDirectory)&#34;</span>
      <span style=color:#f92672>ArtifactName</span>: <span style=color:#e6db74>&#34;drop&#34;</span>
      <span style=color:#f92672>publishLocation</span>: <span style=color:#e6db74>&#34;Container&#34;</span>
</code></pre></div><p>关于 Azure Key Vault 的使用及策略设置，请查阅<a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/key-vault-in-own-project?view=azure-devops">文档</a>。</p></li></ul><h3 id=25-审批检查与门禁>2.5 审批、检查与门禁</h3><p>可以在一条流水线的任意 Stage 前后插入审批和门禁来控制其工作流。</p><p>审批与门禁的设置需要在 UI 上进行，详情请参阅<a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deploy-using-approvals?view=azure-devops">文档</a>。</p><p>如下是一个配置等待手动校验的示例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text># 等待手动校验
pool:
  vmImage: ubuntu-latest

jobs:
  - job: waitForValidation
    displayName: Wait for external validation
    pool: server
    timeoutInMinutes: 4320 # Job 最长3天超时
    steps:
      - task: ManualValidation@0
        timeoutInMinutes: 1440 # Task 最长1天超时
        inputs:
          notifyUsers: |
            someone@example.com
          instructions: &#34;Please validate the build configuration and resume&#34;
          onTimeout: &#34;resume&#34;
</code></pre></div><p>综上，我们对 Azure 流水线的基础概念及 YAML 配置方式有了一个整体的了解。后面通过一些真实场景的项目实践，相信会对其有更好的掌握。</p><blockquote><p>参考资料</p><p>[1] <a href=https://docs.microsoft.com/en-us/azure/devops/pipelines/>Azure Pipelines documentation</a></p><p>[2] <a href=https://azure.microsoft.com/en-us/services/devops/pipelines/>Azure Pipelines</a></p></blockquote></div><div class=content-footer><div class=post-tags><a href=/tags/devops/>#DevOps</a></div></div></div><div class="col-lg-8 mx-auto block shadow"><h3>相关文章</h3><ul><li><a href=/posts/azure-devops-services.html>Azure DevOps 服务学习总结</a></li><li><a href=/posts/devops-for-modern-mainframe.html>如何对现代大型机（Mainframe）做 DevOps？</a></li><li><a href=/posts/what-is-devops.html>一文了解什么是 DevOps</a></li></ul></div><div class="col-lg-8 mx-auto block shadow"><div align=center><table><tr><b style=color:#e8505b>我的文章帮助到了您？想请我喝点东西，以支持我更好的写作？<a href=/thanks>Thanks!</a></b></tr><tr><td align=center><b>微信</b></td><td></td><td></td><td></td><td></td><td align=center><b>支付宝</b></td></tr><tr><td><img src=/static/images/self/wechat.png style=width:120px;height:120px></td><td></td><td></td><td></td><td></td><td><img src=/static/images/self/alipay.png style=width:120px;height:120px></td></tr></table></div></div><script src=https://utteranc.es/client.js repo=olzhy/olzhy.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></section><footer class="py-4 bg-lights border-top"><div class=container><div class="row justify-content-between text-center align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/leetcode-golang-implementations>LeetCode</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/about>关于本站</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/links>友情链接</a></li></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a title=文章归档 href=/archives/><i class=ti-archive></i></a></li><li class=list-inline-item><a title=文章标签 href=/tags/><i class=ti-tag></i></a></li><li class=list-inline-item><a title="我的 GitHub" href=https://github.com/olzhy><i class=ti-github></i></a></li><li class=list-inline-item><a title="网站 RSS" href=/index.xml><i class=ti-rss></i></a></li></ul></div></div><div class="text-center mt-4"><span>Made with <a href=https://gohugo.io/>Hugo</a> | Theme <a href=https://github.com/themefisher/northendlab-hugo>NorthendLab</a> | <a href=https://beian.miit.gov.cn>辽ICP备2022012085号-1</a> | Copyright © 2017-2023</span></div></div></footer><script>var indexURL="https://olzhy.github.io/index.json"</script><script src=https://olzhy.github.io/js/jquery.min.js></script><script src=https://olzhy.github.io/js/bootstrap.min.js></script><script src=https://olzhy.github.io/js/fuse.min.js></script><script src=https://olzhy.github.io/js/mark.js></script><script src=https://olzhy.github.io/js/search.js></script><script src=https://olzhy.github.io/js/script.min.js></script></body></html>