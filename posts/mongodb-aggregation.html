<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>对比 SQL 来学习 MongoDB 的聚合操作 - 磊磊落落</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=keywords content="MongoDB,聚合操作,聚合查询"><meta name=description content="本文以对比 SQL 的方式来学习 MongoDB 的聚合操作。"><meta name=author content="磊磊落落"><meta name=generator content="Hugo 0.123.7"><link rel=stylesheet href=https://leileiluoluo.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://leileiluoluo.github.io/css/themify-icons.css><link rel=stylesheet href=https://leileiluoluo.github.io/css/larry-custom-v1.6.css><link rel=stylesheet href=https://leileiluoluo.github.io/scss/style.min.css media=screen><link rel="shortcut icon" href=https://leileiluoluo.github.io/images/favicon.png type=image/x-icon><link rel=icon href=https://leileiluoluo.github.io/images/favicon.png type=image/x-icon><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?526723b767317055572c85bdb445353c",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://leileiluoluo.github.io/>磊磊落落</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/></a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/>计算机</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E9%9A%8F%E7%AC%94/>随笔</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%AF%BB%E4%B9%A6/>读书</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%A7%82%E5%BD%B1/>观影</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E7%BB%83%E5%AD%97/>练字</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/about>关于</a></li></ul><div class=search><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=https://leileiluoluo.github.io//search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder=键入关键字后回车...></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h1>对比 SQL 来学习 MongoDB 的聚合操作</h1><div class="mb-3 post-meta">2023年02月17日
<a href=/categories/%e8%ae%a1%e7%ae%97%e6%9c%ba>计算机</a></div><div class="content mb-5"><h2 id=1-聚合流水线概念>1 聚合流水线概念</h2><p>MongoDB 聚合流水线用于处理文档，其由一个或多个阶段（Stage）组成。每个阶段会对文档执行一类操作，一个阶段输出的文档会传递到下一个阶段，使用聚合流水线可以对文档进行过滤、分组和聚合计算（如计算平均值、最大值、最小值或总值）。除了进行聚合查询以外，自 MongoDB 4.2 版本起，还可以使用聚合流水线来进行文档更新。</p><p><em>注意：使用<code>db.collection.aggregate()</code>方法运行聚合流水线时，除非该流水线包含<code>$merge</code>或<code>$out</code>阶段，否则不会更改集合中的文档。</em></p><h2 id=2-准备数据>2 准备数据</h2><p>对比 SQL 来学习 MongoDB 的聚合操作会比较容易理解。该部分会准备一下数据，以方便后面的对比学习。</p><p>考虑有一张用于存放手机信息的表 <code>phones</code>，其有字段 <code>id</code>（主键）、<code>name</code>（名称）、<code>type</code>（类型）、<code>price</code>（价格）、<code>quantiy</code>（数量）和<code>published_at</code>（发布时间）这几个字段。</p><p><code>phones</code> 表的建表语句如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TABLE</span><span style=color:#bbb> </span>phones<span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>id<span style=color:#bbb> </span><span style=color:#0086b3>serial</span>,<span style=color:#bbb>              </span><span style=color:#998;font-style:italic>-- 主键
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>	</span>name<span style=color:#bbb> </span><span style=color:#0086b3>varchar</span>(<span style=color:#099>100</span>),<span style=color:#bbb>      </span><span style=color:#998;font-style:italic>-- 名称
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>	</span><span style=color:#000;font-weight:700>type</span><span style=color:#bbb> </span><span style=color:#0086b3>varchar</span>(<span style=color:#099>10</span>),<span style=color:#bbb>       </span><span style=color:#998;font-style:italic>-- 类型（standard 或 plus）
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>	</span>price<span style=color:#bbb> </span><span style=color:#0086b3>int</span>,<span style=color:#bbb>              </span><span style=color:#998;font-style:italic>-- 价格
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>	</span>quantity<span style=color:#bbb> </span><span style=color:#0086b3>int</span>,<span style=color:#bbb>           </span><span style=color:#998;font-style:italic>-- 数量
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>	</span>published_at<span style=color:#bbb> </span><span style=color:#000;font-weight:700>timestamp</span>,<span style=color:#bbb> </span><span style=color:#998;font-style:italic>-- 发布时间
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>	</span><span style=color:#000;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>KEY</span><span style=color:#bbb> </span>(id)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>给 <code>phones</code> 表插入 10 条数据，命令如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>INTO</span><span style=color:#bbb> </span>phones<span style=color:#bbb> </span>(name,<span style=color:#bbb> </span><span style=color:#000;font-weight:700>type</span>,<span style=color:#bbb> </span>price,<span style=color:#bbb> </span>quantity,<span style=color:#bbb> </span>published_at)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>VALUES</span><span style=color:#bbb> </span>(<span style=color:#d14>&#39;Apple&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;plus&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>7000</span>,<span style=color:#bbb> </span><span style=color:#099>10</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-01-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;Apple&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;standard&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>6000</span>,<span style=color:#bbb> </span><span style=color:#099>10</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-01-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;XIAOMI&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;plus&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>3000</span>,<span style=color:#bbb> </span><span style=color:#099>30</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-02-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;XIAOMI&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;standard&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>2000</span>,<span style=color:#bbb> </span><span style=color:#099>30</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-02-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;OPPO&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;plus&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>2000</span>,<span style=color:#bbb> </span><span style=color:#099>20</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-03-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;OPPO&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;standard&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>1000</span>,<span style=color:#bbb> </span><span style=color:#099>20</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-03-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;HUAWEI&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;plus&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>5000</span>,<span style=color:#bbb> </span><span style=color:#099>40</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-04-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;HUAWEI&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;standard&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>4000</span>,<span style=color:#bbb> </span><span style=color:#099>40</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-04-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;VIVO&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;plus&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>3000</span>,<span style=color:#bbb> </span><span style=color:#099>50</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-05-16 16:08:00&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>(<span style=color:#d14>&#39;VIVO&#39;</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;standard&#39;</span>,<span style=color:#bbb> </span><span style=color:#099>2000</span>,<span style=color:#bbb> </span><span style=color:#099>50</span>,<span style=color:#bbb> </span><span style=color:#d14>&#39;2023-05-16 16:08:00&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>使用 MongoShell 在 MongoDB 插入与如上命令相同的 10 条数据，命令如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>db.phones.insertMany<span style=color:#000;font-weight:700>(</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 1, name: <span style=color:#d14>&#34;Apple&#34;</span>, type: <span style=color:#d14>&#34;plus&#34;</span>, price: 7000,
</span></span><span style=display:flex><span>     quantity: 10, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-01-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 2, name: <span style=color:#d14>&#34;Apple&#34;</span>, type: <span style=color:#d14>&#34;standard&#34;</span>, price: 6000,
</span></span><span style=display:flex><span>     quantity: 10, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-01-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 3, name: <span style=color:#d14>&#34;XIAOMI&#34;</span>, type: <span style=color:#d14>&#34;plus&#34;</span>, price: 3000,
</span></span><span style=display:flex><span>     quantity: 30, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-02-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 4, name: <span style=color:#d14>&#34;XIAOMI&#34;</span>, type: <span style=color:#d14>&#34;standard&#34;</span>, price: 2000,
</span></span><span style=display:flex><span>     quantity: 30, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-02-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 5, name: <span style=color:#d14>&#34;OPPO&#34;</span>, type: <span style=color:#d14>&#34;plus&#34;</span>, price: 2000,
</span></span><span style=display:flex><span>     quantity: 20, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-03-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 6, name: <span style=color:#d14>&#34;OPPO&#34;</span>, type: <span style=color:#d14>&#34;standard&#34;</span>, price: 1000,
</span></span><span style=display:flex><span>     quantity: 20, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-03-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 7, name: <span style=color:#d14>&#34;HUAWEI&#34;</span>, type: <span style=color:#d14>&#34;plus&#34;</span>, price: 5000,
</span></span><span style=display:flex><span>     quantity: 40, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-04-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 8, name: <span style=color:#d14>&#34;HUAWEI&#34;</span>, type: <span style=color:#d14>&#34;standard&#34;</span>, price: 4000,
</span></span><span style=display:flex><span>     quantity: 40, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-04-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 9, name: <span style=color:#d14>&#34;VIVO&#34;</span>, type: <span style=color:#d14>&#34;plus&#34;</span>, price: 3000,
</span></span><span style=display:flex><span>     quantity: 50, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-05-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>{</span> _id: 10, name: <span style=color:#d14>&#34;VIVO&#34;</span>, type: <span style=color:#d14>&#34;standard&#34;</span>, price: 2000,
</span></span><span style=display:flex><span>     quantity: 50, published_at: ISODate<span style=color:#000;font-weight:700>(</span> <span style=color:#d14>&#34;2023-05-16T16:08:00Z&#34;</span> <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>数据准备完成，下面会使用对比 SQL 语句的方式来学习 MongoDB 的聚合流水线知识。</p><h2 id=3-对比-sql-来学习使用聚合流水线>3 对比 SQL 来学习使用聚合流水线</h2><p>本部分以出问题的形式来设定一个查询场景，然后分别以 SQL 及 聚合流水线两种方式来实现。</p><h3 id=31-按字段过滤然后进行分组和排序>3.1 按字段过滤，然后进行分组和排序</h3><p>问题描述：找出类型为<code>standard</code>的手机，然后按名称分组并计算其对应的总数量，返回结果包含名称和总数量两列，按总数量降序排序。</p><p>针对上述问题，SQL 中首先会使用<code>WHERE</code>来进行筛选，然后使用<code>GROUP BY</code>来分组，使用聚集函数<code>sum</code>来进行累加，最后使用<code>ORDER BY</code>来进行排序。</p><p>SQL 查询语句及运行结果如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span>name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span><span style=color:#000;font-weight:700>sum</span>(quantity)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>AS</span><span style=color:#bbb> </span>total_quantity<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>phones<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>WHERE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>type</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#39;standard&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>GROUP</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>BY</span><span style=color:#bbb> </span>name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>ORDER</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>BY</span><span style=color:#bbb> </span>total_quantity<span style=color:#bbb> </span><span style=color:#000;font-weight:700>DESC</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  name  | total_quantity
</span></span><span style=display:flex><span>--------+----------------
</span></span><span style=display:flex><span> VIVO   |             50
</span></span><span style=display:flex><span> HUAWEI |             40
</span></span><span style=display:flex><span> XIAOMI |             30
</span></span><span style=display:flex><span> OPPO   |             20
</span></span><span style=display:flex><span> Apple  |             10
</span></span></code></pre></div><p>该问题若使用 MongoDB 的聚合流水线来实现，需要有 3 个阶段：</p><ul><li><p>第一个阶段<code>$match</code></p><p>过滤类型为<code>standard</code>的文档，并将结果传递到下一个阶段。</p></li><li><p>第二个阶段<code>$group</code></p><p>针对输入文档，按名称进行分组，然后对每个名称计算新字段<code>totalQuantity</code>的值，该字段值为数量的累加。完成后，将结果传递到下一个阶段。</p></li><li><p>第三个阶段<code>$sort</code></p><p>针对输入文档，按<code>totalQuantity</code>进行降序排序，完成后返回结果。</p></li></ul><p>MongoShell <code>aggregate</code> 聚合查询命令及运行结果如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>db.phones.aggregate<span style=color:#000;font-weight:700>(</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:teal>$match</span>: <span style=color:#000;font-weight:700>{</span> type: <span style=color:#d14>&#34;standard&#34;</span> <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:teal>$group</span>: <span style=color:#000;font-weight:700>{</span> _id: <span style=color:#d14>&#34;</span><span style=color:teal>$name</span><span style=color:#d14>&#34;</span>, totalQuantity: <span style=color:#000;font-weight:700>{</span> <span style=color:teal>$sum</span>: <span style=color:#d14>&#34;</span><span style=color:teal>$quantity</span><span style=color:#d14>&#34;</span> <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:teal>$sort</span>: <span style=color:#000;font-weight:700>{</span> totalQuantity: -1 <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[
</span></span><span style=display:flex><span>  { _id: &#39;VIVO&#39;, totalQuantity: 50 },
</span></span><span style=display:flex><span>  { _id: &#39;HUAWEI&#39;, totalQuantity: 40 },
</span></span><span style=display:flex><span>  { _id: &#39;XIAOMI&#39;, totalQuantity: 30 },
</span></span><span style=display:flex><span>  { _id: &#39;OPPO&#39;, totalQuantity: 20 },
</span></span><span style=display:flex><span>  { _id: &#39;Apple&#39;, totalQuantity: 10 }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>可以看到，MongoDB 聚合流水线的查询结果与上面的 SQL 语句查询结果是一致的。</p><h3 id=32-对时间字段限定范围然后进行分组和排序>3.2 对时间字段限定范围，然后进行分组和排序</h3><p>问题描述：找出发布时间<code>published_at</code>在 2023 年 2 月到 2023 年 4 月这三个月所发布的手机，然后按发布年月计算当月发布的手机总数量，返回结果包含发布年月和总数量两列，按总数量降序排序。</p><p>针对上述问题，SQL 中首先会将时间戳转换为年月格式，然后使用<code>WHERE</code>来限定日期范围，然后使用<code>GROUP BY</code>来分组，使用聚集函数<code>sum</code>来进行累加，最后使用<code>ORDER BY</code>来进行排序。</p><p>SQL 查询语句及运行结果如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span>to_char(published_at,<span style=color:#bbb> </span><span style=color:#d14>&#39;YYYY-MM&#39;</span>)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>AS</span><span style=color:#bbb> </span>year_month,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span><span style=color:#000;font-weight:700>sum</span>(quantity)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>AS</span><span style=color:#bbb> </span>total_quantity<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>phones<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>WHERE</span><span style=color:#bbb> </span>published_at<span style=color:#bbb> </span><span style=color:#000;font-weight:700>BETWEEN</span><span style=color:#bbb> </span><span style=color:#d14>&#39;2023-02-01 00:00:00&#39;</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>AND</span><span style=color:#bbb> </span><span style=color:#d14>&#39;2023-05-01 00:00:00&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>GROUP</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>BY</span><span style=color:#bbb> </span>year_month<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>ORDER</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>BY</span><span style=color:#bbb> </span>year_month<span style=color:#bbb> </span><span style=color:#000;font-weight:700>DESC</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span> year_month | total_quantity
</span></span><span style=display:flex><span>------------+----------------
</span></span><span style=display:flex><span> 2023-04    |             80
</span></span><span style=display:flex><span> 2023-03    |             40
</span></span><span style=display:flex><span> 2023-02    |             60
</span></span></code></pre></div><p>该问题若使用 MongoDB 的聚合流水线来实现，亦需要有 3 个阶段：</p><ul><li><p>第一个阶段<code>$match</code></p><p>过滤发布日期<code>published_at</code>在<code>2023-02-01 00:00:00</code>与<code>2023-05-01 00:00:00</code>之间的文档，并将结果传递到下一个阶段。</p></li><li><p>第二个阶段<code>$group</code></p><p>针对输入文档，将发布日期转换为<code>%Y-%m</code>格式后按其进行分组，然后计算该年月发布的手机总数量<code>totalQuantity</code>。完成后，将结果传递到下一个阶段。</p></li><li><p>第三个阶段<code>$sort</code></p><p>针对输入文档，按年月字段进行降序排序，完成后返回结果。</p></li></ul><p>MongoShell <code>aggregate</code> 聚合查询命令及运行结果如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>db.phones.aggregate<span style=color:#000;font-weight:700>(</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$match</span>:
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        published_at: <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:teal>$gte</span>: new ISODate<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;2023-02-01 00:00:00&#34;</span><span style=color:#000;font-weight:700>)</span>,
</span></span><span style=display:flex><span>          <span style=color:teal>$lt</span>: new ISODate<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;2023-05-01 00:00:00&#34;</span><span style=color:#000;font-weight:700>)</span>,
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$group</span>:
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        _id: <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:teal>$dateToString</span>: <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            format: <span style=color:#d14>&#34;%Y-%m&#34;</span>,
</span></span><span style=display:flex><span>            date: <span style=color:#d14>&#34;</span><span style=color:teal>$published_at</span><span style=color:#d14>&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>        totalQuantity: <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:teal>$sum</span>: <span style=color:#d14>&#34;</span><span style=color:teal>$quantity</span><span style=color:#d14>&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$sort</span>:
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        _id: -1,
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[
</span></span><span style=display:flex><span>  { _id: &#39;2023-04&#39;, totalQuantity: 80 },
</span></span><span style=display:flex><span>  { _id: &#39;2023-03&#39;, totalQuantity: 40 },
</span></span><span style=display:flex><span>  { _id: &#39;2023-02&#39;, totalQuantity: 60 }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>可以看到，聚合流水线的查询结果与 SQL 语句查询结果也是一致的。</p><p>综上，本文对比 SQL 来学习了最基本的 MongoDB 聚合操作，对于聚合操作更复杂一点的特性，待后面有时间来学习整理。</p><blockquote><p>参考资料</p><p>[1] <a href=https://www.mongodb.com/docs/manual/aggregation/>MongoDB Aggregation Operations - www.mongodb.com</a></p><p>[2] <a href=https://www.practical-mongodb-aggregations.com/>Practical MongoDB Aggregations Book - www.practical-mongodb-aggregations.com</a></p><p>[3] <a href=https://sqlformat.org/>Format SQL Statements Online - sqlformat.org</a></p></blockquote></div><div class=content-footer><div class=weixinhao><img src=/static/images/self/weixinhao-white.jpg></div><div class=post-tags><a href=/tags/mongodb/>#MongoDB</a></div><div class=license><i class=ti-info-alt></i><div class=info>版权声明：该博客文章由作者通过「<a href=https://creativecommons.org/licenses/by/4.0/deed.zh>知识共享署名 4.0 许可证</a>」进行授权，转载须注明文章原始链接。</div></div></div></div><div class="col-lg-8 mx-auto block shadow"><h3>相关文章</h3><ul><li><a href=/posts/design-mongodb-util-using-pymongo.html>使用 PyMongo 封装一个易用的 MongoDB 工具类</a></li><li><a href=/posts/spring-data-mongodb.html>如何使用 Spring Data MongoDB 访问 MongoDB 数据库？</a></li></ul></div><div class="col-lg-8 mx-auto block shadow"><div><h3>评论</h3><div id=comment-loading style=text-align:center;font-size:14px><img style=width:52px src=/static/images/site/mona-loading-default.gif>
<span>正在加载评论......</span></div><script>function handleMessage(e){if(e.origin!=="https://giscus.app")return;if(typeof e.data!="object"||!e.data.giscus)return;const t=document.getElementById("comment-loading");t.style.display="none"}window.addEventListener("message",handleMessage)</script><script src=https://giscus.app/client.js data-repo=leileiluoluo/leileiluoluo.github.io data-repo-id=R_kgDOJkLT8w data-category=General data-category-id=DIC_kwDOJkLT884CdtEh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div></div></section><footer class="py-4 bg-lights border-top"><div class=container><div class="row justify-content-between text-center align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/sponsor>随喜打赏</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/about>关于本博</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/links>友情链接</a></li></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a title=文章归档 href=/archives/><i class=ti-archive></i></a></li><li class=list-inline-item><a title=文章标签 href=/tags/><i class=ti-tag></i></a></li><li class=list-inline-item><a title="我的 GitHub" href=https://github.com/leileiluoluo><i class=ti-github></i></a></li><li class=list-inline-item><a title="网站 RSS" href=/index.xml><i class=ti-rss></i></a></li></ul></div></div><div style=text-align:center;font-size:18px;margin-bottom:22px><a style="-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-image:linear-gradient(to right,#14100f,#d55b5b,#4d14e6)" href=https://www.boyouquan.com/planet-shuttle>「博友圈 · 星球穿梭」</a></div><div class="text-center mt-4"><span>Made with <a href=https://gohugo.io/>Hugo</a> | Theme by <a href=https://github.com/themefisher/northendlab-hugo>NorthendLab</a> | <a href=https://beian.miit.gov.cn>辽ICP备2022012085号-5</a> | Copyright © 2017-2025</span></div></div></footer><script>var indexURL="https://leileiluoluo.github.io/index.json"</script><script src=https://leileiluoluo.github.io/js/jquery.min.js></script><script src=https://leileiluoluo.github.io/js/bootstrap.min.js></script><script src=https://leileiluoluo.github.io/js/fuse.min.js></script><script src=https://leileiluoluo.github.io/js/mark.js></script><script src=https://leileiluoluo.github.io/js/search.js></script><script src=https://leileiluoluo.github.io/js/script.min.js></script></body></html>