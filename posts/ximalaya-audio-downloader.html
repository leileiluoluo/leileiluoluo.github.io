<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>使用 Golang 实现喜马拉雅音频下载 - 磊磊落落</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=keywords content="Golang,喜马拉雅,音频下载,音频转换,FFmpeg,MP3"><meta name=description content="本文介绍如何使用 Golang 下载喜马拉雅音频。包括 API 调研、Golang 代码实现、如何使用和如何进行音频格式转换几个部分。"><meta name=author content="磊磊落落"><meta name=generator content="Hugo 0.123.7"><link rel=stylesheet href=https://leileiluoluo.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://leileiluoluo.github.io/css/themify-icons.css><link rel=stylesheet href=https://leileiluoluo.github.io/css/larry-custom-v1.0.css><link rel=stylesheet href=https://leileiluoluo.github.io/scss/style.min.css media=screen><link rel="shortcut icon" href=https://leileiluoluo.github.io/images/favicon.png type=image/x-icon><link rel=icon href=https://leileiluoluo.github.io/images/favicon.png type=image/x-icon><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?526723b767317055572c85bdb445353c",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://leileiluoluo.github.io/>磊磊落落</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/></a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/>计算机</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E9%9A%8F%E7%AC%94/>随笔</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%AF%BB%E4%B9%A6/>读书</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E8%A7%82%E5%BD%B1/>观影</a></li><li class=nav-item><a class=nav-link href=https://leileiluoluo.github.io/categories/%E7%BB%83%E5%AD%97/>练字</a></li></ul><div class=search><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=https://leileiluoluo.github.io//search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder=键入关键字后回车...></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h1>使用 Golang 实现喜马拉雅音频下载</h1><div class="mb-3 post-meta">2022年11月12日
<a href=/categories/%e8%ae%a1%e7%ae%97%e6%9c%ba>计算机</a></div><div class="content mb-5"><p><a href=https://www.ximalaya.com/>「喜马拉雅」</a>是本人非常喜欢的一款音频软件。里面有很多优质的音频节目，丰富了我的日常生活。</p><p>本文的诞生来自于我的个人需求：本人是喜马拉雅 APP 的重度用户，几乎每天都会使用其来听一些经典，它的确是给了我「每一天的精神食粮」。有时，有一些音频想下载下来反复听，但受限于手机的存储容量，不能随心将想听的音频进行下载。因此，便萌生了写点代码将音频下载到 U 盘，电脑或 MP3 设备的想法。</p><p><strong>需要特别说明的是：本程序不涉及登录，不涉及付费内容盗取，下载的是喜马拉雅网站免登录状态下完全公开的内容。</strong></p><p>接下来便依序介绍从 API 调研到 Golang 代码实现，以及如何使用及如何进行音频格式转换的整个过程。</p><h3 id=1-api-调研>1 API 调研</h3><h4 id=专辑-id-如何获取>专辑 ID 如何获取？</h4><p>要获取一个专辑（Album）下所有的音频，必须要知道专辑的 ID。</p><p>如下图所示，访问喜马拉雅的某个专辑时，从浏览器地址栏可以看到该专辑的 ID（本例中，248003 就是「张庆祥讲孟子」专辑的 ID）。</p><p><img loading=lazy src=https://leileiluoluo.github.io/static/images/uploads/2022/11/xima-url.png#center alt=喜马拉雅专辑ID></p><h4 id=获取音频的-api>获取音频的 API</h4><p>写作本文时，喜马拉雅网站：</p><ul><li><p>根据专辑 ID 分页获取音频列表的 API 为：<code>https://www.ximalaya.com/revision/album/v1/getTracksList?albumId=:albumId&amp;pageNum=:pageNum</code></p></li><li><p>根据音频 ID 获取音频下载链接的 API 为：<code>https://www.ximalaya.com/revision/play/v1/audio?id=:trackId&amp;ptype=1</code></p></li></ul><p>这样，有了专辑 ID，就可以根据上面第一个 API 查询到其下的所有音频详情（包括音频 ID、音频标题等）；有了音频 ID，就可以根据第二个 API 查询到音频地址，然后进行下载了。</p><h3 id=2-golang-实现>2 Golang 实现</h3><p>实现音频下载的 Golang 代码已托管至本人 <a href=https://github.com/leileiluoluo/ximalaya-downloader>GitHub</a>。</p><p>因实现逻辑简单，整个实现的代码也不到 200 行，下面只看一下 main 函数的逻辑。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// parameter validation
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>if</span> <span style=color:#0086b3>len</span>(os.Args) &lt; <span style=color:#099>2</span> {
</span></span><span style=display:flex><span>        fmt.<span style=color:#900;font-weight:700>Println</span>(<span style=color:#d14>&#34;please provide an album id&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    albumId, err <span style=color:#000;font-weight:700>:=</span> strconv.<span style=color:#900;font-weight:700>Atoi</span>(os.Args[<span style=color:#099>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>        fmt.<span style=color:#900;font-weight:700>Println</span>(<span style=color:#d14>&#34;album id should be an integer&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;album id: %d\n&#34;</span>, albumId)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// get all track list
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    tracks, err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>getAllTrackList</span>(albumId)
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>        fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;error in get all track list, err: %v\n&#34;</span>, err)
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;all track list got, total: %d\n&#34;</span>, <span style=color:#0086b3>len</span>(tracks))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// get audio addresses
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>for</span> _, track <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>range</span> tracks {
</span></span><span style=display:flex><span>        audioAddr, err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>getAudioAddress</span>(track.TrackId)
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>            fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;error in get audio address, err: %v\n&#34;</span>, err)
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// download
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        filePath, err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>download</span>(audioAddr, track.Title, track.AlbumTitle)
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>            fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;error in audo download, err: %v\n&#34;</span>, err)
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;downloaded! file: %s\n&#34;</span>, filePath)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到，在<code>main</code>函数中：</p><ul><li>首先作了参数校验（必须提供一个专辑 ID）；</li><li>调用 getAllTrackList 函数获取指定专辑下的所有 tracks（每个 track 中有音频 ID、标题等信息）；</li><li>遍历 tracks 数组，对每个 track，调用 getAudioAddress 函数获取音频地址，然后进行下载。</li></ul><h3 id=3-如何使用>3 如何使用？</h3><p>使用起来非常简单，拥有 Go 运行环境的话，指定专辑 ID 直接运行<code>main.go</code>即可。示例如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go run main.go <span style=color:#099>248003</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>album id: <span style=color:#099>248003</span>
</span></span><span style=display:flex><span>all track list got, total: <span style=color:#099>140</span>
</span></span><span style=display:flex><span>downloaded! file: 张庆祥讲孟子/1.治国的根本.m4a
</span></span><span style=display:flex><span>downloaded! file: 张庆祥讲孟子/2.君王如何才能安心享乐？.m4a
</span></span><span style=display:flex><span>downloaded! file: 张庆祥讲孟子/3.五十步笑百步.m4a
</span></span><span style=display:flex><span>downloaded! file: 张庆祥讲孟子/4.仁者无敌.m4a
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>程序会在当前运行命令的文件夹下新建一个以该专辑命名的文件夹，并将该专辑下所有的音频逐条下载至该专辑文件夹下。下载结果如下图所示：</p><p><img loading=lazy src=https://leileiluoluo.github.io/static/images/uploads/2022/11/xima-download.png#center alt=下载示例></p><h3 id=4-m4a-如何转-mp3>4 m4a 如何转 mp3？</h3><p>下载完成后还有一个问题，就是喜马拉雅的音频格式为<code>.m4a</code>，该格式在苹果设备上播放没有问题，但其它设备的默认音频播放器不支持播放该种格式。</p><p>怎么办呢？我们可以借助工具将其转换为更加通用的<code>mp3</code>格式。</p><p>最简单直观的方式是搜索在线 m4a 到 mp3 转换工具（如 <a href=https://www.freeconvert.com/m4a-to-mp3>freeconvert.com/m4a-to-mp3</a>），在网页上传文件并等待转换完成后进行下载即可。</p><p>但作为程序员，本人更喜欢使用命令的方式进行转换。下面会介绍一个小工具 - <a href=https://ffmpeg.org/>FFmpeg</a>，使用其即可进行 m4a 到 mp3 的音频转换。</p><p>首先到<a href=https://ffmpeg.org/download.html>「FFmpeg 下载页」</a>找到与您当前操作系统匹配的可执行文件下载链接（本人使用的是 Mac，找到的下载链接为 <a href=https://evermeet.cx/ffmpeg/>evermeet.cx/ffmpeg</a>），然后使用如下命令对压缩包下载、解压并将解压后的可执行文件<code>ffmpeg</code>移动至<code>/usr/local/bin</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -O https://evermeet.cx/ffmpeg/ffmpeg-109029-g1800a0da09.zip
</span></span><span style=display:flex><span>unzip ffmpeg-109029-g1800a0da09.zip
</span></span><span style=display:flex><span>sudo mv ffmpeg /usr/local/bin
</span></span></code></pre></div><p>安装好了<code>ffmpeg</code>，即可使用如下命令对<code>m4a</code>文件进行转换了：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#0086b3>cd</span> 张庆祥讲孟子/
</span></span><span style=display:flex><span>mkdir after
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>for</span> f in *.m4a; <span style=color:#000;font-weight:700>do</span> ffmpeg -i <span style=color:#d14>&#34;</span><span style=color:teal>$f</span><span style=color:#d14>&#34;</span> -codec:v copy -codec:a libmp3lame -q:a <span style=color:#099>2</span> after/<span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>f</span>%.m4a<span style=color:#d14>}</span><span style=color:#d14>.mp3&#34;</span>; <span style=color:#000;font-weight:700>done</span>
</span></span></code></pre></div><p>如上命令首先进入待转换的<code>m4a</code>音频文件所在文件夹，然后创建转换后的文件存储文件夹<code>after</code>，最后对所有的<code>m4a</code>文件使用<code>ffmpeg</code>将其转换为<code>mp3</code>格式并放至文件夹<code>after</code>。转换后的结果如下图所示：</p><p><img loading=lazy src=https://leileiluoluo.github.io/static/images/uploads/2022/11/xima-after.png#center alt=转换后的结果截图></p><p>有了这些更通用的 mp3 格式，即可在离线情况下在几乎任何可以播放音频的设备上随心去听这些音频了。</p><br><p>综上，本文介绍了如何使用 Golang 实现喜马拉雅音频下载及 m4a 到 mp3 的格式转换方法。总结一下，主要作自己使用，也希望对感兴趣的同学有所帮助。</p><blockquote><p>参考资料</p><p>[1] <a href=https://ximalaya.com/>喜马拉雅 - ximalaya.com</a></p><p>[2] <a href=https://ffmpeg.org/>FFmpeg - ffmpeg.org</a></p><p>[3] <a href=https://superuser.com/questions/704493/ffmpeg-convert-m4a-to-mp3-without-significant-loss>FFMPEG: Convert m4a to mp3 without significant loss - superuser.com</a></p></blockquote></div><div class=content-footer><div class=post-tags><a href=/tags/golang/>#Golang</a></div></div></div><div class="col-lg-8 mx-auto block shadow"><h3>相关文章</h3><ul><li><a href=/posts/golang-makes-two-changes-to-for-loops.html>Golang 1.22 对 for 循环作了两处更新</a></li><li><a href=/posts/efficent-string-concatenation-in-golang.html>Golang 高效的字符串拼接方法</a></li><li><a href=/posts/leetcode-construct-binary-tree-from-preorder-and-inorder-traversal.html>LeetCode 105 以先序遍历及中序遍历构造二叉树</a></li><li><a href=/posts/leetcode-design-linked-list.html>LeetCode 707 设计链表</a></li><li><a href=/posts/golang-text-template.html>Golang text/template 使用样例</a></li></ul></div><div class="col-lg-8 mx-auto block shadow"><div><h3>评论</h3><div id=comment-loading style=text-align:center;font-size:14px><img style=width:52px src=/static/images/site/mona-loading-default.gif>
<span>正在加载评论......</span></div><script>function handleMessage(e){if(e.origin!=="https://giscus.app")return;if(typeof e.data!="object"||!e.data.giscus)return;const t=document.getElementById("comment-loading");t.style.display="none"}window.addEventListener("message",handleMessage)</script><script src=https://giscus.app/client.js data-repo=leileiluoluo/leileiluoluo.github.io data-repo-id=R_kgDOJkLT8w data-category=General data-category-id=DIC_kwDOJkLT884CdtEh data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></div></div></div></div></section><footer class="py-4 bg-lights border-top"><div class=container><div class="row justify-content-between text-center align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/leetcode-golang-implementations>LeetCode</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/about>关于本博</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://leileiluoluo.github.io/links>友情链接</a></li></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a title=文章归档 href=/archives/><i class=ti-archive></i></a></li><li class=list-inline-item><a title=文章标签 href=/tags/><i class=ti-tag></i></a></li><li class=list-inline-item><a title="我的 GitHub" href=https://github.com/leileiluoluo><i class=ti-github></i></a></li><li class=list-inline-item><a title="网站 RSS" href=/index.xml><i class=ti-rss></i></a></li></ul></div></div><div style=text-align:center;font-size:18px;margin-bottom:22px><a style="-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-image:linear-gradient(to right,#14100f,#d55b5b,#4d14e6)" href=https://www.boyouquan.com/planet-shuttle>「博友圈 · 星球穿梭」</a></div><div class="text-center mt-4"><span>Made with <a href=https://gohugo.io/>Hugo</a> | Theme by <a href=https://github.com/themefisher/northendlab-hugo>NorthendLab</a> | <a href=https://beian.miit.gov.cn>辽ICP备2022012085号-5</a> | Copyright © 2017-2024</span></div></div></footer><script>var indexURL="https://leileiluoluo.github.io/index.json"</script><script src=https://leileiluoluo.github.io/js/jquery.min.js></script><script src=https://leileiluoluo.github.io/js/bootstrap.min.js></script><script src=https://leileiluoluo.github.io/js/fuse.min.js></script><script src=https://leileiluoluo.github.io/js/mark.js></script><script src=https://leileiluoluo.github.io/js/search.js></script><script src=https://leileiluoluo.github.io/js/script.min.js></script></body></html>