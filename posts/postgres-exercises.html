<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>PostgreSQL 基础知识在线练习 - 磊磊落落</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=keywords content="PostgreSQL,练习"><meta name=description content="PostgreSQL练习 (PostgreSQL Exercises)"><meta name=author content="磊磊落落"><meta name=generator content="Hugo 0.81.0"><link rel=stylesheet href=https://olzhy.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://olzhy.github.io/css/themify-icons.css><link rel=stylesheet href=https://olzhy.github.io/css/larry-custom.css><link rel=stylesheet href=https://olzhy.github.io/scss/style.min.css media=screen><link rel="shortcut icon" href=https://olzhy.github.io/images/favicon.png type=image/x-icon><link rel=icon href=https://olzhy.github.io/images/favicon.png type=image/x-icon><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?526723b767317055572c85bdb445353c",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://olzhy.github.io/>磊磊落落</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://olzhy.github.io/></a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E9%9A%8F%E7%AC%94/>随笔</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%AF%BB%E4%B9%A6/>读书</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%A7%82%E5%BD%B1/>观影</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E7%BB%83%E5%AD%97/>练字</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/>计算机</a></li></ul><div class=search><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=https://olzhy.github.io//search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder=键入关键字后回车...></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h1>PostgreSQL 基础知识在线练习</h1><div class="mb-3 post-meta">2021年07月31日
<a href=/categories/%e8%ae%a1%e7%ae%97%e6%9c%ba>计算机</a></div><div class="content mb-5"><p><a href=https://pgexercises.com/>PGExercises.com</a> 是一个非常不错的 PostgreSQL 在线实践网站。该网站基于一个简单的数据集，设立各类题目，我们可以通过回答这些问题来复习 SQL 知识。</p><p>该站的题目涉及“简单查询及 WHERE 条件”，“连接及 CASE 语句”，“聚集函数，窗口函数及递归查询”等多个门类，是一个不错的测试所学知识的地方。</p><p>下面简单介绍一下该站用到的数据集。</p><p>该数据集针对的是一个刚成立的乡村俱乐部的：有一组会员，一组体育设施，及这些体育设施的预定记录。</p><p>先看一下<code>members</code>表：</p><p>有 ID，基础信息，推荐人 ID，及加入时间等。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> cd.members (
    memid INTEGER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,                     <span style=color:#75715e>-- 会员ID
</span><span style=color:#75715e></span>    surname CHARACTER VARYING(<span style=color:#ae81ff>200</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,    <span style=color:#75715e>-- 姓
</span><span style=color:#75715e></span>    firstname CHARACTER VARYING(<span style=color:#ae81ff>200</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,  <span style=color:#75715e>-- 名
</span><span style=color:#75715e></span>    address CHARACTER VARYING(<span style=color:#ae81ff>300</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,    <span style=color:#75715e>-- 地址
</span><span style=color:#75715e></span>    zipcode INTEGER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,                   <span style=color:#75715e>-- 邮政编码
</span><span style=color:#75715e></span>    telephone CHARACTER VARYING(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,   <span style=color:#75715e>-- 电话
</span><span style=color:#75715e></span>    recommendedby INTEGER,                      <span style=color:#75715e>-- 推荐人
</span><span style=color:#75715e></span>    joindate <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,                <span style=color:#75715e>-- 加入时间
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>CONSTRAINT</span> members_pk <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (memid),
    <span style=color:#66d9ef>CONSTRAINT</span> fk_members_recommendedby <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (recommendedby)
        <span style=color:#66d9ef>REFERENCES</span> cd.members(memid) <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>NULL</span>
);
</code></pre></div><p>接下来，看一下<code>facilities</code>表：</p><p>该表列出可供预定的设施，包含设施 ID，设施名称，会员预定花销，游客预定花销等。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> cd.facilities (
    facid integer <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,                 <span style=color:#75715e>-- 设施ID
</span><span style=color:#75715e></span>    name character varying(<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,   <span style=color:#75715e>-- 设施名称
</span><span style=color:#75715e></span>    membercost numeric <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,            <span style=color:#75715e>-- 会员预定花销
</span><span style=color:#75715e></span>    guestcost numeric <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,             <span style=color:#75715e>-- 游客预定花销
</span><span style=color:#75715e></span>    initialoutlay numeric <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    monthlymaintenance numeric <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    <span style=color:#66d9ef>CONSTRAINT</span> facilities_pk <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (facid)
);
</code></pre></div><p>最后，看一下<code>bookings</code>表：</p><p>该表用于追踪各设施的预定情况，包含设施 ID，预定会员 ID，开始预定时间，及预定了多少个半小时的 slots 等。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> cd.bookings (
    bookid integer <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    facid integer <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,        <span style=color:#75715e>-- 设施ID
</span><span style=color:#75715e></span>    memid integer <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,        <span style=color:#75715e>-- 会员ID
</span><span style=color:#75715e></span>    starttime <span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,  <span style=color:#75715e>-- 开始预定时间
</span><span style=color:#75715e></span>    slots integer <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,        <span style=color:#75715e>-- 预定了多少个半小时
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>CONSTRAINT</span> bookings_pk <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (bookid),
    <span style=color:#66d9ef>CONSTRAINT</span> fk_bookings_facid <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (facid) <span style=color:#66d9ef>REFERENCES</span> cd.facilities(facid),
    <span style=color:#66d9ef>CONSTRAINT</span> fk_bookings_memid <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (memid) <span style=color:#66d9ef>REFERENCES</span> cd.members(memid)
);
</code></pre></div><p>这三张表的关系如下图所示。</p><p><img loading=lazy src=https://olzhy.github.io/static/images/uploads/2021/07/schema-horizontal.svg#center alt width=80%></p><p>介绍完数据集，下面就开始我们的练习吧。</p><h3 id=1-简单-sql-查询>1 简单 SQL 查询</h3><p>该栏目考察 SQL 基础，题目涵盖 SELECT, WHERE, CASE, UNION 等。</p><p><strong>1 控制取哪些行</strong></p><p>问题描述：</p><p>生成一个设备列表，这些设备对会员收费，且所收的费用不足月度维护费用的 50 分之一。该列表返回设备的 ID，名称，会员费，月度维护费用。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> facid, name, membercost, monthlymaintenance
<span style=color:#66d9ef>FROM</span> cd.facilities
<span style=color:#66d9ef>WHERE</span> membercost <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>AND</span> membercost <span style=color:#f92672>&lt;</span> monthlymaintenance<span style=color:#f92672>/</span><span style=color:#ae81ff>50</span>;
</code></pre></div><p><strong>2 将结果分类</strong></p><p>问题描述：</p><p>生成一个设备列表，若月度维护费用大于 100 就标记为<code>expensive</code>，否则标记为<code>cheap</code>。返回相关设施的名称和月度维护情况。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> name,
    <span style=color:#66d9ef>CASE</span>
        <span style=color:#66d9ef>WHEN</span> monthlymaintenance <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span>
        <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;expensive&#39;</span>
        <span style=color:#66d9ef>ELSE</span> <span style=color:#e6db74>&#39;cheap&#39;</span>
    <span style=color:#66d9ef>END</span> <span style=color:#66d9ef>AS</span> cost
<span style=color:#66d9ef>FROM</span> cd.facilities;
</code></pre></div><p><strong>3 日期处理</strong></p><p>问题描述：</p><p>生成一个会员列表，返回 2012 年 9 月及之后加入的会员。返回会员的 memid，surname，firstname 及 joindate。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> memid, surname, firstname, joindate
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>WHERE</span> joindate <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;2012-09-01&#39;</span>;
</code></pre></div><p><strong>4 重复项移除及结果排序</strong></p><p>问题描述：</p><p>生成一个排序后的前 10 位会员的姓氏列表，且不要有重复。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> surname
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> surname <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>;
</code></pre></div><p><strong>5 组合多个查询的结果</strong></p><p>问题描述：</p><p>出于某种原因，您需要一个包含所有姓氏和所有设施名称的组合列表。请生成这个列表。</p><p>问题答案：</p><p>注意使用<code>UNION</code>会移除重复项，而<code>UNION ALL</code>并不会。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> surname
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>UNION</span>
<span style=color:#66d9ef>SELECT</span> name
<span style=color:#66d9ef>FROM</span> cd.facilities;
</code></pre></div><p><strong>6 聚集函数使用</strong></p><p>问题描述：</p><p>您想获取最后一个加入的会员的名字，姓氏，加入时间。该如何做？</p><p>问题答案：</p><p>使用子查询实现。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> firstname, surname, joindate
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>WHERE</span> joindate <span style=color:#f92672>=</span> (
        <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>max</span>(joindate)
        <span style=color:#66d9ef>FROM</span> cd.members);
</code></pre></div><h3 id=2-连接及子查询>2 连接及子查询</h3><p>该栏目主要考察关系型数据库的基础——连接。题目涵盖内连接，外连接，自连接，子查询。</p><p><strong>1 获取会员的预定开始时间</strong></p><p>问题描述：</p><p>获取会员名字为“David Farrell”的预定开始时间。</p><p>问题答案：</p><p>有两种实现方式，一种采用内连接，一种采用子查询。内连接又有两种写法。</p><p>a）内连接实现</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> b.starttime
<span style=color:#66d9ef>FROM</span> cd.bookings b, cd.members m
<span style=color:#66d9ef>WHERE</span> b.memid <span style=color:#f92672>=</span> m.memid
  <span style=color:#66d9ef>AND</span> firstname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;David&#39;</span>
  <span style=color:#66d9ef>AND</span> surname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Farrell&#39;</span>;

<span style=color:#75715e>-- 另一种写法
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> b.starttime
<span style=color:#66d9ef>FROM</span> cd.bookings b
  <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> cd.members m
  <span style=color:#66d9ef>ON</span> b.memid <span style=color:#f92672>=</span> m.memid
<span style=color:#66d9ef>WHERE</span> firstname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;David&#39;</span>
  <span style=color:#66d9ef>AND</span> surname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Farrell&#39;</span>;
</code></pre></div><p>b）子查询实现</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> starttime
<span style=color:#66d9ef>FROM</span> cd.bookings
<span style=color:#66d9ef>WHERE</span> memid <span style=color:#66d9ef>IN</span> (
      <span style=color:#66d9ef>SELECT</span> memid
      <span style=color:#66d9ef>FROM</span> cd.members
      <span style=color:#66d9ef>WHERE</span> firstname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;David&#39;</span>
        <span style=color:#66d9ef>AND</span> surname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Farrell&#39;</span>
      );
</code></pre></div><p><strong>2 获取网球场的预定开始时间</strong></p><p>问题描述：</p><p>获取<code>2012-09-21</code>这一天预定“Tennis Court”的开始时间列表。返回开始时间及设备名称，按开始时间排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> b.starttime, f.name
<span style=color:#66d9ef>FROM</span> cd.bookings b, cd.facilities f
<span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
  <span style=color:#66d9ef>AND</span> f.name <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;Tennis Court%&#39;</span>
  <span style=color:#66d9ef>AND</span> date(b.starttime) <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;2012-09-21&#39;</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> b.starttime;
</code></pre></div><p><strong>3 获取推荐过其他会员的所有会员列表</strong></p><p>问题描述：</p><p>获取推荐过其他会员的所有会员列表，确保结果不含重复项，且结果以姓和名排序。</p><p>问题答案：</p><p>采用自连接实现，采用 DISTINCT 去重。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> m2.firstname, m2.surname
<span style=color:#66d9ef>FROM</span> cd.members m1, cd.members m2
<span style=color:#66d9ef>WHERE</span> m1.recommendedby <span style=color:#f92672>=</span> m2.memid
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> m2.surname, m2.firstname;
</code></pre></div><p><strong>4 获取所有会员及其推荐人</strong></p><p>问题描述：</p><p>获取所有会员及其推荐人（如果有的话），确保结果以姓和名排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> m1.firstname,
	m1.surname,
	m2.firstname,
	m2.surname
<span style=color:#66d9ef>FROM</span> cd.members m1
<span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>OUTER</span> <span style=color:#66d9ef>JOIN</span> cd.members m2 <span style=color:#66d9ef>ON</span> m1.recommendedby <span style=color:#f92672>=</span> m2.memid
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> m1.surname,
	m1.firstname;
</code></pre></div><p><strong>5 列出所有使用过网球场的会员</strong></p><p>问题描述：</p><p>找出使用过网球场的所有会员的列表。输出包含网球场名，合为一列的会员姓名。确保没有重复数据，并按会员姓名后跟设施名称排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> (m.firstname <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> m.surname) <span style=color:#66d9ef>AS</span> member,
  f.name <span style=color:#66d9ef>AS</span> facility
<span style=color:#66d9ef>FROM</span> cd.bookings b,
  cd.members m,
  cd.facilities f
<span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
  <span style=color:#66d9ef>AND</span> b.memid <span style=color:#f92672>=</span> m.memid
  <span style=color:#66d9ef>AND</span> f.name <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;Tennis Court%&#39;</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> member, facility;
</code></pre></div><p><strong>6 生成一份昂贵的预订清单</strong></p><p>问题描述：</p><p>生成<code>2012-09-14</code>这一天会员或游客花费超过 30 元的预订清单。</p><p>注意：游客和会员的预定费用不同，且游客的 ID 始终为 0。输出中包括设施名称，会员姓名及预定费用。结果按费用降序排序，且不使用任何子查询。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> (m.firstname <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> m.surname) <span style=color:#66d9ef>AS</span> member,
  f.name <span style=color:#66d9ef>AS</span> facility,
  (<span style=color:#66d9ef>CASE</span>
    <span style=color:#66d9ef>WHEN</span> b.memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    <span style=color:#66d9ef>THEN</span> b.slots <span style=color:#f92672>*</span> f.guestcost
    <span style=color:#66d9ef>ELSE</span> b.slots <span style=color:#f92672>*</span> f.membercost <span style=color:#66d9ef>END</span>) <span style=color:#66d9ef>AS</span> cost
<span style=color:#66d9ef>FROM</span> cd.bookings b,
  cd.members m,
  cd.facilities f
<span style=color:#66d9ef>WHERE</span> b.memid <span style=color:#f92672>=</span> m.memid
  <span style=color:#66d9ef>AND</span> b.facid <span style=color:#f92672>=</span> f.facid
  <span style=color:#66d9ef>AND</span> date(b.starttime) <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;2012-09-14&#39;</span>
  <span style=color:#66d9ef>AND</span> ((b.memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>AND</span> b.slots <span style=color:#f92672>*</span> f.guestcost <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>30</span>)
    <span style=color:#66d9ef>OR</span> (b.memid <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>AND</span> b.slots <span style=color:#f92672>*</span> f.membercost <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>30</span>))
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> cost <span style=color:#66d9ef>DESC</span>;
</code></pre></div><p><strong>7 使用子查询生成一份昂贵的预订清单</strong></p><p>问题描述：</p><p>对于上一个问题，实现的有点啰嗦：我们必须在 WHERE 子句和 CASE 语句中两次计算预订成本。尝试使用子查询简化此计算。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> (m.firstname <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> surname) <span style=color:#66d9ef>AS</span> member,
          f.name <span style=color:#66d9ef>AS</span> facility,
          (<span style=color:#66d9ef>CASE</span>
            <span style=color:#66d9ef>WHEN</span> b.memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
            <span style=color:#66d9ef>THEN</span> b.slots <span style=color:#f92672>*</span> f.guestcost
            <span style=color:#66d9ef>ELSE</span> b.slots <span style=color:#f92672>*</span> f.membercost
          <span style=color:#66d9ef>END</span>) <span style=color:#66d9ef>AS</span> cost
      <span style=color:#66d9ef>FROM</span> cd.bookings b,
        cd.members m,
        cd.facilities f
      <span style=color:#66d9ef>WHERE</span> b.memid <span style=color:#f92672>=</span> m.memid
      <span style=color:#66d9ef>AND</span> b.facid <span style=color:#f92672>=</span> f.facid
      <span style=color:#66d9ef>AND</span> date(b.starttime) s <span style=color:#e6db74>&#39;2012-09-14&#39;</span>) <span style=color:#66d9ef>AS</span> t
<span style=color:#66d9ef>WHERE</span> t.cost <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>30</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> t.cost <span style=color:#66d9ef>DESC</span>;
</code></pre></div><p><strong>8 不使用连接生成所有成员及其推荐人列表</strong></p><p>问题描述：</p><p>不使用任何连接的情况下输出所有成员的列表，包括其推荐人（如果有的话）。确保列表中没有重复项，且名字姓氏对被格式化为一列并有序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> (m.firstname <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> m.surname) <span style=color:#66d9ef>AS</span> member,
  (<span style=color:#66d9ef>SELECT</span> (firstname <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> surname) <span style=color:#66d9ef>AS</span> recommender
    <span style=color:#66d9ef>FROM</span> cd.members
    <span style=color:#66d9ef>WHERE</span> memid <span style=color:#f92672>=</span> m.recommendedby)
<span style=color:#66d9ef>FROM</span> cd.members m
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> member;
</code></pre></div><h3 id=3-数据修改>3 数据修改</h3><p>本栏目涉及插入、更新和删除。像这样更改数据的操作统称为 DML（数据操作语言）。</p><p><strong>1 单行插入</strong></p><p>问题描述：</p><p>俱乐部正在增加一个新设施——SPA。我们需要将它添加到设施表中。值如下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>facid: 9, name: &#39;Spa&#39;, membercost: 20, guestcost: 30, initialoutlay: 100000, monthlymaintenance: 800
</code></pre></div><p>问题答案：</p><p>可以显示指定列名，也可以省略列名  按建表字段顺序插入。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> cd.facilities (facid, name, membercost, guestcost, initialoutlay, monthlymaintenance)
    <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>9</span>, <span style=color:#e6db74>&#39;Spa&#39;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>100000</span>, <span style=color:#ae81ff>800</span>);

<span style=color:#75715e>-- 按照建表字段顺序插入
</span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> cd.facilities <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>9</span>, <span style=color:#e6db74>&#39;Spa&#39;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>100000</span>, <span style=color:#ae81ff>800</span>);
</code></pre></div><p><strong>2 多行插入</strong></p><p>问题描述：</p><p>使用一行命令一次加入多个设备。值如下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>facid: 9, name: &#39;Spa&#39;, membercost: 20, guestcost: 30, initialoutlay: 100000, monthlymaintenance: 800
facid: 10, name: &#39;Squash Court 2&#39;, membercost: 3.5, guestcost: 17.5, initialoutlay: 5000, monthlymaintenance: 80
</code></pre></div><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> cd.facilities (facid, name, membercost, guestcost, initialoutlay, monthlymaintenance)
    <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>9</span>, <span style=color:#e6db74>&#39;Spa&#39;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>100000</span>, <span style=color:#ae81ff>800</span>),
           (<span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#39;Squash Court 2&#39;</span>, <span style=color:#ae81ff>3</span>.<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>17</span>.<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5000</span>, <span style=color:#ae81ff>80</span>);
</code></pre></div><p><strong>3 计算后的数据插入</strong></p><p>问题描述：</p><p>这一次不再指定设备 ID，而是自动计算下一个 facid 值。其它字段值如下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>name: &#39;Spa&#39;, membercost: 20, guestcost: 30, initialoutlay: 100000, monthlymaintenance: 800.
</code></pre></div><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> cd.facilities (facid, name, membercost, guestcost, initialoutlay, monthlymaintenance)
    <span style=color:#66d9ef>SELECT</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>max</span>(facid)<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>FROM</span> cd.facilities), <span style=color:#e6db74>&#39;Spa&#39;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>100000</span>, <span style=color:#ae81ff>800</span>;
</code></pre></div><p><strong>4 根据现有内容作更新</strong></p><p>问题描述：</p><p>我们想改变第二个网球场的价格，使其比第一个网球场贵 10%。尝试在不指定常量值的情况下执行此操作，以便我们可以根据需要重用该语句。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>UPDATE</span> cd.facilities
<span style=color:#66d9ef>SET</span> membercost <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> membercost, guestcost <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> guestcost
<span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Tennis Court 2&#39;</span>;
</code></pre></div><p><strong>5 根据子查询作删除</strong></p><p>问题描述：</p><p>删除所有从未预定过设施的成员。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>WHERE</span> memid
  <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (
    <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> memid
    <span style=color:#66d9ef>FROM</span> cd.bookings);

<span style=color:#75715e>-- 另一种实现是使用相关子查询
</span><span style=color:#75715e></span><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> cd.members m
<span style=color:#66d9ef>WHERE</span>
  <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> (
    <span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>1</span>
    <span style=color:#66d9ef>FROM</span> cd.bookings
    <span style=color:#66d9ef>WHERE</span> memid <span style=color:#f92672>=</span> m.memid);
</code></pre></div><h3 id=4-聚合>4 聚合</h3><p>聚合是一个让人能真正体会到关系型数据库强大能力的功能。该栏目深度覆盖聚合，使用标准分组以及最新的窗口函数来测试我们的掌握情况。</p><p><strong>1 计算各成员的推荐数</strong></p><p>问题描述：</p><p>生成各成员的推荐数列表，以成员 ID 排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> recommendedby, <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>WHERE</span> recommendedby <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> ecommendedby
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> recommendedby;
</code></pre></div><p><strong>2 列出每个设施的预订总段数</strong></p><p>问题描述：</p><p>生成每个设施的预订总段数。输出设施 ID 和预定总段数，按设施 ID 排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> facid, <span style=color:#66d9ef>sum</span>(slots)
<span style=color:#66d9ef>FROM</span> cd.bookings
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> facid
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> facid;
</code></pre></div><p><strong>3 列出给定月份每个设施的预订总段数</strong></p><p>问题描述：</p><p>生成 2012 年 9 月每个设施的预订总段数。输出设施 ID 和预定总段数，按总段数排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> facid, <span style=color:#66d9ef>sum</span>(slots) <span style=color:#66d9ef>AS</span> totalslots
<span style=color:#66d9ef>FROM</span> cd.bookings
<span style=color:#66d9ef>WHERE</span> starttime <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;2012-09-01&#39;</span>
  <span style=color:#66d9ef>AND</span> starttime <span style=color:#f92672>&lt;</span> <span style=color:#e6db74>&#39;2012-10-01&#39;</span>
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> facid
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> totalslots;
</code></pre></div><p><strong>4 列出每个设施每月的预订总段数</strong></p><p>问题描述：</p><p>生成 2012 年每个设施每月的预订总段数。输出设施 ID 和预定总段数，按设施 ID 和月份排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> facid,
  <span style=color:#66d9ef>extract</span>(<span style=color:#66d9ef>month</span> <span style=color:#66d9ef>from</span> starttime) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>month</span>,
  <span style=color:#66d9ef>sum</span>(slots)
<span style=color:#66d9ef>FROM</span> cd.bookings
<span style=color:#66d9ef>WHERE</span> starttime <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;2012-01-01&#39;</span>
  <span style=color:#66d9ef>AND</span> starttime <span style=color:#f92672>&lt;</span> <span style=color:#e6db74>&#39;2013-01-01&#39;</span>
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> facid, <span style=color:#66d9ef>month</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> facid, <span style=color:#66d9ef>month</span>;
</code></pre></div><p><strong>5 列出预订已超过 1000 个段的设施</strong></p><p>问题描述：</p><p>生成预订已超过 1000 个段的设施列表。输出设施 ID 和预定总段数，按设施 ID 排序。</p><p>问题答案：</p><p>使用<code>HAVING</code>来过滤聚合后的结果。<code>WHERE</code>用于聚合前的数据筛选，而<code>HAVING</code>用于聚合后的数据筛选，这即是两者的区别。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> facid, <span style=color:#66d9ef>sum</span>(slots)
<span style=color:#66d9ef>FROM</span> cd.bookings
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> facid
<span style=color:#66d9ef>HAVING</span> <span style=color:#66d9ef>sum</span>(slots) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1000</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> facid;
</code></pre></div><p><strong>6 列出每个设施的总收入</strong></p><p>问题描述：</p><p>列出每个设施的总收入。输出应包括设施名和总收入，按总收入排序。记住，游客和会员的计费是不同的。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> f.name,
    <span style=color:#66d9ef>sum</span>(<span style=color:#66d9ef>CASE</span>
          <span style=color:#66d9ef>WHEN</span> b.memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
          <span style=color:#66d9ef>THEN</span> b.slots <span style=color:#f92672>*</span> f.guestcost
          <span style=color:#66d9ef>ELSE</span> b.slots <span style=color:#f92672>*</span> f.membercost
        <span style=color:#66d9ef>END</span>) <span style=color:#66d9ef>AS</span> revenue
<span style=color:#66d9ef>FROM</span> cd.bookings b, cd.facilities f
<span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> f.name
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> revenue;
</code></pre></div><p><strong>7 列出总收入低于 1000 的设施</strong></p><p>问题描述：</p><p>列出总收入小于 1000 的设施列表。输出包括设施名称和总收入，按收入排序。记住，游客和会员的计费是不同的。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> f.name,
        <span style=color:#66d9ef>sum</span>(<span style=color:#66d9ef>CASE</span>
              <span style=color:#66d9ef>WHEN</span> b.memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
              <span style=color:#66d9ef>THEN</span> b.slots <span style=color:#f92672>*</span> f.guestcost
              <span style=color:#66d9ef>ELSE</span> b.slots <span style=color:#f92672>*</span> f.membercost
            <span style=color:#66d9ef>END</span>) <span style=color:#66d9ef>AS</span> revenue
      <span style=color:#66d9ef>FROM</span> cd.bookings b, cd.facilities f
      <span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
      <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> f.name) <span style=color:#66d9ef>AS</span> t
<span style=color:#66d9ef>WHERE</span> t.revenue <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1000</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> revenue;
</code></pre></div><p>注意如下写法是错误的：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> f.name,
  <span style=color:#66d9ef>sum</span>(
    <span style=color:#66d9ef>CASE</span>
      <span style=color:#66d9ef>WHEN</span> b.memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
      <span style=color:#66d9ef>THEN</span> b.slots <span style=color:#f92672>*</span> f.guestcost
      <span style=color:#66d9ef>ELSE</span> b.slots <span style=color:#f92672>*</span> f.membercost
    <span style=color:#66d9ef>END</span>) <span style=color:#66d9ef>AS</span> revenue
<span style=color:#66d9ef>FROM</span> cd.bookings b, cd.facilities f
<span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> f.name
<span style=color:#66d9ef>HAVING</span> revenue <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1000</span> <span style=color:#75715e>-- PostgreSQL不允许在HAVING中直接使用列名
</span><span style=color:#75715e></span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> revenue;
</code></pre></div><p><strong>8 输出预订段数最多的设施 ID</strong></p><p>问题描述：</p><p>输出预订段数最多的设施 ID。尝试不使用<code>LIMIT</code>来实现（看起来可能会乱一点）。</p><p>问题答案：</p><p>第一种写法，看起来笨一些。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> facid, <span style=color:#66d9ef>sum</span>(slots)
<span style=color:#66d9ef>FROM</span> cd.bookings
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> facid
<span style=color:#66d9ef>HAVING</span> <span style=color:#66d9ef>sum</span>(slots) <span style=color:#f92672>=</span> (
  <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>max</span>(totalslots)
  <span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> facid, <span style=color:#66d9ef>sum</span>(slots) <span style=color:#66d9ef>AS</span> totalslots
        <span style=color:#66d9ef>FROM</span> cd.bookings
        <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> facid) <span style=color:#66d9ef>AS</span> t);
</code></pre></div><p>第二种写法，使用<code>WITH</code>表达式提取出公用部分，更紧凑。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>WITH</span> t <span style=color:#66d9ef>AS</span> (
    <span style=color:#66d9ef>SELECT</span> facid, <span style=color:#66d9ef>sum</span>(slots) <span style=color:#66d9ef>AS</span> totalslots
    <span style=color:#66d9ef>FROM</span> cd.bookings
    <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> facid)

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> t
<span style=color:#66d9ef>WHERE</span> totalslots <span style=color:#f92672>=</span> (
    <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>max</span>(totalslots)
    <span style=color:#66d9ef>FROM</span> t);
</code></pre></div><p><strong>9 输出每个设施的预订总小时数</strong></p><p>问题描述：</p><p>输出每个设施的预订总小时数，注意一个时段为半小时。输出应包含设施 ID、设施名称和预订小时数，按设施 ID 排序。尝试将小时数格式化为两位小数。</p><p>问题答案：</p><p>PostgreSQL 默认是整除的，若需采用浮点除法，需要显式指定一下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> b.facid, f.name,
  round(<span style=color:#66d9ef>sum</span>(b.slots)::numeric<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>::numeric, <span style=color:#ae81ff>2</span>)
<span style=color:#66d9ef>FROM</span> cd.bookings b, cd.facilities f
<span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> b.facid, f.name
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> b.facid;
</code></pre></div><p><strong>10 列出每位会员在 2012 年 9 月 1 日之后的首次预订</strong></p><p>问题描述：</p><p>列出每位会员的姓名、ID 和他们在 2012 年 9 月 1 日之后的第一次设施预订时间。按会员 ID 排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> m.surname,
  m.firstname,
  b.memid,
  <span style=color:#66d9ef>min</span>(b.starttime)
<span style=color:#66d9ef>FROM</span> cd.bookings b, cd.members m
<span style=color:#66d9ef>WHERE</span> b.memid <span style=color:#f92672>=</span> m.memid
  <span style=color:#66d9ef>AND</span> b.starttime <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;2012-09-01&#39;</span>
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> m.surname,
  m.firstname,
  b.memid
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> b.memid;
</code></pre></div><p><strong>11 生成会员名称列表，每行包含会员总数</strong></p><p>问题描述：</p><p>生成会员（包括游客）名称列表，每行包含会员总数。按加入日期排序。</p><p>问题答案：</p><p>使用窗口函数实现。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>) over (),
  firstname,
  surname
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> joindate;
</code></pre></div><p><strong>12 生成一份带编号的会员名单</strong></p><p>问题描述：</p><p>生成一份会员（包括游客）的单调递增编号列表，按加入日期排序。注意，不保证会员 ID 是连续的。</p><p>问题答案：</p><p>使用窗口函数实现。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> row_number() OVER (<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> joindate),
  firstname,
  surname
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> joindate;
</code></pre></div><p><strong>13 查找前三大创收设施</strong></p><p>问题描述：</p><p>列出前三个创收设施（包含排名相同的）。输出设施名称和排名，按排名和设施名称排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span>
        f.name,
        rank() OVER (<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>sum</span>(
            <span style=color:#66d9ef>CASE</span>
                <span style=color:#66d9ef>WHEN</span> b.memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
                <span style=color:#66d9ef>THEN</span> b.slots <span style=color:#f92672>*</span> f.guestcost
                <span style=color:#66d9ef>ELSE</span> b.slots <span style=color:#f92672>*</span> f.membercost
            <span style=color:#66d9ef>END</span>) <span style=color:#66d9ef>DESC</span>) <span style=color:#66d9ef>AS</span> rank
      <span style=color:#66d9ef>FROM</span> cd.bookings b, cd.facilities f
      <span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
      <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> f.name) <span style=color:#66d9ef>AS</span> t
<span style=color:#66d9ef>WHERE</span> t.rank <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>;
</code></pre></div><p><strong>14 按营收额对设施进行分类</strong></p><p>问题描述：</p><p>根据营收额将设施等分为高、中和低三类。按分类和设施名称排序。</p><p>问题答案：</p><p>主要考察<code>ntile</code>窗口函数的使用，其会将值尽可能的等分为指定的分组数。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> name, (
    <span style=color:#66d9ef>CASE</span>
      <span style=color:#66d9ef>WHEN</span> <span style=color:#66d9ef>class</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
      <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;high&#39;</span>
      <span style=color:#66d9ef>WHEN</span> <span style=color:#66d9ef>class</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
      <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;average&#39;</span>
      <span style=color:#66d9ef>ELSE</span> <span style=color:#e6db74>&#39;low&#39;</span>
    <span style=color:#66d9ef>END</span>) <span style=color:#66d9ef>AS</span> revenue
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> f.name,
        ntile(<span style=color:#ae81ff>3</span>) over(<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>sum</span>(
          <span style=color:#66d9ef>CASE</span>
            <span style=color:#66d9ef>WHEN</span> b.memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
            <span style=color:#66d9ef>THEN</span> b.slots <span style=color:#f92672>*</span> f.guestcost
            <span style=color:#66d9ef>ELSE</span> b.slots <span style=color:#f92672>*</span> f.membercost
          <span style=color:#66d9ef>END</span>) <span style=color:#66d9ef>DESC</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>class</span>
      <span style=color:#66d9ef>FROM</span> cd.bookings b, cd.facilities f
      <span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
      <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> f.name) <span style=color:#66d9ef>AS</span> t
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>class</span>, name;
</code></pre></div><h3 id=5-日期处理>5 日期处理</h3><p>本栏目涉及日期处理，详情请参阅<a href=https://www.postgresql.org/docs/current/functions-datetime.html>PostgreSQL 日期时间函数文档</a>。</p><p><strong>1 生成 2012 年 8 月 31 日凌晨 1 点的时间戳</strong></p><p>问题描述：</p><p>生成 2012 年 8 月 31 日凌晨 1 点这个时间的时间戳。</p><p>问题答案：</p><p>有三种写法，前两种是 PostgreSQL 的语法，最后一种是 SQL 标准语法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- 第一种写法
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-08-31 01:00:00&#39;</span>;

<span style=color:#75715e>-- 第二种写法
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;2012-08-31 01:00:00&#39;</span>::<span style=color:#66d9ef>TIMESTAMP</span>;

<span style=color:#75715e>-- 第三种写法
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>CAST</span>(<span style=color:#e6db74>&#39;2012-08-31 01:00:00&#39;</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>TIMESTAMP</span>);
</code></pre></div><p><strong>2 时间戳相减</strong></p><p>问题描述：</p><p>计算时间戳<code>2012-08-31 01:00:00</code>减去时间戳<code>2012-07-30 01:00:00</code>的结果。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-08-31 01:00:00&#39;</span> <span style=color:#f92672>-</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-07-30 01:00:00&#39;</span>;
</code></pre></div><p><strong>3 生成 2012 年 10 月的所有日期</strong></p><p>问题描述：</p><p>生成 2012 年 10 月的所有日期。可以输出为时间戳（时间部分为<code>00:00:00</code>）或日期。</p><p>问题答案：</p><p>使用 PostgreSQL 的<code>generate_series</code>函数来生成时间序列。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> generate_series(<span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-10-01&#39;</span>, <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-10-31&#39;</span>, INTERVAL <span style=color:#e6db74>&#39;1 day&#39;</span>);
</code></pre></div><p><strong>4 从时间戳获取其属于月份中的哪一天</strong></p><p>问题描述：</p><p>从时间戳<code>2012-08-31</code>中获取其属于月份中的第几天。</p><p>问题答案：</p><p>使用<code>date_part</code>或<code>extract</code>函数实现。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- 写法一
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> date_part(<span style=color:#e6db74>&#39;day&#39;</span>, <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-08-31&#39;</span>);

<span style=color:#75715e>-- 写法二
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>extract</span>(<span style=color:#66d9ef>day</span> <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-08-31&#39;</span>);
</code></pre></div><p><strong>5 计算时间戳之间的秒数</strong></p><p>问题描述：</p><p>计算时间戳<code>2012-08-31 01:00:00</code>和<code>2012-09-02 00:00:00</code>之间的秒数。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- 手动实现方式
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>extract</span>(<span style=color:#66d9ef>day</span> <span style=color:#66d9ef>FROM</span> t.int) <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>
  <span style=color:#f92672>+</span> <span style=color:#66d9ef>extract</span>(hour <span style=color:#66d9ef>FROM</span> t.int) <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>
  <span style=color:#f92672>+</span> <span style=color:#66d9ef>extract</span>(<span style=color:#66d9ef>minute</span> <span style=color:#66d9ef>FROM</span> t.int) <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>
  <span style=color:#f92672>+</span> <span style=color:#66d9ef>extract</span>(<span style=color:#66d9ef>second</span> <span style=color:#66d9ef>FROM</span> t.int)
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> age(<span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-09-02 00:00:00&#39;</span>, <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-08-31 01:00:00&#39;</span>) <span style=color:#66d9ef>AS</span> int) <span style=color:#66d9ef>AS</span> t;

<span style=color:#75715e>-- 使用PostgreSQL函数
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>extract</span>(epoch <span style=color:#66d9ef>FROM</span> age(<span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-09-02 00:00:00&#39;</span>, <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-08-31 01:00:00&#39;</span>));
</code></pre></div><p><strong>6 输出 2012 年每个月的天数</strong></p><p>问题描述：</p><p>输出 2012 年的每个月及该月的天数。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>extract</span>(<span style=color:#66d9ef>month</span> <span style=color:#66d9ef>FROM</span> t.<span style=color:#66d9ef>month</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>month</span>,
  (t.<span style=color:#66d9ef>month</span> <span style=color:#f92672>+</span> INTERVAL <span style=color:#e6db74>&#39;1 month&#39;</span>) <span style=color:#f92672>-</span> t.<span style=color:#66d9ef>month</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>length</span>
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> generate_series(DATE <span style=color:#e6db74>&#39;2012-01-01&#39;</span>, DATE <span style=color:#e6db74>&#39;2012-12-31&#39;</span>, interval <span style=color:#e6db74>&#39;1 month&#39;</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>month</span>) <span style=color:#66d9ef>AS</span> t;
</code></pre></div><p><strong>7 计算给定月的剩余天数</strong></p><p>问题描述：</p><p>给定时间戳<code>2012-02-11 01:00:00</code>，计算其对应月的剩余天数（不论给定的时间戳是几点，都应算作剩余的一整天）。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> date_trunc(<span style=color:#e6db74>&#39;month&#39;</span>, t.ts) <span style=color:#f92672>+</span> INTERVAL <span style=color:#e6db74>&#39;1 month&#39;</span> <span style=color:#f92672>-</span> date_trunc(<span style=color:#e6db74>&#39;day&#39;</span>, t.ts)
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#e6db74>&#39;2012-02-11 01:00:00&#39;</span> <span style=color:#66d9ef>AS</span> ts) <span style=color:#66d9ef>AS</span> t;
</code></pre></div><p><strong>8 计算预订的结束时间</strong></p><p>问题描述：</p><p>在系统中返回最近 10 个预订的开始和结束时间，先按结束时间排序，然后按开始时间排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> starttime,
  starttime <span style=color:#f92672>+</span> slots <span style=color:#f92672>*</span> (interval <span style=color:#e6db74>&#39;0.5 hour&#39;</span>) <span style=color:#66d9ef>AS</span> endtime
<span style=color:#66d9ef>FROM</span> cd.bookings
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> endtime <span style=color:#66d9ef>DESC</span>,
  starttime <span style=color:#66d9ef>DESC</span>
<span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>;
</code></pre></div><p><strong>9 返回每个月的预订数</strong></p><p>问题描述：</p><p>返回每个月的预订数，结果按月排序。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> date_trunc(<span style=color:#e6db74>&#39;month&#39;</span>, starttime) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>month</span>,
  <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)
<span style=color:#66d9ef>FROM</span> cd.bookings
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>month</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>month</span>;
</code></pre></div><p><strong>10 按月计算每个设施的利用率</strong></p><p>问题描述：</p><p>按月计算每个设施的利用率，按名称和月份排序，四舍五入到小数点后一位。开门时间是早上 8 点，关门时间是晚上 8:30。您可以将每个月视为整月，无论俱乐部是否有某些日期未开放。</p><p>问题答案：</p><p>每天开门的时间是<code>12.5 * 2</code>个半小时，所以每个设备当月的预定总段数除以这个数就是当月的利用率。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span>
    name,
    <span style=color:#66d9ef>month</span>,
    round((totalslots <span style=color:#f92672>/</span> (<span style=color:#66d9ef>extract</span>(<span style=color:#66d9ef>day</span> <span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>month</span> <span style=color:#f92672>+</span> interval <span style=color:#e6db74>&#39;1 month&#39;</span>) <span style=color:#f92672>-</span> <span style=color:#66d9ef>month</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>12</span>.<span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)::NUMERIC, <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>AS</span> utilization
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span>
        f.name,
        date_trunc(<span style=color:#e6db74>&#39;month&#39;</span>, b.starttime) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>month</span>,
        <span style=color:#66d9ef>sum</span>(b.slots) <span style=color:#66d9ef>AS</span> totalslots
      <span style=color:#66d9ef>FROM</span> cd.bookings b, cd.facilities f
      <span style=color:#66d9ef>WHERE</span> b.facid <span style=color:#f92672>=</span> f.facid
      <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> f.name, <span style=color:#66d9ef>MONTH</span>) <span style=color:#66d9ef>AS</span> t
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> name, <span style=color:#66d9ef>month</span>;
</code></pre></div><h3 id=6-字符串操作>6 字符串操作</h3><p>本栏目涉及基础字符串操作，<code>LIKE</code>使用，正则表达式使用。详情请参阅<a href=https://www.postgresql.org/docs/current/functions-matching.html>PostgreSQL 正则匹配文档</a>。</p><p><strong>1 格式化会员名称</strong></p><p>问题描述：</p><p>输出所有会员的名字，格式为<code>Surname, Firstname</code>。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> surname <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;, &#39;</span> <span style=color:#f92672>||</span> firstname
<span style=color:#66d9ef>FROM</span> cd.members;
</code></pre></div><p><strong>2 按名称前缀查找设施</strong></p><p>问题描述：</p><p>查找名称以<code>Tennis</code>开头的所有设施。输出所有列。</p><p>问题答案：</p><p><code>LIKE</code>中<code>%</code>用于匹配任何字符串，而<code>_</code>用于匹配任何单个字符。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> cd.facilities
<span style=color:#66d9ef>WHERE</span> name <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;Tennis%&#39;</span>;
</code></pre></div><p><strong>3 执行不区分大小写的搜索</strong></p><p>问题描述：</p><p>不区分大小写以查找名称以<code>tennis</code>开头的所有设施。输出所有列。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- SQL标准写法
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> cd.facilities
<span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>LOWER</span>(name) <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;tennis%&#39;</span>;

<span style=color:#75715e>-- PostgreSQL独有，使用ILIKE
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> cd.facilities
<span style=color:#66d9ef>WHERE</span> name <span style=color:#66d9ef>ILIKE</span> <span style=color:#e6db74>&#39;tennis%&#39;</span>;
</code></pre></div><p><strong>4 查找带括号的电话号码</strong></p><p>问题描述：</p><p>您可能已经注意到俱乐部的会员表中的电话号码格式很不一致。查找所有包含括号的电话号码，返回会员 ID 和电话号码，按会员 ID 排序。</p><p>问题答案：</p><p>PostgreSQL 有三种字符串匹配方法：<code>LIKE</code>，<code>SIMILAR TO</code>，及 POSIX 正则表达式。</p><p><code>SIMILAR TO</code>与<code>LIKE</code>类似，只是其采用 SQL 正则表达式，是一种 LIKE 与 POSIX 正则表达式的结合体。<code>SIMILAR TO</code>不像常规正则表达式一样可以匹配子字符串，其与<code>LIKE</code>一样，想匹配成成功，必须匹配整个字符串。<code>SIMILAR TO</code>与<code>LIKE</code>一样，分别使用<code>_</code>及<code>%</code>表示任意单个字符及任意字符串，而<code>.</code>在<code>SIMILAR TO</code>中不表示任意单个字符。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- 使用LIKE
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> memid, telephone
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>WHERE</span> telephone <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;(%)%&#39;</span>;

<span style=color:#75715e>-- ~~与LIKE等价
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> memid, telephone
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>WHERE</span> telephone <span style=color:#f92672>~~</span> <span style=color:#e6db74>&#39;(%)%&#39;</span>;

<span style=color:#75715e>-- 使用SIMILAR TO
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> memid, telephone
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>WHERE</span> telephone <span style=color:#66d9ef>SIMILAR</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#39;\(%\)%&#39;</span>;

<span style=color:#75715e>-- 采用POSIX正则表达式
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> memid, telephone
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>WHERE</span> telephone <span style=color:#f92672>~</span> <span style=color:#e6db74>&#39;^\(\d*\)\s\d{3}-\d{4}$&#39;</span>;
</code></pre></div><p><strong>5 用前导零填充邮政编码</strong></p><p>问题描述：</p><p>由于存储时<code>zipcode</code>为数值类型，我们示例数据集中的邮政编码已经从它们中删除了前导零。从成员表中检索所有邮政编码，用前导零填充任何少于 5 个字符的邮政编码。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- 使用lpad函数
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> lpad(<span style=color:#66d9ef>cast</span>(zipcode <span style=color:#66d9ef>as</span> char(<span style=color:#ae81ff>5</span>)), <span style=color:#ae81ff>5</span>, <span style=color:#e6db74>&#39;0&#39;</span>)
<span style=color:#66d9ef>FROM</span> cd.members;

<span style=color:#75715e>-- 使用tochar
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> to_char(zipcode, <span style=color:#e6db74>&#39;FM09999&#39;</span>)
<span style=color:#66d9ef>FROM</span> cd.members;
</code></pre></div><p><strong>6 计算姓氏以每个字母开头的会员数量</strong></p><p>问题描述：</p><p>计算会员姓氏分别以各字母开头的数量。按字母排序，如果计数为 0，就不要打印这个字母。</p><p>问题答案：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- 使用substr
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span>
  substr(surname, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>AS</span> firstletter,
  <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> firstletter
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> firstletter;

<span style=color:#75715e>-- 使用left
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span>
  <span style=color:#66d9ef>left</span>(surname, <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>AS</span> firstletter,
  <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> firstletter
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> firstletter;

<span style=color:#75715e>-- 使用substring
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span>
  <span style=color:#66d9ef>substring</span>(surname <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#39;#&#34;_#&#34;%&#39;</span> <span style=color:#66d9ef>FOR</span> <span style=color:#e6db74>&#39;#&#39;</span>) <span style=color:#66d9ef>AS</span> firstletter,
  <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> firstletter
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> firstletter;
</code></pre></div><p><strong>7 清理电话号码</strong></p><p>问题描述：</p><p>数据库中的电话号码格式非常不一致。您想打印会员 ID 和删除'-'、'('、')'，及' &lsquo;字符后的号码。按会员 ID 排序。</p><p>问题答案：</p><p>使用 regexp_replace 函数实现。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span>
  memid,
  regexp_replace(telephone, <span style=color:#e6db74>&#39;[\s\-\(\)]&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#e6db74>&#39;g&#39;</span>)
<span style=color:#66d9ef>FROM</span> cd.members
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> memid;
</code></pre></div><h3 id=7-递归查询>7 递归查询</h3><p>本栏目涉及递归查询。在 PostgreSQL，可以使用<code>WITH RECURSIVE</code>进行递归查询。这对处理树和图结构数据非常实用。详情请参阅<a href=https://www.postgresql.org/docs/current/queries-with.html>WITH Queries</a>。</p><p><strong>1 追溯会员的上游推荐链</strong></p><p>问题描述：</p><p>寻找会员 ID 为 27 的上游推荐链：即寻找会员 ID 为 27 的推荐人，会员 ID 为 27 的推荐人的推荐人，以此类推。返回会员 ID、名字和姓氏。</p><p>问题答案：</p><p>使用<code>WITH RECURSIVE</code>表达式实现。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> recommenders(id) <span style=color:#66d9ef>AS</span> (
  <span style=color:#66d9ef>SELECT</span> recommendedby <span style=color:#66d9ef>FROM</span> cd.members <span style=color:#66d9ef>WHERE</span> memid <span style=color:#f92672>=</span> <span style=color:#ae81ff>27</span>
  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
  <span style=color:#66d9ef>SELECT</span> recommendedby
  <span style=color:#66d9ef>FROM</span> cd.members m, recommenders r
  <span style=color:#66d9ef>WHERE</span> m.memid <span style=color:#f92672>=</span> r.id
)

<span style=color:#66d9ef>SELECT</span> r.id, m.firstname, m.surname
<span style=color:#66d9ef>FROM</span> recommenders r, cd.members m
<span style=color:#66d9ef>WHERE</span> r.id <span style=color:#f92672>=</span> m.memid;
</code></pre></div><p><strong>2 追溯会员的下游推荐链</strong></p><p>问题描述：</p><p>寻找会员 ID 为 1 的下游推荐链：即寻找 ID 为 1 的会员推荐了哪些人，ID 为 1 的会员推荐的这些人又推荐了哪些人，以此类推。返回会员 ID、名字和姓氏，按会员 ID 排序。</p><p>问题答案：</p><p>使用<code>WITH RECURSIVE</code>表达式实现。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>RECURSIVE</span> recommendeds(id) <span style=color:#66d9ef>AS</span> (
  <span style=color:#66d9ef>SELECT</span> memid <span style=color:#66d9ef>FROM</span> cd.members <span style=color:#66d9ef>WHERE</span> recommendedby <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>UNION</span> <span style=color:#66d9ef>ALL</span>
  <span style=color:#66d9ef>SELECT</span> m.memid
  <span style=color:#66d9ef>FROM</span> cd.members m, recommendeds r
  <span style=color:#66d9ef>WHERE</span> m.recommendedby <span style=color:#f92672>=</span> r.id
)

<span style=color:#66d9ef>SELECT</span> r.id, m.firstname, m.surname
<span style=color:#66d9ef>FROM</span> recommendeds r, cd.members m
<span style=color:#66d9ef>WHERE</span> r.id <span style=color:#f92672>=</span> m.memid
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> id;
</code></pre></div><blockquote><p>参考资料</p><p>[1]<a href=https://pgexercises.com/>postgresql exercises</a></p><p>[2]<a href=https://www.postgresql.org/docs/current/functions-datetime.html>postgresql date/time functions and operators</a></p><p>[3]<a href=https://www.postgresql.org/docs/current/functions-matching.html>postgresql pattern matching</a></p><p>[4]<a href=https://www.postgresql.org/docs/current/queries-with.html>postgresql with queries (common table expressions)</a></p></blockquote></div><div class=content-footer><div class=post-tags><a href=/tags/postgresql/>#PostgreSQL</a></div></div></div><div class="col-lg-8 mx-auto block shadow"><h3>相关文章</h3><ul><li><a href=/posts/postgres-getting-started.html>PostgreSQL 初探</a></li><li><a href=/posts/install-postgres-on-centos-from-source.html>在 CentOS 上以源码安装 PostgreSQL</a></li><li><a href=/posts/postgres-ddl.html>PostgreSQL 数据定义相关知识总结</a></li><li><a href=/posts/postgres-table-partitioning.html>PostgreSQL 表分区使用详解</a></li><li><a href=/posts/postgres-table-inheritance.html>PostgreSQL 表继承使用详解</a></li></ul></div><div class="col-lg-8 mx-auto block shadow"><div align=center><table><tr><b style=color:#e8505b>创作不易，如果我的文章确实帮助到了您，请我喝一杯饮料就是一种莫大的支持！<a href=/thanks>Thanks!</a></b></tr><tr><td align=center><b>微信</b></td><td></td><td></td><td></td><td></td><td align=center><b>支付宝</b></td></tr><tr><td><img src=/static/images/self/wechat.png style=width:120px;height:120px></td><td></td><td></td><td></td><td></td><td><img src=/static/images/self/alipay.png style=width:120px;height:120px></td></tr></table></div></div><script src=https://utteranc.es/client.js repo=olzhy/olzhy.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></section><footer class="py-4 bg-lights border-top"><div class=container><div class="row justify-content-between text-center align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/leetcode-golang-implementations>LeetCode</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/about>关于本站</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/links>友情链接</a></li></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a title=文章归档 href=/archives/><i class=ti-archive></i></a></li><li class=list-inline-item><a title=文章标签 href=/tags/><i class=ti-tag></i></a></li><li class=list-inline-item><a title="我的 GitHub" href=https://github.com/olzhy><i class=ti-github></i></a></li><li class=list-inline-item><a title="网站 RSS" href=/index.xml><i class=ti-rss></i></a></li></ul></div></div><div class="text-center mt-4"><span>Made with <a href=https://gohugo.io/>Hugo</a> | Theme <a href=https://github.com/themefisher/northendlab-hugo>NorthendLab</a> | <a href=https://beian.miit.gov.cn>辽ICP备2022012085号-1</a> | Copyright © 2017-2023</span></div></div></footer><script>var indexURL="https://olzhy.github.io/index.json"</script><script src=https://olzhy.github.io/js/jquery.min.js></script><script src=https://olzhy.github.io/js/bootstrap.min.js></script><script src=https://olzhy.github.io/js/fuse.min.js></script><script src=https://olzhy.github.io/js/mark.js></script><script src=https://olzhy.github.io/js/search.js></script><script src=https://olzhy.github.io/js/script.min.js></script></body></html>